# StarRocks Project Cursor Rules

## Project Overview
StarRocks is an open-source, high-performance analytical database system designed for real-time analytics. This is a large-scale C++/Java project with a complex build system.

## ‚ö†Ô∏è IMPORTANT BUILD SYSTEM WARNING
**DO NOT attempt to build or run unit tests (UT) for this project unless explicitly requested by the user.**
The build system is extremely resource-intensive and time-consuming. Building the full project can take hours and requires significant system resources.

## Code Organization

### Backend (be/)
**Language**: C++
**Purpose**: Core analytical engine and storage layer
- `be/src/exec/` - Query execution engine components
- `be/src/storage/` - Storage engine and data persistence
- `be/src/exprs/` - Expression evaluation and JIT compilation
- `be/src/formats/` - Data format parsers and serializers
- `be/src/runtime/` - Runtime components (batch write, stream load, memory management, etc.)
- `be/src/connector/` - External data source connectors
- `be/src/service/` - Core backend services
- `be/src/common/` - Common utilities and shared code

**üìã See `be/.cursorrules` for detailed backend component breakdown**

### Frontend (fe/)
**Language**: Java
**Purpose**: SQL parsing, query planning, and metadata management
- `fe/fe-core/` - Core frontend logic
- `fe/fe-spi/` - Service Provider Interface
- `fe/fe-parser/` & `fe/fe-grammar/` - SQL parsing
- `fe/fe-type/` - Type system
- `fe/spark-dpp/` - Spark data preprocessing

**üìã See `fe/.cursorrules` for detailed frontend component breakdown**

### Java Extensions (java-extensions/)
**Language**: Java
**Purpose**: External connectors (Hive, Iceberg, Hudi, Paimon, JDBC, etc.)
- `java-extensions/jni-connector/` - C++ to Java bridge
- `java-extensions/udf-extensions/` - UDF framework
- `java-extensions/common-runtime/` - Shared runtime

**üìã See `java-extensions/.cursorrules` for detailed extensions breakdown**

### Generated Sources (gensrc/)
**Purpose**: Auto-generated code from IDL definitions
- `gensrc/proto/` - Protocol buffer definitions
- `gensrc/thrift/` - Thrift interface definitions
- `gensrc/script/` - Code generation scripts

### Testing (test/)
**Language**: Python
**Purpose**: Integration and SQL testing framework (E2E)
- `test/sql/` - SQL test cases (T/R files)
- `test/common/` - Common test utilities
- `test/lib/` - Test libraries and helpers (e.g., `sr_sql_lib.py`)

## Documentation Guidelines

### When to update Documentation
- **New Feature**: When adding a new feature (e.g., a new SQL function, a new connector, or a new system variable), you **MUST** create or update the corresponding documentation.
- **Functional Change**: When modifying existing functionality that affects user behavior, the documentation **MUST** be updated to reflect the changes.
- **Multilingual Support**: Documentation should be updated in all three supported languages:
  - **English**: `docs/en/`
  - **Chinese**: `docs/zh/`
  - **Japanese**: `docs/ja/`

### Documentation Rules
- **Templates**: Follow the templates provided in `docs/en/sql-reference/` for SQL functions, commands, and configurations.
- **Images**: Place images in the `assets` folder and use relative paths.
- **Sidebars**: New pages must be added to `docs/docusaurus/sidebars.json`.
- **Formatting**:
  - Use `###` headings for setting names or parameters to improve searchability.
  - Always include a language identifier for code blocks (e.g., ````sql`).

## Testing Strategy

### When to write Unit Tests (UT)
- **Backend (C++)**: For testing specific classes, data structures (e.g., `Column`), or internal logic in isolation. Use `gtest` in `be/test/`.
- **Frontend (Java)**: For testing SQL parsing, semantic analysis, or optimizer rules. Use `JUnit`/`JMockit` in `fe-core/src/test/`.
- **Plan Tests**: Use `PlanTestBase` in `fe-core/src/test/java/com/starrocks/sql/plan/` to verify that the optimizer generates the expected query plans.

### When to write SQL Tests (End-to-End)
- **Location**: `test/sql/`
- **Purpose**: For verifying end-to-end SQL correctness, feature integration, or bug fixes reproducible via SQL.
- **Rule**: Every new feature or bug fix should ideally have a corresponding SQL test case.

### SQL Test Guidelines
- **T Files**: Statements only. Used to generate R files via `run.py -r`.
- **R Files**: Statements + Expected Results (wrapped in `-- result:` and `-- !result`).
- **Tags**: Use `@native` or `@cloud` to restrict tests to specific environments.
- **Cleanup**: Use `CLEANUP { ... } END CLEANUP` blocks for resource teardown.
- **Fuzzy Match**: Use `[REGEX]` for unstable outputs like IDs or timestamps.
- **Order**: Use `[ORDER]` if result order must be strictly verified.

### Tools and Utilities
- `tools/` - Diagnostic tools, benchmarks, and utilities
- `bin/` - Binary executables and scripts
- `conf/` - Configuration files and templates
- `build-support/` - Build system support files
- `docker/` - Docker build configurations
- `docs/` - Project documentation

### Third-party Dependencies
- `thirdparty/` - External dependencies and patches
- `licenses/` - License files for dependencies

### Other Important Directories
- `fs_brokers/` - File system broker implementations
- `webroot/` - Web UI static files
- `format-sdk/` - Format SDK for data interchange

## Development Guidelines

1. **No Building**: Avoid running build commands (`build.sh`, `make`, etc.) unless specifically requested
2. **No Unit Tests**: Do not execute unit test scripts (`run-be-ut.sh`, `run-fe-ut.sh`, etc.)
3. **Focus on Code Analysis**: Prioritize code reading, analysis, and small targeted changes
4. **Language Awareness**: 
   - Backend (be/) is C++ - focus on performance and memory management
   - Frontend (fe/) is Java - focus on SQL parsing and query planning
   - Tests are Python - focus on SQL correctness and integration testing
5. **Code Comments**: All code comments must be written in English for consistency and international collaboration

## Pull Request Guidelines

### PR Title Format
PR titles must include a prefix to categorize the change:

- **[BugFix]** - Bug fixes and error corrections
- **[Enhancement]** - Improvements to existing functionality
- **[Feature]** - New features and capabilities
- **[Refactor]** - Code refactoring without functional changes
- **[Test]** - Test-related changes
- **[Doc]** - Documentation updates
- **[Build]** - Build system and CI/CD changes
- **[Performance]** - Performance optimizations

**Examples:**
- `[BugFix] Fix memory leak in column batch processing`
- `[Feature] Add support for Apache Paimon connector`
- `[Enhancement] Improve query optimizer for materialized views`

### Commit Message Template
Follow this structured format for all commit messages:

```
[Category] Brief description (50 chars or less)

Detailed explanation of what this commit does and why.
Wrap lines at 72 characters.

- Key change 1
- Key change 2
- Key change 3

Fixes: #issue_number (if applicable)
Closes: #issue_number (if applicable)
```

**Categories:** BugFix, Enhancement, Feature, Refactor, Test, Doc, Build, Performance

**Example:**
```
[Feature] Add Apache Iceberg table format support

Implement Iceberg connector to enable querying Iceberg tables
directly from StarRocks. This includes metadata reading,
partition pruning, and schema evolution support.

- Add IcebergConnector and IcebergMetadata classes
- Implement partition and file pruning optimizations  
- Support for Iceberg v1 and v2 table formats
- Add comprehensive unit tests

Closes: #12345
```

## Common File Extensions
- `.cpp`, `.h`, `.cc` - C++ source and headers (backend)
- `.java` - Java source files (frontend and extensions)
- `.proto` - Protocol buffer definitions
- `.thrift` - Thrift interface definitions
- `.sql` - SQL test cases and queries
- `.py` - Python test scripts

## Build System Files to Avoid
- `build.sh` - Main build script (very resource intensive)
- `build-in-docker.sh` - Docker-based build
- `run-*-ut.sh` - Unit test runners
- `Makefile*` - Make build files
- `pom.xml` - Maven build files (for Java components)