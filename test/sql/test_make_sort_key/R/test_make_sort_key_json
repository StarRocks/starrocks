-- name: test_make_sort_key_json
CREATE DATABASE test_make_sort_key_json;
-- result:
-- !result
USE test_make_sort_key_json;
-- result:
-- !result
CREATE TABLE `json_test_table` (
  `id` int(11) NOT NULL COMMENT "",
  `json_data` json NOT NULL COMMENT "",
  `json_array` json NOT NULL COMMENT "",
  `json_nested` json NOT NULL COMMENT "",
  `sort_key` varbinary(1024) AS (
    make_sort_key(
      get_json_int(json_data, '$.age'),
      get_json_string(json_data, '$.name'),
      get_json_string(json_data, '$.city'),
      get_json_string(json_array, '$[0]'),
      get_json_double(json_nested, '$.user.profile.score')
    )
  ) COMMENT "Auto-generated sort key from extracted JSON fields"
) ENGINE=OLAP 
DISTRIBUTED BY HASH(sort_key) BUCKETS 1 
ORDER BY (sort_key)
PROPERTIES ( "replication_num" = "1");
-- result:
E: (1064, 'VARBINARY(1024) column can not be distribution column')
-- !result
INSERT INTO json_test_table (id, json_data, json_array, json_nested) VALUES
(1, parse_json('{"name": "Alice", "age": 25, "city": "New York"}'), 
     parse_json('["apple", "banana", "cherry"]'),
     parse_json('{"user": {"id": 101, "profile": {"verified": true, "score": 95.5}}}')),
(2, parse_json('{"name": "Bob", "age": 30, "city": "Los Angeles"}'), 
     parse_json('["orange", "grape"]'),
     parse_json('{"user": {"id": 102, "profile": {"verified": false, "score": 87.2}}}')),
(3, parse_json('{"name": "Charlie", "age": 28, "city": "Chicago"}'), 
     parse_json('["mango", "pineapple", "kiwi", "strawberry"]'),
     parse_json('{"user": {"id": 103, "profile": {"verified": true, "score": 92.8}}}')),
(4, parse_json('{"name": "Diana", "age": 22, "city": "Miami"}'), 
     parse_json('["pear"]'),
     parse_json('{"user": {"id": 104, "profile": {"verified": true, "score": 89.1}}}')),
(5, parse_json('{"name": "Eve", "age": 35, "city": "Seattle"}'), 
     parse_json('["blueberry", "raspberry", "blackberry"]'),
     parse_json('{"user": {"id": 105, "profile": {"verified": false, "score": 78.9}}}'));
-- result:
E: (1064, 'Getting analyzing error. Detail message: Table json_test_table is not found.')
-- !result
SELECT id, 
       json_data, 
       json_extract(json_data, '$.age') as age,
       json_extract(json_data, '$.name') as name,
       json_extract(json_data, '$.city') as city,
       json_extract(json_array, '$[0]') as first_fruit,
       json_extract(json_nested, '$.user.profile.score') as score,
       sort_key,
       length(sort_key) as sort_key_length
FROM json_test_table 
ORDER BY id;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT id, json_data, json_array
FROM json_test_table 
ORDER BY sort_key;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT id, 
       json_extract(json_data, '$.age') as age,
       json_extract(json_data, '$.name') as name,
       json_extract(json_data, '$.city') as city,
       json_extract(json_array, '$[0]') as first_fruit,
       json_extract(json_nested, '$.user.profile.score') as score,
       sort_key
FROM json_test_table 
ORDER BY sort_key;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT id, json_data, json_array
FROM json_test_table 
WHERE sort_key > (SELECT sort_key FROM json_test_table WHERE id = 2)
ORDER BY id;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT id, 
       json_extract(json_data, '$.age') as age,
       json_extract(json_data, '$.name') as name,
       json_extract(json_data, '$.city') as city,
       json_extract(json_array, '$[0]') as first_fruit,
       json_extract(json_nested, '$.user.profile.score') as score
FROM json_test_table 
ORDER BY sort_key;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
INSERT INTO json_test_table (id, json_data, json_array, json_nested) VALUES
(6, NULL, parse_json('["test"]'), parse_json('{"test": null}')),
(7, parse_json('{"age": 40}'), parse_json('[]'), parse_json('{"user": {"id": 106}}'));
-- result:
E: (1064, 'Getting analyzing error. Detail message: Table json_test_table is not found.')
-- !result
SELECT id, 
       json_data,
       json_extract(json_data, '$.age') as age,
       json_extract(json_data, '$.name') as name,
       json_extract(json_data, '$.city') as city,
       json_extract(json_array, '$[0]') as first_fruit,
       json_extract(json_nested, '$.user.profile.score') as score,
       sort_key
FROM json_test_table 
WHERE id IN (6, 7)
ORDER BY id;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT 
    count(*) as total_rows,
    count(sort_key) as rows_with_sort_keys,
    avg(length(sort_key)) as avg_sort_key_length
FROM json_test_table;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SHOW CREATE TABLE json_test_table;
-- result:
E: (1064, 'Getting analyzing error. Detail message: Table json_test_table is not found.')
-- !result
UPDATE json_test_table 
SET json_data = parse_json('{"name": "Alice Updated", "age": 26, "city": "New York"}')
WHERE id = 1;
-- result:
E: (1064, 'Getting analyzing error. Detail message: Table json_test_table is not found.')
-- !result
SELECT id, 
       json_data,
       json_extract(json_data, '$.age') as age,
       json_extract(json_data, '$.name') as name,
       json_extract(json_data, '$.city') as city,
       sort_key
FROM json_test_table 
WHERE id = 1;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
SELECT id, json_data, json_array
FROM json_test_table 
WHERE sort_key BETWEEN 
    (SELECT sort_key FROM json_test_table WHERE id = 4) AND 
    (SELECT sort_key FROM json_test_table WHERE id = 2)
ORDER BY sort_key;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_make_sort_key_json.json_test_table'.")
-- !result
DROP DATABASE test_make_sort_key_json;
-- result:
-- !result