-- name: test_async_write_parquet_file @sequential
shell: ossutil64 mkdir oss://${oss_bucket}/test_async_write_parquet_file/${uuid0}/ >/dev/null || echo "exit 0" >/dev/null
-- result:
0

-- !result
admin enable failpoint 'async_flush_output_stream_sleep';
-- result:
-- !result
insert into files
(
    "path" = "oss://${oss_bucket}/test_async_write_parquet_file/${uuid0}/000/",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}"
)
select repeat(cast(generate_series as string), 100) from table(generate_series(0,50000));
-- result:
-- !result
admin disable failpoint 'async_flush_output_stream_sleep';
-- result:
-- !result
select count(*) from files(
    "path" = "oss://${oss_bucket}/test_async_write_parquet_file/${uuid0}/000/*",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}"
);
-- result:
50001
-- !result
shell: ossutil64 rm -rf oss://${oss_bucket}/test_async_write_parquet_file/${uuid0}/ >/dev/null || echo "exit 0" >/dev/null
-- result:
0

-- !result