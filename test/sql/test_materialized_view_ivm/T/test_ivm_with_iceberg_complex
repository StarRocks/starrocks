-- name: test_ivm_with_iceberg_complex
create external catalog mv_iceberg_${uuid0}
properties
(
    "type" = "iceberg",
    "iceberg.catalog.type" = "hive",
    "hive.metastore.uris" = "${iceberg_catalog_hive_metastore_uris}"
);
set catalog mv_iceberg_${uuid0};
create database mv_ice_db_${uuid0};
use mv_ice_db_${uuid0};

create table t1 (
  col1 string,
  col2 int,
  dt date
) partition by(dt);

create table t2 (
  col1 string,
  col2 int,
  dt date
) partition by(dt);

create table t3 (
  col1 string,
  col2 int,
  dt date
) partition by(dt);

create table t4 (
  col1 string,
  col2 int,
  dt date
) partition by(dt);

create table t5 (
  col1 string,
  col2 int,
  dt date
) partition by(dt);

insert into t1 values 
  ('a', 1, '2023-12-01'),
  ('a', 2, '2023-12-01'),
  ('b', 3, '2023-12-02'),
  ('', 4, '2023-12-02'),
  (NULL, 5, '2023-12-03'),
  (NULL, 6, '2023-12-03'),
  (NULL, NULL, '2023-12-04'),
  (NULL, NULL, NULL);

insert into t2 values 
  ('a', 1, '2023-12-01'),
  ('b', 3, '2023-12-02'),
  ('', 4, '2023-12-02'),
  (NULL, 5, '2023-12-03'),
  (NULL, NULL, NULL);

insert into t3 values 
  ('a', 1, '2023-12-01'),
  ('b', 3, '2023-12-02'),
  ('', 4, '2023-12-02'),
  (NULL, 5, '2023-12-03'),
  (NULL, NULL, NULL);

insert into t4 values 
  ('a', 1, '2023-12-01'),
  ('b', 3, '2023-12-02'),
  ('', 4, '2023-12-02'),
  (NULL, 5, '2023-12-03'),
  (NULL, NULL, NULL);

insert into t5 values 
  ('a', 1, '2023-12-01'),
  ('b', 3, '2023-12-02'),
  ('', 4, '2023-12-02'),
  (NULL, 5, '2023-12-03'),
  (NULL, NULL, NULL);

set catalog default_catalog;
create database db_${uuid0};
use db_${uuid0};

set enable_materialized_view_rewrite=false;
-- case 1: join 5 tables and aggregate
CREATE MATERIALIZED VIEW test_mv1 PARTITION BY dt 
REFRESH DEFERRED MANUAL 
properties
(
    "refresh_mode" = "incremental"
)
AS SELECT 
  t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51,
  sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52,
  avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53,
  min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54,
  max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55,
  count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56,
  approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57
FROM 
  mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 
  JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt
  JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt
  JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt
  JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt
 GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;

REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
function: print_hit_materialized_view("SELECT t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52 from mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 on t1.dt = t2.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 on t1.dt = t3.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 on t1.dt = t4.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 on t1.dt = t5.dt group by t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;", "test_mv1")
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;
SELECT t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52, avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53, min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54, max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55, count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56, approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57 FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-01');
function: print_hit_materialized_view("SELECT t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52 from mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 on t1.dt = t2.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 on t1.dt = t3.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 on t1.dt = t4.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 on t1.dt = t5.dt group by t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;", "test_mv1")
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;
SELECT t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52, avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53, min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54, max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55, count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56, approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57 FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('a', 2000, '2023-12-01');

REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
function: print_hit_materialized_view("SELECT t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52 from mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 on t1.dt = t2.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 on t1.dt = t3.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 on t1.dt = t4.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 on t1.dt = t5.dt group by t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;", "test_mv1")
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;
SELECT t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52, avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53, min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54, max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55, count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56, approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57 FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;


insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('b', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 values 
  ('c', 2000, '2023-12-01');
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
function: print_hit_materialized_view("SELECT t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52 from mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 on t1.dt = t2.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 on t1.dt = t3.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 on t1.dt = t4.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 on t1.dt = t5.dt group by t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;", "test_mv1")
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;
SELECT t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52, avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53, min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54, max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55, count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56, approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57 FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;


insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('b', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 values 
  ('c', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 values 
  ('a', 2000, '2023-12-01');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 values 
  ('a', 2000, '2023-12-01');

REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
function: print_hit_materialized_view("SELECT t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52 from mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 on t1.dt = t2.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 on t1.dt = t3.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 on t1.dt = t4.dt join mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 on t1.dt = t5.dt group by t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1;", "test_mv1")
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;
SELECT t1.dt, t1.col1 as col11, t2.col1 as col21, t3.col1 as col31, t4.col1 as col41, t5.col1 as col51, sum(t1.col2) as col12, sum(t2.col2) as col22, sum(t3.col2) as col32, sum(t4.col2) as col42, sum(t5.col2) as col52, avg(t1.col2) as col13, avg(t2.col2) as col23, avg(t3.col2) as col33, avg(t4.col2) as col43, avg(t5.col2) as col53, min(t1.col2) as col14, min(t2.col2) as col24, min(t3.col2) as col34, min(t4.col2) as col44, min(t5.col2) as col54, max(t1.col2) as col15, max(t2.col2) as col25, max(t3.col2) as col35, max(t4.col2) as col45, max(t5.col2) as col55, count(t1.col2) as col16, count(t2.col2) as col26, count(t3.col2) as col36, count(t4.col2) as col46, count(t5.col2) as col56, approx_count_distinct(t1.col2) as col17, approx_count_distinct(t2.col2) as col27, approx_count_distinct(t3.col2) as col37, approx_count_distinct(t4.col2) as col47, approx_count_distinct(t5.col2) as col57 FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 ON t1.dt = t2.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 ON t1.dt = t3.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 ON t1.dt = t4.dt JOIN mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 ON t1.dt = t5.dt GROUP BY t1.dt, t1.col1, t2.col1, t3.col1, t4.col1, t5.col1 ORDER BY dt, col11, col21, col31, col41, col51 limit 5;

DROP MATERIALIZED VIEW test_mv1;

-- case 2: union 5 tables and aggregate
CREATE MATERIALIZED VIEW test_mv1 PARTITION BY dt 
REFRESH DEFERRED MANUAL 
properties
(
    "refresh_mode" = "incremental"
)
AS 
SELECT 
  t.dt, t.col1 as col11,
  sum(t.col2) as col13, avg(t.col2) as col14, min(t.col2) as col15, max(t.col2) as col16, count(t.col2) as col17, approx_count_distinct(t.col2) as col18
FROM (
  SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1
  UNION ALL
  SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2
  UNION ALL
  SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3
  UNION ALL
  SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4
  UNION ALL
  SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5) t
GROUP BY t.dt, t.col1;


REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col17, col18 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-01');
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col17, col18 limit 5;
SELECT t.dt, t.col1 as col11, sum(t.col2) as col13, avg(t.col2) as col14, min(t.col2) as col15, max(t.col2) as col16, count(t.col2) as col17, approx_count_distinct(t.col2) as col18 FROM (SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5) t GROUP BY t.dt, t.col1 ORDER BY t.dt, t.col1, col17, col18 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-11');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('a', 2000, '2023-12-11');
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col17, col18 limit 5;
SELECT t.dt, t.col1 as col11, sum(t.col2) as col13, avg(t.col2) as col14, min(t.col2) as col15, max(t.col2) as col16, count(t.col2) as col17, approx_count_distinct(t.col2) as col18 FROM (SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5) t GROUP BY t.dt, t.col1 ORDER BY t.dt, t.col1, col17, col18 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-11');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('b', 2000, '2023-12-11');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 values 
  ('c', 2000, '2023-12-12');
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col17, col18 limit 5;
SELECT t.dt, t.col1 as col11, sum(t.col2) as col13, avg(t.col2) as col14, min(t.col2) as col15, max(t.col2) as col16, count(t.col2) as col17, approx_count_distinct(t.col2) as col18 FROM (SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5) t GROUP BY t.dt, t.col1 ORDER BY t.dt, t.col1, col17, col18 limit 5;

insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 values 
  ('a', 2000, '2023-12-21');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 values 
  ('b', 2000, '2023-12-21');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 values 
  ('c', 2000, '2023-12-21');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 values 
  ('d', 2000, '2023-12-21');
insert into mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 values 
  ('a', 2000, NULL);

REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(*) FROM test_mv1;
SELECT * FROM test_mv1 ORDER BY dt, col11, col17, col18 limit 5;
SELECT t.dt, t.col1 as col11, sum(t.col2) as col13, avg(t.col2) as col14, min(t.col2) as col15, max(t.col2) as col16, count(t.col2) as col17, approx_count_distinct(t.col2) as col18 FROM (SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 UNION ALL SELECT * FROM mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5) t GROUP BY t.dt, t.col1 ORDER BY t.dt, t.col1, col17, col18 limit 5;

DROP MATERIALIZED VIEW test_mv1;

drop table mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t1 force;
drop table mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t2 force;
drop table mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t3 force;
drop table mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t4 force;
drop table mv_iceberg_${uuid0}.mv_ice_db_${uuid0}.t5 force;
drop database mv_iceberg_${uuid0}.mv_ice_db_${uuid0} force;
drop database db_${uuid0};