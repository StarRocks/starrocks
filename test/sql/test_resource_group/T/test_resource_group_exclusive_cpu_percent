-- name: test_resource_group_exclusive_cpu_percent @sequential

CREATE RESOURCE GROUP rgd1_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'exclusive_cpu_percent' = '30', 'mem_limit' = '0.99' );
CREATE RESOURCE GROUP rgd2_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'exclusive_cpu_percent' = '50', 'mem_limit' = '0.99' );
CREATE RESOURCE GROUP rgn1_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'cpu_weight_percent' = '4', 'mem_limit' = '0.99' );
CREATE RESOURCE GROUP rgn2_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'cpu_weight_percent' = '5', 'mem_limit' = '0.99' );

[UC]SELECT sleep(10);

[UC]function: num_cores=get_backend_cpu_cores()
[UC]function: rgd1_id=get_resource_group_id('rgd1_${uuid0}')
[UC]function: rgd2_id=get_resource_group_id('rgd2_${uuid0}')
[UC]function: rgn1_id=get_resource_group_id('rgn1_${uuid0}')
[UC]function: rgn2_id=get_resource_group_id('rgn2_${uuid0}')


select
    min(bound_cpus)=cast(${num_cores}*0.3 as int),
    max(bound_cpus)=cast(${num_cores}*0.3 as int)
from information_schema.be_threads where name = 'pip_exec_${rgd1_id}';
select count(1)=cast(${num_cores}*0.3 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd1_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd1_id}' limit 1);

select min(bound_cpus)=cast(${num_cores}*0.5 as int), max(bound_cpus)=cast(${num_cores}*0.5 as int) from information_schema.be_threads where name = 'pip_exec_${rgd2_id}';
select count(1)=cast(${num_cores}*0.5 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' limit 1);

select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';

select
        min(bound_cpus) = array_min([${num_cores} - cast(${num_cores}*0.5 as int) - cast(${num_cores}*0.3 as int), cast(${num_cores}*0.5 as int),  cast(${num_cores}*0.3 as int)]),
        max(bound_cpus) = array_max([${num_cores} - cast(${num_cores}*0.5 as int) - cast(${num_cores}*0.3 as int), cast(${num_cores}*0.5 as int),  cast(${num_cores}*0.3 as int)])
from information_schema.be_threads where name = 'pip_exec_com';
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);



DROP RESOURCE GROUP rgd1_${uuid0};
[UC]SELECT sleep(5);

select min(bound_cpus)=cast(${num_cores}*0.5 as int), max(bound_cpus)=cast(${num_cores}*0.5 as int) from information_schema.be_threads where name = 'pip_exec_${rgd2_id}';
select count(1)=cast(${num_cores}*0.5 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' limit 1);

select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';

select
    min(bound_cpus) = array_min([${num_cores} - cast(${num_cores}*0.5 as int), cast(${num_cores}*0.5 as int)]),
    max(bound_cpus) = array_max([${num_cores} - cast(${num_cores}*0.5 as int), cast(${num_cores}*0.5 as int)])
from information_schema.be_threads where name = 'pip_exec_com';
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);



DROP RESOURCE GROUP rgd2_${uuid0};
[UC]SELECT sleep(5);

select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';

select
    min(bound_cpus) = ${num_cores},
    max(bound_cpus) = ${num_cores}
from information_schema.be_threads where name = 'pip_exec_com';
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);


DROP RESOURCE GROUP rgn1_${uuid0};
DROP RESOURCE GROUP rgn2_${uuid0};


