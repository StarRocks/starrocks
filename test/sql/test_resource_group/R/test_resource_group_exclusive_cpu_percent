-- name: test_resource_group_exclusive_cpu_percent @sequential
CREATE RESOURCE GROUP rgd1_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'exclusive_cpu_percent' = '30', 'mem_limit' = '0.99' );
-- result:
-- !result
CREATE RESOURCE GROUP rgd2_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'exclusive_cpu_percent' = '50', 'mem_limit' = '0.99' );
-- result:
-- !result
CREATE RESOURCE GROUP rgn1_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'cpu_weight_percent' = '4', 'mem_limit' = '0.99' );
-- result:
-- !result
CREATE RESOURCE GROUP rgn2_${uuid0}
TO ( user='user_${uuid0}' )
WITH ( 'cpu_weight_percent' = '5', 'mem_limit' = '0.99' );
-- result:
-- !result
[UC]SELECT sleep(10);
-- result:
1
-- !result
[UC]function: num_cores=get_backend_cpu_cores()
-- result:
16
-- !result
[UC]function: rgd1_id=get_resource_group_id('rgd1_${uuid0}')
-- result:
11406
-- !result
[UC]function: rgd2_id=get_resource_group_id('rgd2_${uuid0}')
-- result:
11408
-- !result
[UC]function: rgn1_id=get_resource_group_id('rgn1_${uuid0}')
-- result:
11410
-- !result
[UC]function: rgn2_id=get_resource_group_id('rgn2_${uuid0}')
-- result:
11412
-- !result
select
    min(bound_cpus)=cast(${num_cores}*0.3 as int),
    max(bound_cpus)=cast(${num_cores}*0.3 as int)
from information_schema.be_threads where name = 'pip_exec_${rgd1_id}';
-- result:
1	1
-- !result
select count(1)=cast(${num_cores}*0.3 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd1_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd1_id}' limit 1);
-- result:
1
-- !result
select min(bound_cpus)=cast(${num_cores}*0.5 as int), max(bound_cpus)=cast(${num_cores}*0.5 as int) from information_schema.be_threads where name = 'pip_exec_${rgd2_id}';
-- result:
1	1
-- !result
select count(1)=cast(${num_cores}*0.5 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' limit 1);
-- result:
1
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
-- result:
0
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';
-- result:
0
-- !result
select
        min(bound_cpus) = array_min([${num_cores} - cast(${num_cores}*0.5 as int) - cast(${num_cores}*0.3 as int), cast(${num_cores}*0.5 as int),  cast(${num_cores}*0.3 as int)]),
        max(bound_cpus) = array_max([${num_cores} - cast(${num_cores}*0.5 as int) - cast(${num_cores}*0.3 as int), cast(${num_cores}*0.5 as int),  cast(${num_cores}*0.3 as int)])
from information_schema.be_threads where name = 'pip_exec_com';
-- result:
1	1
-- !result
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);
-- result:
1
-- !result
DROP RESOURCE GROUP rgd1_${uuid0};
-- result:
-- !result
[UC]SELECT sleep(5);
-- result:
1
-- !result
select min(bound_cpus)=cast(${num_cores}*0.5 as int), max(bound_cpus)=cast(${num_cores}*0.5 as int) from information_schema.be_threads where name = 'pip_exec_${rgd2_id}';
-- result:
1	1
-- !result
select count(1)=cast(${num_cores}*0.5 as int) as num_threads from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_${rgd2_id}' limit 1);
-- result:
1
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
-- result:
0
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';
-- result:
0
-- !result
select
    min(bound_cpus) = array_min([${num_cores} - cast(${num_cores}*0.5 as int), cast(${num_cores}*0.5 as int)]),
    max(bound_cpus) = array_max([${num_cores} - cast(${num_cores}*0.5 as int), cast(${num_cores}*0.5 as int)])
from information_schema.be_threads where name = 'pip_exec_com';
-- result:
1	1
-- !result
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);
-- result:
1
-- !result
DROP RESOURCE GROUP rgd2_${uuid0};
-- result:
-- !result
[UC]SELECT sleep(5);
-- result:
1
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn1_id}';
-- result:
0
-- !result
select count(1) from information_schema.be_threads where name = 'pip_exec_${rgn2_id}';
-- result:
0
-- !result
select
    min(bound_cpus) = ${num_cores},
    max(bound_cpus) = ${num_cores}
from information_schema.be_threads where name = 'pip_exec_com';
-- result:
1	1
-- !result
select count(1) = ${num_cores} from information_schema.be_threads where name = 'pip_exec_com' and be_id = (select be_id from information_schema.be_threads where name = 'pip_exec_com' limit 1);
-- result:
1
-- !result
DROP RESOURCE GROUP rgn1_${uuid0};
-- result:
-- !result
DROP RESOURCE GROUP rgn2_${uuid0};
-- result:
-- !result