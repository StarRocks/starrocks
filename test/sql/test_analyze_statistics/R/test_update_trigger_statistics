-- name: test_update_trigger_statistics @sequential
DROP DATABASE IF EXISTS test_update_trigger_statistics;
-- result:
-- !result
CREATE DATABASE test_update_trigger_statistics;
-- result:
-- !result
USE test_update_trigger_statistics;
-- result:
-- !result
CREATE TABLE test_update_stats (
    k2 int,
    k3 varchar(20)
) 
PRIMARY KEY (k2)
DISTRIBUTED BY HASH(k2) BUCKETS 1
PROPERTIES ( "replication_num" = "1");
-- result:
-- !result
CREATE VIEW statistic_verify AS
select column_name, partition_name, row_count, max, min 
from _statistics_.column_statistics 
where table_name = "test_update_trigger_statistics.test_update_stats" ;
-- result:
-- !result
CREATE VIEW analyze_status_verify AS
select `Table`, Columns, Type, 
    IF(cast(Id as bigint) > @last_analyze_id, 'new analyze', 'no analyze') as is_new from information_schema.analyze_status
where 
    `Database` = 'test_update_trigger_statistics' 
    and `Table` = "test_update_stats" 
order by cast(Id as bigint) desc limit 1;
-- result:
-- !result
CREATE VIEW last_analyze_id_view AS
select ifnull(max(cast(Id as bigint)), 0) as last_id
from information_schema.analyze_status 
where `Database` = 'test_update_trigger_statistics' 
  and `Table` = "test_update_stats";
-- result:
-- !result
delete from _statistics_.column_statistics where table_name='test_update_trigger_statistics.test_update_stats';
-- result:
-- !result
insert into test_update_stats select generate_series, 'data' from table(generate_series(1, 1000000));
-- result:
-- !result
select * from statistic_verify order by column_name;
-- result:
k2	test_update_stats	1000000	1000000	1
k3	test_update_stats	1000000	data	data
-- !result
set @last_analyze_id=(select last_id from last_analyze_id_view);
-- result:
-- !result
update test_update_stats set k3 = '1updated' where k2 = 1;
-- result:
-- !result
select * from statistic_verify order by column_name;
-- result:
k2	test_update_stats	1000000	1000000	1
k3	test_update_stats	1000000	data	data
-- !result
select * from analyze_status_verify;
-- result:
test_update_stats	ALL	SAMPLE	no analyze
-- !result
update test_update_stats set k3 = '2updated2' where k2 < 1000;
-- result:
-- !result
select * from statistic_verify order by column_name;
-- result:
k2	test_update_stats	1000000	1000000	1
k3	test_update_stats	1000000	data	data
-- !result
select * from analyze_status_verify;
-- result:
test_update_stats	ALL	SAMPLE	no analyze
-- !result
set @last_analyze_id=(select last_id from last_analyze_id_view);
-- result:
-- !result
update test_update_stats set k3 = '3updated3' where k2 < 200*1000;
-- result:
-- !result
select * from statistic_verify order by column_name;
-- result:
k2	test_update_stats	1000000	1000000	1
k3	test_update_stats	1000000	data	3updated3
-- !result
select * from analyze_status_verify;
-- result:
test_update_stats	ALL	FULL	new analyze
-- !result
set @last_analyze_id=(select last_id from last_analyze_id_view);
-- result:
-- !result
update test_update_stats set k3 = '4updated4' where k2 < 1000000000;
-- result:
-- !result
select * from analyze_status_verify;
-- result:
test_update_stats	ALL	SAMPLE	new analyze
-- !result
drop table test_update_stats;
-- result:
-- !result
drop view  statistic_verify;
-- result:
-- !result
drop view  analyze_status_verify;
-- result:
-- !result
drop view  last_analyze_id_view;
-- result:
-- !result
delete from _statistics_.column_statistics where table_name='test_update_trigger_statistics.test_update_stats';
-- result:
-- !result