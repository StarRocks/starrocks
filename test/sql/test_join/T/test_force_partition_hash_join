-- name: test_force_partition_hash_join @sequential

CREATE TABLE `t0` (
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`c0`, `c1`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`c0`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"compression" = "LZ4"
);

CREATE TABLE `t1` (
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`c0`, `c1`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`c0`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"compression" = "LZ4"
);

insert into t0 SELECT generate_series, generate_series, generate_series, generate_series FROM TABLE(generate_series(1,  409600));
insert into t1 select * from t0;
insert into t0 SELECT generate_series, generate_series, generate_series, generate_series FROM TABLE(generate_series(409600, 409600 + 20000));

admin enable failpoint 'always_use_partition_join';

select count(l.c0), avg(l.c0), count(l.c1), count(l.c0), count(r.c1) from t0 l join t1 r on l.c0 = r.c0 and l.c1 = r.c1;
select count(l.c0), avg(l.c0), count(l.c1), count(l.c0), count(r.c1) from t0 l left join t1 r on l.c0 = r.c0 and l.c1 = r.c1;
select count(l.c0), avg(l.c0), count(l.c1), count(l.c0), count(r.c1) from t0 l right join t1 r on l.c0 = r.c0 and l.c1 = r.c1;

-- null-aware left anti join
select count(*) from (select * from t0 where c0 not in (select c0 from t1)) t;
select count(*) from (select * from t0 where c0 not in (select c0 from t1 where t0.c1  )) t;
insert into t1 values(null,null,null,null);
-- null-aware left anti join
select count(*) from (select * from t0 where c0 not in (select c0 from t1)) t;

CREATE TABLE `nullaware_anti_join_test` (
  `k1` int(11) COMMENT "",
  `k2` int(11)  COMMENT "",
  `k3` int(11)
) ENGINE=OLAP
DUPLICATE KEY(`k1`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`k1`) BUCKETS 1
PROPERTIES ("replication_num" = "1");

insert into nullaware_anti_join_test values (1,1,1),(1,2,1),(1,3,2),(11,1,11),(11,2,1),(2,3,2),(2,3,null),(null,null,null);
select * from nullaware_anti_join_test l1 where l1.k1 not in ( select l3.k1 from nullaware_anti_join_test l3 ) order by 1,2,3;
select * from nullaware_anti_join_test l1 where l1.k1 in ( select l3.k1 from nullaware_anti_join_test l3 ) order by 1,2,3;
select * from nullaware_anti_join_test l1 where l1.k1 not in ( select l3.k1 from nullaware_anti_join_test l3 where  l3.k3 = l1.k3 ) order by 1,2,3;
select * from nullaware_anti_join_test l1 where l1.k1 not in ( select l3.k1 from nullaware_anti_join_test l3 where  l3.k3 != l1.k3 ) order by 1,2,3;
select * from nullaware_anti_join_test l1 where not exists ( select 1 from nullaware_anti_join_test l3 where l3.k1 = l1.k1 and l3.k3 != l1.k3) order by 1,2,3;

CREATE TABLE `t2` (
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`c0`, `c1`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`c0`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"compression" = "LZ4"
);
CREATE TABLE `t3` (
  `c0` int(11) NULL COMMENT "",
  `c1` varchar(20) NULL COMMENT "",
  `c2` varchar(200) NULL COMMENT "",
  `c3` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`c0`, `c1`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`c0`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"compression" = "LZ4"
);
insert into t2 values(null,null,null,null);
insert into t3 SELECT generate_series, generate_series, generate_series, generate_series FROM TABLE(generate_series(1,  409600));
select count(*) from (select * from t2 where c0 not in (select c0 from t3 where if(t3.c0=1,t2.c1, true)  )) t;
select count(*) from (select * from t2 where c0 not in (select c0 from t3 where if(t3.c0!=2,t2.c0 is not null, true)  )) t;


admin disable failpoint 'always_use_partition_join';
