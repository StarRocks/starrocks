-- name: test_percentile_cont

CREATE TABLE `test_pc` (
  `date` date NULL COMMENT "",
  `datetime` datetime NULL COMMENT "",
  `db` double NULL COMMENT "",
  `id` int(11) NULL COMMENT "",
  `name` varchar(255) NULL COMMENT "",
  `subject` varchar(255) NULL COMMENT "",
  `score` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`date`)
DISTRIBUTED BY HASH(`id`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"enable_persistent_index" = "true",
"replicated_storage" = "true",
"compression" = "LZ4"
);


insert into test_pc values ("2018-01-01","2018-01-01 00:00:01",11.1,1,"Tom","English",90);
insert into test_pc values ("2019-01-01","2019-01-01 00:00:01",11.2,1,"Tom","English",91);
insert into test_pc values ("2020-01-01","2020-01-01 00:00:01",11.3,1,"Tom","English",92);
insert into test_pc values ("2021-01-01","2021-01-01 00:00:01",11.4,1,"Tom","English",93);
insert into test_pc values ("2022-01-01","2022-01-01 00:00:01",11.5,1,"Tom","English",94);
insert into test_pc values (NULL,NULL,NULL,NULL,"Tom","English",NULL);


select percentile_cont(score, 0) from test_pc;
select percentile_cont(score, 0.25) from test_pc;
select percentile_cont(score, 0.5) from test_pc;
select percentile_cont(score, 0.75) from test_pc;
select percentile_cont(score, 1) from test_pc;
select percentile_cont(date, 0) from test_pc;
select percentile_cont(date, 0.25) from test_pc;
select percentile_cont(date, 0.5) from test_pc;
select percentile_cont(date, 0.75) from test_pc;
select percentile_cont(date, 1) from test_pc;
select percentile_cont(datetime, 0) from test_pc;
select percentile_cont(datetime, 0.25) from test_pc;
select percentile_cont(datetime, 0.5) from test_pc;
select percentile_cont(datetime, 0.75) from test_pc;
select percentile_cont(datetime, 1) from test_pc;
select percentile_cont(db, 0) from test_pc;
select percentile_cont(db, 0.25) from test_pc;
select percentile_cont(db, 0.5) from test_pc;
select percentile_cont(db, 0.75) from test_pc;
select percentile_cont(db, 1) from test_pc;
select percentile_cont(db, 2) from test_pc;
select percentile_cont(db, -1) from test_pc;
select percentile_cont(db, cast(1.0 as double)) from test_pc;
select percentile_cont(db, cast(0.5 as double)) from test_pc;
select percentile_cont(db, cast(1.5 as double)) from test_pc;
select percentile_cont(1, cast(1.0 as double));
select percentile_cont(1, cast(0.5 as double));
select percentile_cont(1, cast(1.5 as double));

CREATE TABLE `test_pc_decimal` (
  `id` int(11) NULL COMMENT "",
  `v0` decimal(9,0) NULL COMMENT "",
  `v2` decimal(9,2) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`id`)
DISTRIBUTED BY HASH(`id`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"enable_persistent_index" = "true",
"replicated_storage" = "true",
"compression" = "LZ4"
);

insert into test_pc_decimal values (1, 0, 1.00);
insert into test_pc_decimal values (2, 10, 2.00);
insert into test_pc_decimal values (3, 20, 3.00);
insert into test_pc_decimal values (4, 30, 4.00);
insert into test_pc_decimal values (NULL, NULL, NULL);

select percentile_cont(v0, cast(0 as decimal(9,2))) from test_pc_decimal;
select percentile_cont(v0, cast(1 as decimal(9,2))) from test_pc_decimal;
select percentile_cont(v0, cast(0.5 as decimal(9,2))) from test_pc_decimal;
select percentile_cont(v0, cast(0.5 as decimal(9,4))) from test_pc_decimal;
select percentile_cont(v2, cast(0.5 as decimal(9,2))) from test_pc_decimal;
select percentile_cont(v0, cast(1.1 as decimal(9,2))) from test_pc_decimal;

select /*+ SET_VAR (new_planner_agg_stage = '2') */ percentile_cont(v0, cast(0 as decimal(9,2)))
from test_pc_decimal;
select /*+ SET_VAR (new_planner_agg_stage = '2') */ percentile_cont(v0, cast(1 as decimal(9,2)))
from test_pc_decimal;
select /*+ SET_VAR (new_planner_agg_stage = '2') */ id % 2 as g,
       percentile_cont(v0, cast(0.5 as decimal(9,2)))
from test_pc_decimal
group by g
order by g;

select /*+ SET_VAR (new_planner_agg_stage = '2', streaming_preaggregation_mode = 'force_streaming') */
       percentile_cont(v0, cast(0.5 as decimal(9,2)))
from test_pc_decimal;
select /*+ SET_VAR (new_planner_agg_stage = '2', streaming_preaggregation_mode = 'force_preaggregation') */
       percentile_cont(v0, cast(0.5 as decimal(9,2)))
from test_pc_decimal;

select /*+ SET_VAR (new_planner_agg_stage = '2', streaming_preaggregation_mode = 'force_streaming') */
       id % 2 as g, percentile_cont(v0, cast(0.5 as decimal(9,2)))
from test_pc_decimal
group by g
order by g;
select /*+ SET_VAR (new_planner_agg_stage = '2', streaming_preaggregation_mode = 'force_preaggregation') */
       id % 2 as g, percentile_cont(v0, cast(0.5 as decimal(9,2)))
from test_pc_decimal
group by g
order by g;

CREATE TABLE `test_pc_decimal_fallback` (
  `vfb` decimal(9,2) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`vfb`)
DISTRIBUTED BY HASH(`vfb`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"enable_persistent_index" = "true",
"replicated_storage" = "true",
"compression" = "LZ4"
);

insert into test_pc_decimal_fallback values (0.00);
insert into test_pc_decimal_fallback values (9000000.00);

select percentile_cont(vfb, cast(0.5 as decimal(9,4))) from test_pc_decimal_fallback;

CREATE TABLE `test_pc_decimal_big` (
  `v2` decimal(9,2) NULL COMMENT "",
  `g` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`g`)
DISTRIBUTED BY HASH(`g`) BUCKETS 4
PROPERTIES (
"replication_num" = "1",
"enable_persistent_index" = "true",
"replicated_storage" = "true",
"compression" = "LZ4"
);

insert into test_pc_decimal_big
select cast(generate_series as decimal(9,2)) as v2, generate_series % 2 as g
from TABLE(generate_series(0, 99999));

select percentile_cont(v2, cast(0.5 as decimal(9,2))) from test_pc_decimal_big;
select /*+ SET_VAR (new_planner_agg_stage = '2') */ g,
       percentile_cont(v2, cast(0.5 as decimal(9,2)))
from test_pc_decimal_big
group by g
order by g;
