-- name: test_ndv_with_varbinary_type
CREATE TABLE tbinary_ndv_test (
    id INT,
    data VARBINARY,
    category INT
)
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id)
BUCKETS 1
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO tbinary_ndv_test
SELECT generate_series,
       to_binary(CONCAT('value_', CAST(generate_series AS VARCHAR))),
       (generate_series - 1) % 5 + 1
FROM TABLE(GENERATE_SERIES(1, 100));
-- result:
-- !result
SELECT ndv(data) AS ndv_result FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT category, ndv(data) AS ndv_result FROM tbinary_ndv_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
4	1
5	1
-- !result
SELECT approx_count_distinct(data) AS approx_count_result FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT category, approx_count_distinct(data) AS approx_count_result FROM tbinary_ndv_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
4	1
5	1
-- !result
SELECT ds_hll_count_distinct(data) AS ds_hll_result FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT ds_hll_count_distinct(data, 10) AS ds_hll_result_with_logk FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT category, ds_hll_count_distinct(data) AS ds_hll_result FROM tbinary_ndv_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
4	1
5	1
-- !result
SELECT ds_theta_count_distinct(data) AS theta_result FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT category, ds_theta_count_distinct(data) AS theta_result FROM tbinary_ndv_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
4	1
5	1
-- !result
SELECT COUNT(DISTINCT data) AS distinct_count FROM tbinary_ndv_test;
-- result:
1
-- !result
SELECT category, COUNT(DISTINCT data) AS distinct_count FROM tbinary_ndv_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
4	1
5	1
-- !result
CREATE TABLE tbinary_ndv_null_test (
    id INT,
    data VARBINARY,
    category INT
)
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id)
BUCKETS 1
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO tbinary_ndv_null_test VALUES
(1, to_binary('aaa'), 1),
(2, to_binary('bbb'), 1),
(3, NULL, 1),
(4, to_binary('aaa'), 2),
(5, to_binary('ccc'), 2),
(6, NULL, 2),
(7, to_binary('ddd'), 3),
(8, to_binary('eee'), 3),
(9, to_binary('fff'), 3);
-- result:
-- !result
SELECT ndv(data) AS ndv_with_null FROM tbinary_ndv_null_test;
-- result:
1
-- !result
SELECT category, ndv(data) AS ndv_with_null FROM tbinary_ndv_null_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
-- !result
SELECT COUNT(DISTINCT data) AS distinct_count_with_null FROM tbinary_ndv_null_test;
-- result:
1
-- !result
SELECT category, COUNT(DISTINCT data) AS distinct_count_with_null FROM tbinary_ndv_null_test GROUP BY category ORDER BY category;
-- result:
1	1
2	1
3	1
-- !result
CREATE TABLE tbinary_ndv_dup_test (
    id INT,
    data VARBINARY
)
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id)
BUCKETS 1
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO tbinary_ndv_dup_test VALUES
(1, to_binary('same_value')),
(2, to_binary('same_value')),
(3, to_binary('same_value')),
(4, to_binary('different_value')),
(5, to_binary('different_value')),
(6, NULL),
(7, NULL);
-- result:
-- !result
SELECT ndv(data) AS ndv_dup_result FROM tbinary_ndv_dup_test;
-- result:
1
-- !result
SELECT COUNT(DISTINCT data) AS distinct_count_dup FROM tbinary_ndv_dup_test;
-- result:
1
-- !result
CREATE TABLE tbinary_multi_distinct_test (
    id INT,
    data1 VARBINARY,
    data2 VARBINARY,
    data3 VARBINARY,
    category INT
)
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id)
BUCKETS 1
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO tbinary_multi_distinct_test VALUES
(1, to_binary('value1'), to_binary('val1'), to_binary('v1'), 1),
(2, to_binary('value2'), to_binary('val1'), to_binary('v1'), 1),
(3, to_binary('value1'), to_binary('val2'), to_binary('v2'), 1),
(4, to_binary('value3'), to_binary('val2'), to_binary('v1'), 2),
(5, to_binary('value4'), to_binary('val3'), to_binary('v3'), 2),
(6, to_binary('value3'), to_binary('val3'), to_binary('v2'), 2),
(7, to_binary('value5'), to_binary('val4'), to_binary('v4'), 3),
(8, to_binary('value6'), to_binary('val4'), to_binary('v4'), 3),
(9, to_binary('value5'), to_binary('val5'), to_binary('v5'), 3);
-- result:
-- !result
SELECT COUNT(DISTINCT data1) AS distinct_data1, 
       COUNT(DISTINCT data2) AS distinct_data2,
       COUNT(DISTINCT data3) AS distinct_data3
FROM tbinary_multi_distinct_test;
-- result:
1	1	1
-- !result
SELECT category,
       COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2,
       COUNT(DISTINCT data3) AS distinct_data3
FROM tbinary_multi_distinct_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1	1
2	1	1	1
3	1	1	1
-- !result
SELECT ndv(data1) AS ndv_data1,
       approx_count_distinct(data2) AS approx_data2,
       ds_hll_count_distinct(data3) AS hll_data3
FROM tbinary_multi_distinct_test;
-- result:
1	1	1
-- !result
SELECT category,
       ndv(data1) AS ndv_data1,
       approx_count_distinct(data2) AS approx_data2,
       ds_theta_count_distinct(data3) AS theta_data3
FROM tbinary_multi_distinct_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1	1
2	1	1	1
3	1	1	1
-- !result
SELECT COUNT(DISTINCT data1) AS exact_count1,
       ndv(data2) AS approx_count2,
       COUNT(DISTINCT data3) AS exact_count3,
       ds_hll_count_distinct(data1) AS hll_count1
FROM tbinary_multi_distinct_test;
-- result:
1	1	1	1
-- !result
SELECT category,
       COUNT(DISTINCT data1) AS exact_count1,
       ndv(data2) AS approx_count2,
       approx_count_distinct(data3) AS approx_count3
FROM tbinary_multi_distinct_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1	1
2	1	1	1
3	1	1	1
-- !result
SELECT COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2,
       COUNT(*) AS total_rows,
       MAX(id) AS max_id
FROM tbinary_multi_distinct_test;
-- result:
1	1	9	9
-- !result
SELECT category,
       COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2,
       COUNT(*) AS total_rows,
       MIN(id) AS min_id,
       MAX(id) AS max_id
FROM tbinary_multi_distinct_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1	3	1	3
2	1	1	3	4	6
3	1	1	3	7	9
-- !result
SELECT category,
       COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2,
       ndv(data3) AS ndv_data3,
       COUNT(*) AS total
FROM tbinary_multi_distinct_test
WHERE id > 2
GROUP BY category
HAVING COUNT(DISTINCT data1) > 1
ORDER BY category;
-- result:
-- !result
SELECT ndv(data1) AS ndv1,
       approx_count_distinct(data2) AS approx2,
       ds_hll_count_distinct(data3) AS hll3,
       ds_theta_count_distinct(data1) AS theta1
FROM tbinary_multi_distinct_test;
-- result:
1	1	1	1
-- !result
SELECT category,
       ndv(data1) AS ndv1,
       approx_count_distinct(data2) AS approx2,
       ds_hll_count_distinct(data3) AS hll3,
       ds_theta_count_distinct(data1) AS theta1
FROM tbinary_multi_distinct_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1	1	1
2	1	1	1	1
3	1	1	1	1
-- !result
CREATE TABLE tbinary_multi_null_test (
    id INT,
    data1 VARBINARY,
    data2 VARBINARY,
    category INT
)
DUPLICATE KEY(id)
DISTRIBUTED BY HASH(id)
BUCKETS 1
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
INSERT INTO tbinary_multi_null_test VALUES
(1, to_binary('val1'), to_binary('valA'), 1),
(2, NULL, to_binary('valA'), 1),
(3, to_binary('val1'), NULL, 1),
(4, NULL, NULL, 1),
(5, to_binary('val2'), to_binary('valB'), 2),
(6, to_binary('val2'), NULL, 2),
(7, NULL, to_binary('valB'), 2);
-- result:
-- !result
SELECT COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2
FROM tbinary_multi_null_test;
-- result:
1	1
-- !result
SELECT category,
       COUNT(DISTINCT data1) AS distinct_data1,
       COUNT(DISTINCT data2) AS distinct_data2
FROM tbinary_multi_null_test
GROUP BY category
ORDER BY category;
-- result:
1	1	1
2	1	1
-- !result
SELECT COUNT(DISTINCT data1) AS exact1,
       ndv(data2) AS approx2,
       approx_count_distinct(data1) AS approx1,
       COUNT(DISTINCT data2) AS exact2
FROM tbinary_multi_null_test;
-- result:
1	1	1	1
-- !result
DROP TABLE IF EXISTS tbinary_ndv_test;
-- result:
-- !result
DROP TABLE IF EXISTS tbinary_ndv_null_test;
-- result:
-- !result
DROP TABLE IF EXISTS tbinary_ndv_dup_test;
-- result:
-- !result
DROP TABLE IF EXISTS tbinary_multi_distinct_test;
-- result:
-- !result
DROP TABLE IF EXISTS tbinary_multi_null_test;
-- result:
-- !result