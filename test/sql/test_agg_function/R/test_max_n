-- name: test_max_n_without_null
CREATE TABLE `t_without_null` (
  `c_id` INT(11) NOT NULL,
  `c_int` INT(11) NOT NULL,
  `c_tinyint` TINYINT NOT NULL,
  `c_smallint` SMALLINT NOT NULL,
  `c_bigint` BIGINT NOT NULL,
  `c_largeint` LARGEINT NOT NULL,
  `c_float` FLOAT NOT NULL,
  `c_double` DOUBLE NOT NULL,
  `c_char` CHAR(10) NOT NULL,
  `c_varchar` VARCHAR(100) NOT NULL,
  `c_date` DATE NOT NULL,
  `c_datetime` DATETIME NOT NULL,
  `c_decimal` DECIMAL64(9,3) NOT NULL
) ENGINE=OLAP
DUPLICATE KEY(`c_id`)
DISTRIBUTED BY HASH(`c_id`) BUCKETS 10
PROPERTIES (
 "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO `t_without_null` (
  `c_id`, `c_tinyint`, `c_smallint`, `c_int`, `c_bigint`, `c_largeint`, `c_float`, `c_double`, `c_char`, `c_varchar`, `c_date`, `c_datetime`, `c_decimal`) 
VALUES 
  (1, 1, 11, 111, 1111, 11111, 1.1, 11.11, 'char1', 'varchar1', '2021-01-01', '2021-01-01 00:00:00', 111.11),
  (2, 1, 11, 111, 1111, 11111, 1.1, 11.11, 'char1', 'varchar1', '2021-01-01', '2021-01-01 00:00:00', 111.11),
  (3, 1, 11, 111, 1111, 11111, 1.1, 11.11, 'char1', 'varchar1', '2021-01-01', '2021-01-01 00:00:00', 111.11),
  (4, 1, 11, 111, 1111, 11111, 1.1, 11.11, 'char1', 'varchar1', '2021-01-01', '2021-01-01 00:00:00', 111.11),
  (5, 1, 11, 111, 1111, 11111, 1.1, 11.11, 'char1', 'varchar1', '2021-01-01', '2021-01-01 00:00:00', 111.11),

  (11, 2, 22, 222, 2222, 22222, 2.2, 22.22, 'char2', 'varchar2', '2021-01-02', '2021-01-02 00:00:00', 222.22),
  (12, 2, 22, 222, 2222, 22222, 2.2, 22.22, 'char2', 'varchar2', '2021-01-02', '2021-01-02 00:00:00', 222.22),
  (13, 2, 22, 222, 2222, 22222, 2.2, 22.22, 'char2', 'varchar2', '2021-01-02', '2021-01-02 00:00:00', 222.22),

  (21, 3, 33, 333, 3333, 33333, 3.3, 33.33, 'char3', 'varchar3', '2021-01-03', '2021-01-03 00:00:00', 333.33),
  (22, 3, 33, 333, 3333, 33333, 3.3, 33.33, 'char3', 'varchar3', '2021-01-03', '2021-01-03 00:00:00', 333.33),

  (31, 4, 44, 444, 4444, 44444, 4.4, 44.44, 'char4', 'varchar4', '2021-01-04', '2021-01-04 00:00:00', 444.44),

  (91, 10, 100, 1000, 10000, 100000, 1.01, 100.01, 'char10', 'varchar10', '2021-01-10', '2021-01-10 00:00:00', 1000.01);
-- result:
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_tinyint, 3) FROM t_without_null;
-- result:
[10,4,3]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_smallint, 3) FROM t_without_null;
-- result:
[100,44,33]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_int, 3) FROM t_without_null;
-- result:
[1000,444,333]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_bigint, 3) FROM t_without_null;
-- result:
[10000,4444,3333]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_largeint, 3) FROM t_without_null;
-- result:
[100000,44444,33333]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_float, 3) FROM t_without_null;
-- result:
[3.3,3.3,2.2]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_double, 3) FROM t_without_null;
-- result:
[100.01,44.44,33.33]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_char, 3) FROM t_without_null;
-- result:
["char4","char3","char3"]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_varchar, 3) FROM t_without_null;
-- result:
["varchar4","varchar3","varchar3"]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_date, 3) FROM t_without_null;
-- result:
["2021-01-10","2021-01-04","2021-01-03"]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_datetime, 3) FROM t_without_null;
-- result:
["2021-01-10 00:00:00","2021-01-04 00:00:00","2021-01-03 00:00:00"]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_decimal, 3) FROM t_without_null;
-- result:
[1000.010,444.440,333.330]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_tinyint, 1) FROM t_without_null;
-- result:
[10]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_smallint, 1) FROM t_without_null;
-- result:
[100]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_int, 1) FROM t_without_null;
-- result:
[1000]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_streaming')*/ MAX_N(c_tinyint, 5) FROM t_without_null;
-- result:
[10,4,3,3,2]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='auto')*/ MAX_N(c_smallint, 5) FROM t_without_null;
-- result:
[100,44,33,33,22]
-- !result
SELECT /*+ SET_VAR(streaming_preaggregation_mode='force_preaggregation')*/ MAX_N(c_int, 5) FROM t_without_null;
-- result:
[1000,444,333,333,222]
-- !result
-- name: test_max_n_const
SELECT MAX_N(col1, 3) FROM (VALUES (1)) AS tmp(col1);
-- result:
[1]
-- !result
SELECT MAX_N(col1, 3) FROM (VALUES (1),(2),(3),(4),(5),(6)) AS tmp(col1);
-- result:
[6,5,4]
-- !result
SELECT MAX_N(1, 3);
-- result:
[1]
-- !result