-- name: test_mv_rewrite_bugfix3
create database db_${uuid0};
-- result:
-- !result
use db_${uuid0};
-- result:
-- !result
CREATE TABLE supplier_char(
 s_suppkey     INTEGER NOT NULL,
 s_name        CHAR(25) NOT NULL,
 s_address     CHAR(40), 
 s_nationkey   INTEGER NOT NULL,
 s_phone       CHAR(15) NOT NULL,
 s_acctbal     double NOT NULL,
 s_comment     CHAR(101) NOT NULL,
 pad char(1) NOT NULL)
DUPLICATE KEY(`s_suppkey`)
DISTRIBUTED BY HASH(`s_suppkey`) BUCKETS 1
PROPERTIES (
"replication_num" = "1"
);
-- result:
-- !result
INSERT INTO supplier_char VALUES (1, 'name1', 'address1', 1, 'phone1', 1.0, 'comment1', 'p'),
(2, 'name2', 'address2', 2, 'phone2', 2.0, 'comment2', 'p'),
(3, 'name3', 'address3', 3, 'phone3', 3.0, 'comment3', 'p'),
(4, 'name4', 'address4', 4, 'phone4', 4.0, 'comment4', 'p'),
(5, 'name5', 'address5', 5, 'phone5', 5.0, 'comment5', 'p'),
(6, 'name6', 'address6', 6, 'phone6', 6.0, 'comment6', 'p'),
(7, 'name7', 'address7', 7, 'phone7', 7.0, 'comment7', 'p'),
(8, 'name8', 'address8', 8, 'phone8', 8.0, 'comment8', 'p'),
(9, 'name9', 'address9', 9, 'phone9', 9.0, 'comment9', 'p'),
(10, 'name10', 'address10', 10, 'phone10', 10.0, 'comment10', 'p');
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv1
DISTRIBUTED BY RANDOM
PROPERTIES (
"replication_num" = "1"
)
AS select s_nationkey, s_name, bitmap_agg(s_suppkey), sum(s_nationkey) from supplier_char group by 
s_nationkey, s_name;
-- result:
-- !result
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
[UC] analyze full table supplier_char;
-- result:
db_611c78b427b640e2b3e00e6241768903.supplier_char	analyze	status	OK
-- !result
[UC] analyze full table test_mv1;
-- result:
db_611c78b427b640e2b3e00e6241768903.test_mv1	analyze	status	OK
-- !result
function: wait_global_dict_ready('s_name', 'supplier_char')
-- result:

-- !result
function: wait_global_dict_ready('s_name', 'test_mv1')
-- result:

-- !result
select s_nationkey, s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_nationkey, s_name order by 1,2;
-- result:
1	name1	1	1
2	name2	1	2
3	name3	1	3
4	name4	1	4
5	name5	1	5
6	name6	1	6
7	name7	1	7
8	name8	1	8
9	name9	1	9
10	name10	1	10
-- !result
select s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_name order by 1,2;
-- result:
name1	1	1
name10	1	10
name2	1	2
name3	1	3
name4	1	4
name5	1	5
name6	1	6
name7	1	7
name8	1	8
name9	1	9
-- !result
select s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_name having sum(s_nationkey) > 10 order by 1,2;
-- result:
-- !result
function: print_hit_materialized_views("select s_nationkey, s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_nationkey, s_name order by 1,2;")
-- result:
test_mv1
-- !result
function: print_hit_materialized_views("select s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_name order by 1,2;")
-- result:
test_mv1
-- !result
function: print_hit_materialized_views("select s_name, count(distinct s_suppkey), sum(s_nationkey) from supplier_char group by s_name having sum(s_nationkey) > 10 order by 1,2;")
-- result:
test_mv1
-- !result
drop materialized view test_mv1;
-- result:
-- !result
drop database db_${uuid0};
-- result:
-- !result