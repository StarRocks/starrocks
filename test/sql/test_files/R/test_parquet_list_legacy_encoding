-- name: test_parquet_list_legacy_encoding

create database db_${uuid0};
use db_${uuid0};

shell: ossutil64 mkdir oss://${oss_bucket}/test_files/parquet_format/${uuid0} >/dev/null || echo "exit 0" >/dev/null

shell: ossutil64 cp --force ./sql/test_files/parquet_format/list_legacy_encoding.parquet oss://${oss_bucket}/test_files/parquet_format/${uuid0}/ | grep -Pv "(average|elapsed)"
-- result:
0

Succeed: Total num: 1, size: 2,796. OK num: 1(upload 1 files).
-- !result

shell: ossutil64 cp --force ./sql/test_files/parquet_format/list_legacy_encoding_nested.parquet oss://${oss_bucket}/test_files/parquet_format/${uuid0}/ | grep -Pv "(average|elapsed)"
-- result:
0

Succeed: Total num: 1, size: 539. OK num: 1(upload 1 files).
-- !result

shell: ossutil64 cp --force ./sql/test_files/parquet_format/list_legacy_encoding_complex.parquet oss://${oss_bucket}/test_files/parquet_format/${uuid0}/ | grep -Pv "(average|elapsed)"
-- result:
0

Succeed: Total num: 1, size: 9,665. OK num: 1(upload 1 files).
-- !result


desc files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
field1	struct<list1 array<varchar(1048576)>>	YES
-- !result

select count(*) from files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
100
-- !result


desc files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding_nested.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
a	array<array<int>>	YES
-- !result

select * from files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding_nested.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
[[1,2],[3,4]]
-- !result


desc files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding_complex.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
field1	struct<list1 array<varchar(1048576)>, list2 array<array<varchar(1048576)>>, map1 map<varchar(1048576),array<varchar(1048576)>>>	YES
-- !result

select count(*) from files(
    "path" = "oss://${oss_bucket}/test_files/parquet_format/${uuid0}/list_legacy_encoding_complex.parquet",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
100
-- !result


shell: ossutil64 rm -rf oss://${oss_bucket}/test_files/parquet_format/${uuid0}/ > /dev/null
