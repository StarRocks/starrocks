-- name: test_parquet_variant_write

create database db_${uuid0};
use db_${uuid0};

shell: ossutil64 mkdir oss://${oss_bucket}/test_files/parquet_variant/${uuid0}/input >/dev/null || echo "exit 0" >/dev/null
shell: ossutil64 mkdir oss://${oss_bucket}/test_files/parquet_variant/${uuid0}/output >/dev/null || echo "exit 0" >/dev/null

shell: ossutil64 cp ./sql/test_iceberg/data/variant_query_0/data/00000-0-968ed6e2-3543-431b-ba6c-b41704fb5cd7-0-00001.parquet oss://${oss_bucket}/test_files/parquet_variant/${uuid0}/input/ > /dev/null

insert into files(
    "path" = "s3://${oss_bucket}/test_files/parquet_variant/${uuid0}/output/",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}")
select
    case_id,
    variant_from_int,
    variant_from_string,
    variant_from_array,
    variant_mixed
from files(
    "path" = "s3://${oss_bucket}/test_files/parquet_variant/${uuid0}/input/*",
    "format" = "parquet",
    "aws.s3.access_key" = "${oss_ak}",
    "aws.s3.secret_key" = "${oss_sk}",
    "aws.s3.endpoint" = "${oss_endpoint}");
-- result:
-- !result

select 'variant parquet write round trip' as test_name;
-- result:
variant parquet write round trip
-- !result

with src as (
    select
        case_id,
        get_variant_int(variant_from_int, '$') as v_int,
        get_variant_string(variant_from_string, '$') as v_str,
        get_variant_double(variant_from_array, '$[0]') as v_arr0,
        get_variant_string(variant_mixed, '$.tags[0]') as v_tag0
    from files(
        "path" = "s3://${oss_bucket}/test_files/parquet_variant/${uuid0}/input/*",
        "format" = "parquet",
        "aws.s3.access_key" = "${oss_ak}",
        "aws.s3.secret_key" = "${oss_sk}",
        "aws.s3.endpoint" = "${oss_endpoint}")
), dst as (
    select
        case_id,
        get_variant_int(variant_from_int, '$') as v_int,
        get_variant_string(variant_from_string, '$') as v_str,
        get_variant_double(variant_from_array, '$[0]') as v_arr0,
        get_variant_string(variant_mixed, '$.tags[0]') as v_tag0
    from files(
        "path" = "s3://${oss_bucket}/test_files/parquet_variant/${uuid0}/output/*",
        "format" = "parquet",
        "aws.s3.access_key" = "${oss_ak}",
        "aws.s3.secret_key" = "${oss_sk}",
        "aws.s3.endpoint" = "${oss_endpoint}")
)
select case when count(*) = sum(
    case when
        ((src.v_int = dst.v_int) or (src.v_int is null and dst.v_int is null))
        and ((src.v_str = dst.v_str) or (src.v_str is null and dst.v_str is null))
        and ((src.v_arr0 = dst.v_arr0) or (src.v_arr0 is null and dst.v_arr0 is null))
        and ((src.v_tag0 = dst.v_tag0) or (src.v_tag0 is null and dst.v_tag0 is null))
    then 1 else 0 end
) then 'PASS' else 'FAIL' end as result
from src join dst using(case_id);
-- result:
PASS
-- !result

shell: ossutil64 rm -rf oss://${oss_bucket}/test_files/parquet_variant/${uuid0}/ > /dev/null
