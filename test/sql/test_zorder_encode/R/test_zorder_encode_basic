-- name: test_zorder_encode_basic
CREATE DATABASE test_zorder_encode_basic;
-- result:
-- !result
USE test_zorder_encode_basic;
-- result:
-- !result
CREATE TABLE points2d (
  id INT NOT NULL,
  x  INT,
  y  INT,
  zkey VARBINARY(1024) AS (encode_zorder_key(x, y))
) ENGINE=OLAP
DISTRIBUTED BY HASH(id) BUCKETS 1
ORDER BY (zkey)
PROPERTIES ("replication_num" = "1");
-- result:
-- !result
set enable_profile = true;
-- result:
-- !result
set enable_async_profile = false;
-- result:
-- !result
create view profile_filter_rows as
select trim(unnest) 
from table(unnest(split(get_query_profile(last_query_id()), '\n')))
where unnest like '%FilterRows%'
order by unnest;
-- result:
-- !result
INSERT INTO points2d (id, x, y)
SELECT 
  row_number() OVER (ORDER BY rand()) as id,
  100 + (row_number() OVER (ORDER BY rand()) % 200) as x,
  100 + (row_number() OVER (ORDER BY rand()) % 200) as y
FROM table(generate_series(1, 200000));
-- result:
-- !result
INSERT INTO points2d (id, x, y)
SELECT 
  200000 + row_number() OVER (ORDER BY rand()) as id,
  1000 + (row_number() OVER (ORDER BY rand()) % 200) as x,
  1000 + (row_number() OVER (ORDER BY rand()) % 200) as y
FROM table(generate_series(1, 200000));
-- result:
-- !result
INSERT INTO points2d (id, x, y)
SELECT 
  400000 + row_number() OVER (ORDER BY rand()) as id,
  5000 + (row_number() OVER (ORDER BY rand()) % 200) as x,
  5000 + (row_number() OVER (ORDER BY rand()) % 200) as y
FROM table(generate_series(1, 200000));
-- result:
-- !result
INSERT INTO points2d (id, x, y)
SELECT 
  600000 + row_number() OVER (ORDER BY rand()) as id,
  8000 + (row_number() OVER (ORDER BY rand()) % 200) as x,
  8000 + (row_number() OVER (ORDER BY rand()) % 200) as y
FROM table(generate_series(1, 200000));
-- result:
-- !result
INSERT INTO points2d (id, x, y)
SELECT 
  800000 + row_number() OVER (ORDER BY rand()) as id,
  100 + (row_number() OVER (ORDER BY rand()) % 9000) as x,
  100 + (row_number() OVER (ORDER BY rand()) % 9000) as y
FROM table(generate_series(1, 200000));
-- result:
-- !result
SELECT count(*) FROM points2d WHERE x = 1000;
-- result:
1023
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 411.969K (411969)
-- !result
SELECT count(*) FROM points2d WHERE y = 1000;
-- result:
1023
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 411.969K (411969)
-- !result
SELECT count(*) FROM points2d WHERE x = 1000 and y = 1000;
-- result:
1
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 412.991K (412991)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 95 AND 105 AND y BETWEEN 95 AND 105;
-- result:
198
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 412.794K (412794)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 995 AND 1005 AND y BETWEEN 995 AND 1005;
-- result:
155
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 412.837K (412837)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 4995 AND 5005 AND y BETWEEN 4995 AND 5005;
-- result:
169
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 412.823K (412823)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 7995 AND 8005 AND y BETWEEN 7995 AND 8005;
-- result:
165
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 589.824K (589824)
- DelVecFilterRows: 0
- PredFilterRows: 410.011K (410011)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 90 AND 210 AND y BETWEEN 90 AND 210;
-- result:
61474
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 351.518K (351518)
-- !result
SELECT count(*) FROM points2d WHERE x BETWEEN 990 AND 1110 AND y BETWEEN 990 AND 1110;
-- result:
61737
-- !result
select * from profile_filter_rows;
-- result:
- BitmapIndexFilterRows: 0
- BloomFilterFilterRows: 0
- GinFilterRows: 0
- SegmentRuntimeZoneMapFilterRows: 0
- SegmentZoneMapFilterRows: 0
- ShortKeyFilterRows: 0
- VectorIndexFilterRows: 0
- ZoneMapIndexFilterRows: 587.008K (587008)
- DelVecFilterRows: 0
- PredFilterRows: 351.255K (351255)
-- !result