-- name: test_load_cancel_reason_root_cause @sequential
-- Test that when load channel is cancelled, the root cause (cancel reason) is reported
-- instead of "no associated load channel" error

create database db_${uuid0};
use db_${uuid0};

CREATE TABLE `t`
(
    `id` int(11) NOT NULL ,
    `name` varchar(65533) NULL ,
    `score` int(11) NOT NULL 
)
ENGINE=OLAP
PRIMARY KEY(`id`)
DISTRIBUTED BY HASH(`id`);

-- Enable failpoint to trigger error during add_chunks, which will cause cancel request
-- with reason to be sent. This simulates OOM or other errors that trigger cancel.
ADMIN ENABLE FAILPOINT 'load_tablet_writer_add_chunks';
-- Insert data, which will trigger the failpoint and cause cancel request with reason
insert into t WITH LABEL label_${uuid1} values (1, 'n1', 1);
ADMIN DISABLE FAILPOINT 'load_tablet_writer_add_chunks';
sync;

-- Verify that the error message 
select state, instr(error_msg, 'load_tablet_writer_add_chunks failpoint triggered failure') > 0 from information_schema.loads where label='label_${uuid1}';
select * from t;


-- Simulate an error at the receiver side
ADMIN ENABLE FAILPOINT 'load_memtable_flush';
insert into t WITH LABEL label_${uuid2} values (1, 'n1', 1);
-- Verify that the error message 
select state, instr(error_msg, 'load_memtable_flush failpoint triggered failure') > 0 from information_schema.loads where label='label_${uuid2}';
ADMIN DISABLE FAILPOINT 'load_memtable_flush';