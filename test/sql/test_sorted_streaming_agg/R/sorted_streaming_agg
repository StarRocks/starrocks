-- name: test_sorted_streaming_agg
set enable_sort_aggregate=true;
-- result:
-- !result
create table t0(
    c0 INT,
    c1 BIGINT,
    c2 STRING
) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 3 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t0 values(1, 1, 's1'), (1, 2, 's0'), (1, 1, 's1');
-- result:
-- !result
insert into t0 values(2, 2, 's2'), (3, 3, 's3');
-- result:
-- !result
insert into t0 values(3, 3, 's3'), (3, 4, 's4'), (3, 3, 's5'), (4, 4, 's6');
-- result:
-- !result
insert into t0 select * from t0;
-- result:
-- !result
select c0 from t0 group by c0 order by c0;
-- result:
1
2
3
4
-- !result
select c0, sum(c1), count(*) from t0 group by c0 order by c0;
-- result:
1	8	6
2	4	2
3	26	8
4	8	2
-- !result
select c0, sum(c1), max(c2), count(*) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0, sum(c1), max(c2), count(1) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0 from t0 group by c0 order by c0;
-- result:
1
2
3
4
-- !result
create table t1(
    c0 INT NULL,
    c1 BIGINT NULL,
    c2 STRING NULL
) DUPLICATE KEY(c0, c1) DISTRIBUTED BY HASH(c0) BUCKETS 1 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t1 select * from t0;
-- result:
-- !result
insert into t1 values(null, 1, 's1'), (null, 1, 's2'), (1, null, 's0'), (1, null, 's2'), (null, null, null);
-- result:
-- !result
select c0 from t0 group by c0 order by c0;
-- result:
1
2
3
4
-- !result
select c0, sum(c1), count(*) from t0 group by c0 order by c0;
-- result:
1	8	6
2	4	2
3	26	8
4	8	2
-- !result
select c0, sum(c1), max(c2), count(*) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0, sum(c1), max(c2), count(1) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0, c1, sum(c1) from t0 group by c0, c1 order by c0, c1;
-- result:
1	1	4
1	2	4
2	2	4
3	3	18
3	4	8
4	4	8
-- !result
select c0 from t1 group by c0 order by c0;
-- result:
None
1
2
3
4
-- !result
select c0, c1 from t1 group by c0, c1 order by c0, c1;
-- result:
None	None
None	1
1	None
1	1
1	2
2	2
3	3
3	4
4	4
-- !result
select c0, c1, array_sort(array_agg(c2)) from t1 group by c0, c1 order by c0, c1;
-- result:
None	None	[null]
None	1	["s1","s2"]
1	None	["s0","s2"]
1	1	["s1","s1","s1","s1"]
1	2	["s0","s0"]
2	2	["s2","s2"]
3	3	["s3","s3","s3","s3","s5","s5"]
3	4	["s4","s4"]
4	4	["s6","s6"]
-- !result
create table t2(
    c0 STRING NULL,
    c1 STRING NULL,
    c2 STRING NULL
) DUPLICATE KEY(c0, c1) DISTRIBUTED BY HASH(c0) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t1 select * from t0;
-- result:
-- !result
select c0 from t0 group by c0 order by c0;
-- result:
1
2
3
4
-- !result
select c0, sum(c1), count(*) from t0 group by c0 order by c0;
-- result:
1	8	6
2	4	2
3	26	8
4	8	2
-- !result
select c0, sum(c1), max(c2), count(*) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0, sum(c1), max(c2), count(1) from t0 group by c0 order by c0;
-- result:
1	8	s1	6
2	4	s2	2
3	26	s5	8
4	8	s6	2
-- !result
select c0, c1, sum(c1) from t0 group by c0, c1 order by c0, c1;
-- result:
1	1	4
1	2	4
2	2	4
3	3	18
3	4	8
4	4	8
-- !result
select c0 from t1 group by c0 order by c0;
-- result:
None
1
2
3
4
-- !result
select c0, c1 from t1 group by c0, c1 order by c0, c1;
-- result:
None	None
None	1
1	None
1	1
1	2
2	2
3	3
3	4
4	4
-- !result
create table t3(
    c0 INT,
    c1 DECIMAL(10,2),
    c2 DECIMAL(15,3),
    c3 STRING
) DUPLICATE KEY(c0, c1) DISTRIBUTED BY HASH(c0) BUCKETS 3 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t3 values(1, 100.50, 1000.123, 'type1');
-- result:
-- !result
insert into t3 values(1, 200.75, 2000.456, 'type2');
-- result:
-- !result
insert into t3 values(1, 100.50, 1000.123, 'type1');
-- result:
-- !result
insert into t3 values(2, 300.25, 3000.789, 'type3');
-- result:
-- !result
insert into t3 values(2, 400.00, 4000.000, 'type4');
-- result:
-- !result
insert into t3 values(3, 500.99, 5000.999, 'type5');
-- result:
-- !result
insert into t3 values(3, 500.99, 5000.999, 'type5');
-- result:
-- !result
select c0, c1, sum(c2), count(*) from t3 group by c0, c1 order by c0, c1;
-- result:
1	100.50	2000.246	2
1	200.75	2000.456	1
2	300.25	3000.789	1
2	400.00	4000.000	1
3	500.99	10001.998	2
-- !result
select c0, sum(c1), avg(c2), max(c3), count(*) from t3 group by c0 order by c0;
-- result:
1	401.75	1333.567333333	type2	3
2	700.25	3500.394500000	type4	2
3	1001.98	5000.999000000	type5	2
-- !result
select c0, c1, c2, count(*) from t3 group by c0, c1, c2 order by c0, c1, c2;
-- result:
1	100.50	1000.123	2
1	200.75	2000.456	1
2	300.25	3000.789	1
2	400.00	4000.000	1
3	500.99	5000.999	2
-- !result
create table t4(
    c0 INT,
    c1 DATETIME,
    c2 DATE,
    c3 STRING
) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t4 values(1, '2023-01-01 10:00:00', '2023-01-01', 'batch1');
-- result:
-- !result
insert into t4 values(1, '2023-01-01 10:00:00', '2023-01-01', 'batch1');
-- result:
-- !result
insert into t4 values(1, '2023-01-02 11:00:00', '2023-01-02', 'batch2');
-- result:
-- !result
insert into t4 values(2, '2023-01-03 12:00:00', '2023-01-03', 'batch3');
-- result:
-- !result
insert into t4 values(2, '2023-01-03 12:00:00', '2023-01-03', 'batch3');
-- result:
-- !result
insert into t4 values(3, '2023-01-04 13:00:00', '2023-01-04', 'batch4');
-- result:
-- !result
select c0, c1, count(*) from t4 group by c0, c1 order by c0, c1;
-- result:
1	2023-01-01 10:00:00	2
1	2023-01-02 11:00:00	1
2	2023-01-03 12:00:00	2
3	2023-01-04 13:00:00	1
-- !result
select c0, c2, count(*), max(c3) from t4 group by c0, c2 order by c0, c2;
-- result:
1	2023-01-01	2	batch1
1	2023-01-02	1	batch2
2	2023-01-03	2	batch3
3	2023-01-04	1	batch4
-- !result
select c0, min(c1), max(c1), count(*) from t4 group by c0 order by c0;
-- result:
1	2023-01-01 10:00:00	2023-01-02 11:00:00	3
2	2023-01-03 12:00:00	2023-01-03 12:00:00	2
3	2023-01-04 13:00:00	2023-01-04 13:00:00	1
-- !result
create table t5(
    c0 INT,
    c1 BOOLEAN,
    c2 BOOLEAN,
    c3 STRING
) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t5 values(1, true, false, 'status1');
-- result:
-- !result
insert into t5 values(1, true, true, 'status2');
-- result:
-- !result
insert into t5 values(1, false, false, 'status3');
-- result:
-- !result
insert into t5 values(2, true, false, 'status4');
-- result:
-- !result
insert into t5 values(2, false, true, 'status5');
-- result:
-- !result
insert into t5 values(3, true, true, 'status6');
-- result:
-- !result
select c0, c1, count(*) from t5 group by c0, c1 order by c0, c1;
-- result:
1	0	1
1	1	2
2	0	1
2	1	1
3	1	1
-- !result
select c0, c1, c2, count(*) from t5 group by c0, c1, c2 order by c0, c1, c2;
-- result:
1	0	0	1
1	1	0	1
1	1	1	1
2	0	1	1
2	1	0	1
3	1	1	1
-- !result
select c0, sum(case when c1 then 1 else 0 end) as true_count, count(*) from t5 group by c0 order by c0;
-- result:
1	2	3
2	1	2
3	1	1
-- !result
create table t6(
    c0 INT,
    c1 FLOAT,
    c2 DOUBLE,
    c3 STRING
) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 3 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t6 values(1, 1.5, 1.123456789, 'float1');
-- result:
-- !result
insert into t6 values(1, 2.5, 2.234567890, 'float2');
-- result:
-- !result
insert into t6 values(1, 1.5, 1.123456789, 'float1');
-- result:
-- !result
insert into t6 values(2, 3.5, 3.345678901, 'float3');
-- result:
-- !result
insert into t6 values(2, 4.5, 4.456789012, 'float4');
-- result:
-- !result
insert into t6 values(3, 5.5, 5.567890123, 'float5');
-- result:
-- !result
select c0, c1, sum(c2), count(*) from t6 group by c0, c1 order by c0, c1;
-- result:
1	1.5	2.246913578	2
1	2.5	2.23456789	1
2	3.5	3.345678901	1
2	4.5	4.456789012	1
3	5.5	5.567890123	1
-- !result
select c0, avg(c1), avg(c2), count(*) from t6 group by c0 order by c0;
-- result:
1	1.8333333333333333	1.493827156	3
2	4.0	3.9012339564999996	2
3	5.5	5.567890123	1
-- !result
select c0, c1, c2, count(*) from t6 group by c0, c1, c2 order by c0, c1, c2;
-- result:
1	1.5	1.123456789	2
1	2.5	2.23456789	1
2	3.5	3.345678901	1
2	4.5	4.456789012	1
3	5.5	5.567890123	1
-- !result
create table t7(
    c0 INT,
    c1 LARGEINT,
    c2 STRING
) DUPLICATE KEY(c0, c1) DISTRIBUTED BY HASH(c0) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t7 values(1, 9223372036854775807, 'large1');
-- result:
-- !result
insert into t7 values(1, 9223372036854775806, 'large2');
-- result:
-- !result
insert into t7 values(1, 9223372036854775807, 'large1');
-- result:
-- !result
insert into t7 values(2, 9223372036854775805, 'large3');
-- result:
-- !result
insert into t7 values(2, 9223372036854775804, 'large4');
-- result:
-- !result
insert into t7 values(3, 9223372036854775803, 'large5');
-- result:
-- !result
select c0, c1, count(*) from t7 group by c0, c1 order by c0, c1;
-- result:
1	9223372036854775806	1
1	9223372036854775807	2
2	9223372036854775804	1
2	9223372036854775805	1
3	9223372036854775803	1
-- !result
select c0, sum(c1), count(*) from t7 group by c0 order by c0;
-- result:
1	27670116110564327420	3
2	18446744073709551609	2
3	9223372036854775803	1
-- !result
select c0, c1, max(c2), count(*) from t7 group by c0, c1 order by c0, c1;
-- result:
1	9223372036854775806	large2	1
1	9223372036854775807	large1	2
2	9223372036854775804	large4	1
2	9223372036854775805	large3	1
3	9223372036854775803	large5	1
-- !result
create table t8(
    c0 INT,
    c1 VARCHAR(50),
    c2 VARCHAR(100),
    c3 STRING
) DUPLICATE KEY(c0, c1) DISTRIBUTED BY HASH(c0) BUCKETS 3 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t8 values(1, 'varchar1', 'longer_varchar1', 'string1');
-- result:
-- !result
insert into t8 values(1, 'varchar2', 'longer_varchar2', 'string2');
-- result:
-- !result
insert into t8 values(1, 'varchar1', 'longer_varchar1', 'string1');
-- result:
-- !result
insert into t8 values(2, 'varchar3', 'longer_varchar3', 'string3');
-- result:
-- !result
insert into t8 values(2, 'varchar4', 'longer_varchar4', 'string4');
-- result:
-- !result
insert into t8 values(3, 'varchar5', 'longer_varchar5', 'string5');
-- result:
-- !result
select c0, c1, count(*) from t8 group by c0, c1 order by c0, c1;
-- result:
1	varchar1	2
1	varchar2	1
2	varchar3	1
2	varchar4	1
3	varchar5	1
-- !result
select c0, c1, c2, count(*) from t8 group by c0, c1, c2 order by c0, c1, c2;
-- result:
1	varchar1	longer_varchar1	2
1	varchar2	longer_varchar2	1
2	varchar3	longer_varchar3	1
2	varchar4	longer_varchar4	1
3	varchar5	longer_varchar5	1
-- !result
select c0, max(c1), max(c2), count(*) from t8 group by c0 order by c0;
-- result:
1	varchar2	longer_varchar2	3
2	varchar4	longer_varchar4	2
3	varchar5	longer_varchar5	1
-- !result
create table t9(
    c1 STRING,
    c0 INT,
    c2 DECIMAL(10,2),
    c3 DATETIME,
    c4 BOOLEAN
) DUPLICATE KEY(c1, c0) DISTRIBUTED BY HASH(c1) BUCKETS 3 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t9 values('group1', 1, 100.50, '2023-01-01 10:00:00', true);
-- result:
-- !result
insert into t9 values('group1', 1, 100.50, '2023-01-01 10:00:00', true);
-- result:
-- !result
insert into t9 values('group1', 1, 200.75, '2023-01-01 11:00:00', false);
-- result:
-- !result
insert into t9 values('group2', 1, 300.25, '2023-01-02 10:00:00', true);
-- result:
-- !result
insert into t9 values('group3', 2, 400.00, '2023-01-03 10:00:00', false);
-- result:
-- !result
insert into t9 values('group3', 2, 500.99, '2023-01-03 11:00:00', true);
-- result:
-- !result
insert into t9 values('group4', 3, 600.50, '2023-01-04 10:00:00', true);
-- result:
-- !result
select c1, c0, c2, count(*) from t9 group by c1, c0, c2 order by c1, c0, c2;
-- result:
group1	1	100.50	2
group1	1	200.75	1
group2	1	300.25	1
group3	2	400.00	1
group3	2	500.99	1
group4	3	600.50	1
-- !result
select c1, c0, sum(c2), count(*) from t9 group by c1, c0 order by c1, c0;
-- result:
group1	1	401.75	3
group2	1	300.25	1
group3	2	900.99	2
group4	3	600.50	1
-- !result
select c1, c0, c2, c3, count(*) from t9 group by c1, c0, c2, c3 order by c1, c0, c2, c3;
-- result:
group1	1	100.50	2023-01-01 10:00:00	2
group1	1	200.75	2023-01-01 11:00:00	1
group2	1	300.25	2023-01-02 10:00:00	1
group3	2	400.00	2023-01-03 10:00:00	1
group3	2	500.99	2023-01-03 11:00:00	1
group4	3	600.50	2023-01-04 10:00:00	1
-- !result
select c1, c0, c2, c4, count(*) from t9 group by c1, c0, c2, c4 order by c1, c0, c2, c4;
-- result:
group1	1	100.50	1	2
group1	1	200.75	0	1
group2	1	300.25	1	1
group3	2	400.00	0	1
group3	2	500.99	1	1
group4	3	600.50	1	1
-- !result
create table t10(
    c1 STRING NULL,
    c0 INT NULL,
    c2 DECIMAL(10,2) NULL,
    c3 DATETIME NULL
) DUPLICATE KEY(c1, c0) DISTRIBUTED BY HASH(c1) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t10 values('valid1', 1, 100.50, '2023-01-01 10:00:00');
-- result:
-- !result
insert into t10 values(null, 1, 200.75, '2023-01-01 11:00:00');
-- result:
-- !result
insert into t10 values('valid1', 1, null, '2023-01-01 12:00:00');
-- result:
-- !result
insert into t10 values('valid1', 1, 100.50, null);
-- result:
-- !result
insert into t10 values('valid2', null, 300.25, '2023-01-02 10:00:00');
-- result:
-- !result
insert into t10 values('valid3', 2, null, null);
-- result:
-- !result
insert into t10 values(null, null, null, null);
-- result:
-- !result
select c1, c0, count(*) from t10 group by c1, c0 order by c1, c0;
-- result:
None	None	1
None	1	1
valid1	1	3
valid2	None	1
valid3	2	1
-- !result
select c1, c0, c2, count(*) from t10 group by c1, c0, c2 order by c1, c0, c2;
-- result:
None	None	None	1
None	1	200.75	1
valid1	1	None	1
valid1	1	100.50	2
valid2	None	300.25	1
valid3	2	None	1
-- !result
select c1, c0, c2, c3, count(*) from t10 group by c1, c0, c2, c3 order by c1, c0, c2, c3;
-- result:
None	None	None	None	1
None	1	200.75	2023-01-01 11:00:00	1
valid1	1	None	2023-01-01 12:00:00	1
valid1	1	100.50	None	1
valid1	1	100.50	2023-01-01 10:00:00	1
valid2	None	300.25	2023-01-02 10:00:00	1
valid3	2	None	None	1
-- !result
create table t11(
    c0 INT,
    c1 STRING,
    c2 INT
) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 2 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into t11 values(1, 'single1', 100);
-- result:
-- !result
insert into t11 values(2, 'single2', 200);
-- result:
-- !result
insert into t11 values(3, 'single3', 300);
-- result:
-- !result
select c0, c1, c2, count(*) from t11 group by c0, c1, c2 order by c0, c1, c2;
-- result:
1	single1	100	1
2	single2	200	1
3	single3	300	1
-- !result
select c0, sum(c2), count(*) from t11 group by c0 order by c0;
-- result:
1	100	1
2	200	1
3	300	1
-- !result
select c0, c1, sum(c2), count(*) from t11 group by c0, c1 order by c0, c1;
-- result:
1	single1	100	1
2	single2	200	1
3	single3	300	1
-- !result