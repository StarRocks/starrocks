-- name: test_create_materialized_view
create database test_create_mv;
-- result:
-- !result
use test_create_mv;
-- result:
-- !result
CREATE TABLE `t_hash` (
  `k1` int(11) NULL COMMENT "",
  `v1` int(11) NULL COMMENT "",
  `v2` int(11) NULL COMMENT ""
)
DUPLICATE KEY(`k1`) 
DISTRIBUTED BY hash(k1) BUCKETS 64
PROPERTIES ( "replication_num" = "1");
-- result:
-- !result
CREATE TABLE `t_random` (
  `k1` int(11) NULL COMMENT "",
  `v1` int(11) NULL COMMENT "",
  `v2` int(11) NULL COMMENT ""
)
DUPLICATE KEY(`k1`) 
DISTRIBUTED BY RANDOM BUCKETS 64
PROPERTIES ( "replication_num" = "1");
-- result:
-- !result
CREATE TABLE `t1` (
  `k1` int(11) NULL COMMENT "",
  `v1` int(11) NULL COMMENT "",
  `v2` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`k1`)
COMMENT "OLAP"
PARTITION BY RANGE(`k1`) (
    PARTITION p2 VALUES [("202301"), ("202302")),
    PARTITION p3 VALUES [("202302"), ("202303")),
    PARTITION p4 VALUES [("202303"), ("202304")),
    PARTITION p5 VALUES [("202304"), ("202305")),
    PARTITION p6 VALUES [("202305"), ("202306"))
)
DISTRIBUTED BY HASH(`k1`) BUCKETS 2
PROPERTIES ( "replication_num" = "1");
-- result:
-- !result
CREATE TABLE `t2` (
  `k1` int(11) NULL COMMENT "",
  `v1` int(11) NULL COMMENT "",
  `v2` int(11) NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`k1`)
COMMENT "OLAP"
PARTITION BY RANGE(`k1`) (
    PARTITION p2 VALUES [("202301"), ("202302")),
    PARTITION p3 VALUES [("202302"), ("202303")),
    PARTITION p4 VALUES [("202303"), ("202304")),
    PARTITION p5 VALUES [("202304"), ("202305")),
    PARTITION p6 VALUES [("202305"), ("202306"))
)
DISTRIBUTED BY HASH(`k1`) BUCKETS 2
PROPERTIES ( "replication_num" = "1");
-- result:
-- !result
CREATE VIEW verify_result AS
SELECT 
  table_schema, table_name,
  array_filter(split(MATERIALIZED_VIEW_DEFINITION, '\n'), 
    line -> line like 'CREATE%' or line like 'REFRESH%' or line like 'AS %') 
    AS mv_query
FROM information_schema.materialized_views
WHERE table_schema = 'test_create_mv';
-- result:
-- !result
CREATE MATERIALIZED VIEW `mv1`
REFRESH ASYNC 
AS
select t0.k1, t1.v1
from t_hash t0 join t_random t1 on t0.k1 = t1.k1;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv1';
-- result:
test_create_mv	mv1	["CREATE MATERIALIZED VIEW `mv1` (`k1`, `v1`)","REFRESH ASYNC","AS select t0.k1, t1.v1"]
-- !result
CREATE MATERIALIZED VIEW `mv2`
REFRESH ASYNC 
AS
select k1, count(v1)  from t_random group by k1;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv2';
-- result:
test_create_mv	mv2	["CREATE MATERIALIZED VIEW `mv2` (`k1`, `count(v1)`)","REFRESH ASYNC","AS select k1, count(v1)  from t_random group by k1;"]
-- !result
CREATE MATERIALIZED VIEW `mv3`
REFRESH ASYNC 
AS
select t0.k1, t1.v1
from t_hash t0 join t1 on t0.k1 = t1.k1;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv3';
-- result:
test_create_mv	mv3	["CREATE MATERIALIZED VIEW `mv3` (`k1`, `v1`)","REFRESH ASYNC","AS select t0.k1, t1.v1"]
-- !result
CREATE MATERIALIZED VIEW `mv4`
REFRESH ASYNC 
AS
select t0.k1, t1.v1
from t_random t0 join t1 on t0.k1 = t1.k1;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv4';
-- result:
test_create_mv	mv4	["CREATE MATERIALIZED VIEW `mv4` (`k1`, `v1`)","REFRESH ASYNC","AS select t0.k1, t1.v1"]
-- !result
CREATE MATERIALIZED VIEW `mv_part1`
REFRESH ASYNC 
AS
select t1.k1, t2.v1
from t1 join t2 on t1.k1 = t2.k1;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv_part1';
-- result:
test_create_mv	mv_part1	["CREATE MATERIALIZED VIEW `mv_part1` (`k1`, `v1`)","REFRESH ASYNC","AS select t1.k1, t2.v1"]
-- !result
CREATE MATERIALIZED VIEW `mv5`
PARTITION BY (`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 2
REFRESH ASYNC
PROPERTIES (
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS select k1, v1, v2 from t1
union all
select k1, v1, v2 from t2;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv5';
-- result:
test_create_mv	mv5	["CREATE MATERIALIZED VIEW `mv5` (`k1`, `v1`, `v2`)","REFRESH ASYNC","AS select k1, v1, v2 from t1"]
-- !result
CREATE MATERIALIZED VIEW `mv6`
PARTITION BY (`k1`)
DISTRIBUTED BY RANDOM
REFRESH ASYNC
PROPERTIES (
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS select k1, v1, v2 from t1
union all
select k1, v1, v2 from t2;
-- result:
-- !result
SELECT * FROM verify_result WHERE table_name = 'mv6';
-- result:
test_create_mv	mv6	["CREATE MATERIALIZED VIEW `mv6` (`k1`, `v1`, `v2`)","REFRESH ASYNC","AS select k1, v1, v2 from t1"]
-- !result