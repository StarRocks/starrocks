-- name: test_materialized_view_agg_pushdown_rewrite
CREATE TABLE IF NOT EXISTS `lineorder` (
    `lo_orderkey` int(11) NOT NULL COMMENT "",
    `lo_linenumber` int(11) NOT NULL COMMENT "",
    `lo_custkey` int(11) NOT NULL COMMENT "",
    `lo_partkey` int(11) NOT NULL COMMENT "",
    `lo_suppkey` int(11) NOT NULL COMMENT "",
    `lo_orderdate` date NOT NULL COMMENT "",
    `lo_orderpriority` varchar(16) NOT NULL COMMENT "",
    `lo_shippriority` int(11) NOT NULL COMMENT "",
    `lo_quantity` int(11) NOT NULL COMMENT "",
    `lo_extendedprice` int(11) NOT NULL COMMENT "",
    `lo_ordtotalprice` int(11) NOT NULL COMMENT "",
    `lo_discount` int(11) NOT NULL COMMENT "",
    `lo_revenue` int(11) NOT NULL COMMENT "",
    `lo_supplycost` int(11) NOT NULL COMMENT "",
    `lo_tax` int(11) NOT NULL COMMENT "",
    `lo_commitdate` int(11) NOT NULL COMMENT "",
    `lo_shipmode` varchar(11) NOT NULL COMMENT ""
    ) ENGINE=OLAP
    DUPLICATE KEY(`lo_orderkey`)
    COMMENT "OLAP"
    PARTITION BY RANGE(`lo_orderdate`)
(
    PARTITION p1 VALUES [("1992-01-01"), ("1993-01-01")),
    PARTITION p2 VALUES [("1993-01-01"), ("1994-01-01")),
    PARTITION p3 VALUES [("1994-01-01"), ("1995-01-01")),
    PARTITION p4 VALUES [("1995-01-01"), ("1996-01-01")),
    PARTITION p5 VALUES [("1996-01-01"), ("1997-01-01")),
    PARTITION p6 VALUES [("1997-01-01"), ("1998-01-01")),
    PARTITION p7 VALUES [("1998-01-01"), ("1999-01-01"))
) DISTRIBUTED BY HASH(`lo_orderkey`) BUCKETS 48;
-- result:
-- !result
CREATE TABLE IF NOT EXISTS `customer` (
    `c_custkey` int(11) NOT NULL COMMENT "",
    `c_name` varchar(26) NOT NULL COMMENT "",
    `c_address` varchar(41) NOT NULL COMMENT "",
    `c_city` varchar(11) NOT NULL COMMENT "",
    `c_nation` varchar(16) NOT NULL COMMENT "",
    `c_region` varchar(13) NOT NULL COMMENT "",
    `c_phone` varchar(16) NOT NULL COMMENT "",
    `c_mktsegment` varchar(11) NOT NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`c_custkey`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`c_custkey`) BUCKETS 12;
-- result:
-- !result
CREATE TABLE IF NOT EXISTS `dates` (
    `d_datekey` int(11) NOT NULL COMMENT "",
    `d_date` varchar(20) NOT NULL COMMENT "",
    `d_dayofweek` varchar(10) NOT NULL COMMENT "",
    `d_month` varchar(11) NOT NULL COMMENT "",
    `d_year` int(11) NOT NULL COMMENT "",
    `d_yearmonthnum` int(11) NOT NULL COMMENT "",
    `d_yearmonth` varchar(9) NOT NULL COMMENT "",
    `d_daynuminweek` int(11) NOT NULL COMMENT "",
    `d_daynuminmonth` int(11) NOT NULL COMMENT "",
    `d_daynuminyear` int(11) NOT NULL COMMENT "",
    `d_monthnuminyear` int(11) NOT NULL COMMENT "",
    `d_weeknuminyear` int(11) NOT NULL COMMENT "",
    `d_sellingseason` varchar(14) NOT NULL COMMENT "",
    `d_lastdayinweekfl` int(11) NOT NULL COMMENT "",
    `d_lastdayinmonthfl` int(11) NOT NULL COMMENT "",
    `d_holidayfl` int(11) NOT NULL COMMENT "",
    `d_weekdayfl` int(11) NOT NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`d_datekey`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`d_datekey`) BUCKETS 1;
-- result:
-- !result
CREATE TABLE IF NOT EXISTS `supplier` (
   `s_suppkey` int(11) NOT NULL COMMENT "",
   `s_name` varchar(26) NOT NULL COMMENT "",
   `s_address` varchar(26) NOT NULL COMMENT "",
   `s_city` varchar(11) NOT NULL COMMENT "",
   `s_nation` varchar(16) NOT NULL COMMENT "",
   `s_region` varchar(13) NOT NULL COMMENT "",
   `s_phone` varchar(16) NOT NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`s_suppkey`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`s_suppkey`) BUCKETS 12;
-- result:
-- !result
CREATE TABLE IF NOT EXISTS `part` (
    `p_partkey` int(11) NOT NULL COMMENT "",
    `p_name` varchar(23) NOT NULL COMMENT "",
    `p_mfgr` varchar(7) NOT NULL COMMENT "",
    `p_category` varchar(8) NOT NULL COMMENT "",
    `p_brand` varchar(10) NOT NULL COMMENT "",
    `p_color` varchar(12) NOT NULL COMMENT "",
    `p_type` varchar(26) NOT NULL COMMENT "",
    `p_size` int(11) NOT NULL COMMENT "",
    `p_container` varchar(11) NOT NULL COMMENT ""
) ENGINE=OLAP
DUPLICATE KEY(`p_partkey`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`p_partkey`) BUCKETS 12;
-- result:
-- !result
INSERT INTO lineorder (lo_orderkey, lo_linenumber, lo_custkey, lo_partkey, lo_suppkey
                      , lo_orderdate, lo_orderpriority, lo_shippriority, lo_quantity, lo_extendedprice
                      , lo_ordtotalprice, lo_discount, lo_revenue, lo_supplycost, lo_tax
                      , lo_commitdate, lo_shipmode)
VALUES
    (1, 1, 1, 1, 1, '1993-01-01', 'HIGH', 1, 10, 100, 90, 0, 90, 50, 5, 19930115, 'AIR'),
    (1, 1, 1, 1, 1, '1993-01-01', 'MEDIUM', 1, 10, 100, 90, 0, 90, 50, 5, 19930115, 'AIR'),
    (2, 2, 2, 2, 2, '1994-01-01', 'MEDIUM', 2, 20, 200, 180, 5, 175, 75, 7, 19940116, 'SHIP'),
    (3, 3, 3, 3, 2, '1995-01-01', 'MEDIUM', 2, 20, 200, 180, 5, 175, 75, 7, 19940116, 'SHIP')
;
-- result:
-- !result
INSERT INTO customer (c_custkey, c_name, c_address, c_city, c_nation
    , c_region, c_phone, c_mktsegment)
VALUES
(1, 'Customer1', '123 Main St', 'City1', 'Nation1', 'Region1', '123-456-7890', 'Segment1'),
(2, 'Customer2', '456 Oak St', 'City2', 'Nation2', 'Region2', '987-654-3210', 'Segment2'),
(3, 'Customer3', '789 Pine St', 'City3', 'Nation3', 'Region3', '555-123-4567', 'Segment3');
-- result:
-- !result
INSERT INTO dates (d_datekey, d_date, d_dayofweek, d_month, d_year
  , d_yearmonthnum, d_yearmonth, d_daynuminweek, d_daynuminmonth, d_daynuminyear
  , d_monthnuminyear, d_weeknuminyear, d_sellingseason, d_lastdayinweekfl, d_lastdayinmonthfl
  , d_holidayfl, d_weekdayfl)
VALUES (1, '1993-01-01', 'Wednesday', 'December', 2023, 202312, '2023-12', 3, 7, 341, 12, 49, 'Holiday Season', 0, 0, 1, 1),
(2, '1993-01-02', 'Wednesday', 'December', 2023, 202312, '2023-12', 3, 7, 341, 12, 49, 'Holiday Season', 0, 0, 1, 1),
(3, '1994-01-01', 'Wednesday', 'December', 2023, 202312, '2023-12', 3, 7, 341, 12, 49, 'Holiday Season', 0, 0, 1, 1);
-- result:
-- !result
INSERT INTO supplier (s_suppkey, s_name, s_address, s_city, s_nation, s_region, s_phone)
VALUES (1, 'Supplier1', '123 Main St', 'City1', 'Nation1', 'Region1', '123-456-7890');
-- result:
-- !result
INSERT INTO part (p_partkey, p_name, p_mfgr, p_category, p_brand, p_color, p_type, p_size, p_container)
VALUES (1, 'Part1', 'Manufr1', 'Catey1', 'Brand1', 'Red', 'Type1', 10, 'Container1');
-- result:
-- !result
set enable_materialized_view_agg_pushdown_rewrite=true;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv0 REFRESH MANUAL AS
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union(to_bitmap(LO_REVENUE)), hll_union(hll_hash(LO_REVENUE)), percentile_union(percentile_hash(LO_REVENUE)), any_value(LO_REVENUE), bitmap_agg(LO_REVENUE), array_agg_distinct(LO_REVENUE) 
from lineorder l group by LO_ORDERDATE;
-- result:
-- !result
refresh materialized view mv0 with sync mode;
function: check_no_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1;", "mv0")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90
1994-01-01	175	175
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	180	90	180	90	1	1
1994-01-01	175	175	175	175	175	175	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
drop materialized view mv0;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv1 REFRESH MANUAL AS
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), min(LO_REVENUE + 1), bitmap_union(to_bitmap(LO_REVENUE + 1)), hll_union(hll_hash(LO_REVENUE + 1)), percentile_union(percentile_hash(LO_REVENUE + 1)), any_value(LO_REVENUE + 1), bitmap_agg(LO_REVENUE + 1), array_agg_distinct(LO_REVENUE + 1) 
from lineorder l group by LO_ORDERDATE;
-- result:
-- !result
refresh materialized view mv1 with sync mode;
function: check_no_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv1")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv1")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), sum(LO_REVENUE + 1), max(LO_REVENUE + 1) , sum(LO_REVENUE + 1), max(LO_REVENUE + 1), count(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv1")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), min(LO_REVENUE + 1), bitmap_union_count(to_bitmap(LO_REVENUE + 1)), approx_count_distinct(LO_REVENUE + 1), PERCENTILE_APPROX(LO_REVENUE + 1, 0.5), PERCENTILE_APPROX(LO_REVENUE + 1, 0.7), sum(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv1")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), min(LO_REVENUE + 1), bitmap_union_count(to_bitmap(LO_REVENUE + 1)), approx_count_distinct(LO_REVENUE + 1), PERCENTILE_APPROX(LO_REVENUE + 1, 0.5), PERCENTILE_APPROX(LO_REVENUE + 1, 0.7), sum(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE + 1) > 1;", "mv1")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), sum(LO_REVENUE + 1), max(LO_REVENUE + 1) , sum(LO_REVENUE + 1), max(LO_REVENUE + 1), count(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91	182	91	182	91	1	1
1994-01-01	176	176	176	176	176	176	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), min(LO_REVENUE + 1), bitmap_union_count(to_bitmap(LO_REVENUE + 1)), approx_count_distinct(LO_REVENUE + 1), PERCENTILE_APPROX(LO_REVENUE + 1, 0.5), PERCENTILE_APPROX(LO_REVENUE + 1, 0.7), sum(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91	91	1	1	91.0	91.0	91	1
1994-01-01	176	176	176	1	1	176.0	176.0	176	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1), min(LO_REVENUE + 1), bitmap_union_count(to_bitmap(LO_REVENUE + 1)), approx_count_distinct(LO_REVENUE + 1), PERCENTILE_APPROX(LO_REVENUE + 1, 0.5), PERCENTILE_APPROX(LO_REVENUE + 1, 0.7), sum(distinct LO_REVENUE + 1), count(distinct LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE + 1) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	182	91	91	1	1	91.0	91.0	91	1
1994-01-01	176	176	176	1	1	176.0	176.0	176	1
-- !result
drop materialized view mv1;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv2 REFRESH MANUAL AS
select LO_ORDERDATE, lo_custkey, lo_partkey, lo_suppkey, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union(to_bitmap(LO_REVENUE)), hll_union(hll_hash(LO_REVENUE)), percentile_union(percentile_hash(LO_REVENUE)), any_value(LO_REVENUE), bitmap_agg(LO_REVENUE), array_agg_distinct(LO_REVENUE) 
from lineorder l GROUP BY LO_ORDERDATE, lo_custkey, lo_partkey, lo_suppkey;
-- result:
-- !result
refresh materialized view mv2 with sync mode;
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE) FROM lineorder AS l INNER JOIN customer AS c ON c.C_CUSTKEY = l.LO_CUSTKEY INNER JOIN supplier AS s ON s.S_SUPPKEY = l.LO_SUPPKEY INNER JOIN part AS p ON p.P_PARTKEY = l.LO_PARTKEY INNER JOIN dates AS d ON l.lo_orderdate = d.d_date group by LO_ORDERDATE;", "mv2")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE)  FROM lineorder AS l INNER JOIN customer AS c ON c.C_CUSTKEY = l.LO_CUSTKEY INNER JOIN supplier AS s ON s.S_SUPPKEY = l.LO_SUPPKEY INNER JOIN part AS p ON p.P_PARTKEY = l.LO_PARTKEY INNER JOIN dates AS d ON l.lo_orderdate = d.d_date group by LO_ORDERDATE;", "mv2")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE) FROM lineorder AS l INNER JOIN customer AS c ON c.C_CUSTKEY = l.LO_CUSTKEY INNER JOIN supplier AS s ON s.S_SUPPKEY = l.LO_SUPPKEY INNER JOIN part AS p ON p.P_PARTKEY = l.LO_PARTKEY INNER JOIN dates AS d ON l.lo_orderdate = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE)  FROM lineorder AS l INNER JOIN customer AS c ON c.C_CUSTKEY = l.LO_CUSTKEY INNER JOIN supplier AS s ON s.S_SUPPKEY = l.LO_SUPPKEY INNER JOIN part AS p ON p.P_PARTKEY = l.LO_PARTKEY INNER JOIN dates AS d ON l.lo_orderdate = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
-- !result
drop materialized view mv2;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv0 REFRESH MANUAL 
PARTITION BY (LO_ORDERDATE)
AS
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union(to_bitmap(LO_REVENUE)), hll_union(hll_hash(LO_REVENUE)), percentile_union(percentile_hash(LO_REVENUE)), any_value(LO_REVENUE), bitmap_agg(LO_REVENUE), array_agg_distinct(LO_REVENUE) 
from lineorder l group by LO_ORDERDATE;
-- result:
-- !result
refresh materialized view mv0 with sync mode;
function: check_no_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1;", "mv0")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90
1994-01-01	175	175
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	180	90	180	90	1	1
1994-01-01	175	175	175	175	175	175	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
function: check_no_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90
1994-01-01	175	175
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	180	90	180	90	1	1
1994-01-01	175	175	175	175	175	175	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
select LO_ORDERDATE from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01
1994-01-01
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE, d_year order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;", "mv0")
-- result:
None
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE, d_year order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90
2023	1994-01-01	175	175
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90	180	90	180	90	1	1
2023	1994-01-01	175	175	175	175	175	175	1	1
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90	90	1	1	90.0	90.0	90	1
2023	1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
INSERT INTO lineorder (lo_orderkey, lo_linenumber, lo_custkey, lo_partkey, lo_suppkey
                      , lo_orderdate, lo_orderpriority, lo_shippriority, lo_quantity, lo_extendedprice
                      , lo_ordtotalprice, lo_discount, lo_revenue, lo_supplycost, lo_tax
                      , lo_commitdate, lo_shipmode)
VALUES
    (3, 3, 3, 3, 2, '1995-01-01', 'MEDIUM', 2, 20, 200, 180, 5, 175, 75, 7, 19940116, 'SHIP')
;
-- result:
-- !result
function: check_no_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
select LO_ORDERDATE, sum(LO_REVENUE + 1), max(LO_REVENUE + 1) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	182	91
1994-01-01	176	176
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90
1994-01-01	175	175
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	180	90	180	90	1	1
1994-01-01	175	175	175	175	175	175	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
function: check_hit_materialized_view("select LO_ORDERDATE from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
select LO_ORDERDATE from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01
1994-01-01
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE, d_year order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
function: check_hit_materialized_view("select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;", "mv0", "UNION")
-- result:
None
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by LO_ORDERDATE, d_year order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90
2023	1994-01-01	175	175
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90	180	90	180	90	1	1
2023	1994-01-01	175	175	175	175	175	175	1	1
-- !result
select d_year, LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date where l.LO_ORDERDATE >= '1993-01-01' group by d_year, LO_ORDERDATE order by LO_ORDERDATE;
-- result:
2023	1993-01-01	180	90	90	1	1	90.0	90.0	90	1
2023	1994-01-01	175	175	175	1	1	175.0	175.0	175	1
-- !result
drop materialized view mv0;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv0 REFRESH MANUAL AS
select LO_ORDERDATE, sum(LO_REVENUE), count(LO_REVENUE), sum(lo_suppkey), count(lo_suppkey), max(LO_REVENUE), min(LO_REVENUE), bitmap_union(to_bitmap(LO_REVENUE)), hll_union(hll_hash(LO_REVENUE)), percentile_union(percentile_hash(LO_REVENUE)), any_value(LO_REVENUE), bitmap_agg(LO_REVENUE), array_agg_distinct(LO_REVENUE) 
from lineorder l group by LO_ORDERDATE;
-- result:
-- !result
refresh materialized view mv0 with sync mode;
function: print_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), avg(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
True
-- !result
function: print_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), avg(LO_REVENUE), avg(lo_suppkey), sum(LO_REVENUE), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
True
-- !result
function: print_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), avg(LO_REVENUE), avg(lo_suppkey), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE;", "mv0")
-- result:
True
-- !result
function: print_hit_materialized_view("select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), avg(LO_REVENUE), avg(lo_suppkey), min(LO_REVENUE), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1;", "mv0")
-- result:
True
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), avg(LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90.0
1994-01-01	175	175	175.0
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), sum(LO_REVENUE), avg(LO_REVENUE), avg(lo_suppkey), max(LO_REVENUE) , sum(LO_REVENUE), max(LO_REVENUE), count(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	180	90.0	1.0	90	180	90	1	1
1994-01-01	175	175	175	175.0	2.0	175	175	175	1	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE), avg(LO_REVENUE), avg(lo_suppkey), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	90.0	1.0	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	175.0	2.0	1	1	175.0	175.0	175	1
-- !result
select LO_ORDERDATE, sum(LO_REVENUE), max(LO_REVENUE), min(LO_REVENUE),  avg(LO_REVENUE), avg(lo_suppkey), bitmap_union_count(to_bitmap(LO_REVENUE)), approx_count_distinct(LO_REVENUE), PERCENTILE_APPROX(LO_REVENUE, 0.5), PERCENTILE_APPROX(LO_REVENUE, 0.7), sum(distinct LO_REVENUE), count(distinct LO_REVENUE) from lineorder l join dates d on l.LO_ORDERDATE = d.d_date group by LO_ORDERDATE HAVING sum(LO_REVENUE) > 1 order by LO_ORDERDATE;
-- result:
1993-01-01	180	90	90	90.0	1.0	1	1	90.0	90.0	90	1
1994-01-01	175	175	175	175.0	2.0	1	1	175.0	175.0	175	1
-- !result
CREATE TABLE `test_pt8` (
  `id` bigint(20) NULL COMMENT "id",
  `pt` date NOT NULL COMMENT "",
  `gmv` bigint(20) NULL COMMENT "gmv",
  `gmv2` bigint(20) NULL COMMENT "gmv2"
) ENGINE=OLAP
DUPLICATE KEY(`id`)
COMMENT "OLAP"
PARTITION BY date_trunc('day', pt)
DISTRIBUTED BY HASH(`pt`)
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
insert into test_pt8 values(1,'20241126',1,2);
-- result:
-- !result
CREATE TABLE `test_pt9` (
  `id` bigint(20) NULL COMMENT "id",
  `pt` date NOT NULL COMMENT "",
  `name` varchar(20) NULL COMMENT "gmv"
) ENGINE=OLAP
DUPLICATE KEY(`id`)
COMMENT "OLAP"
PARTITION BY date_trunc('day', pt)
DISTRIBUTED BY HASH(`pt`)
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
insert into test_pt9 values(1,'20241126','a');
-- result:
-- !result
CREATE MATERIALIZED VIEW `test_mv1` 
PARTITION BY (`pt`)
DISTRIBUTED BY HASH(id) BUCKETS 1
REFRESH DEFERRED ASYNC START("2024-11-22 17:34:45") EVERY(INTERVAL 1 MINUTE)
PROPERTIES (
    "query_rewrite_consistency" = "LOOSE",
    "replication_num" = "1"
)
AS
SELECT  `id`,`pt`,SUM((`gmv` + `gmv2`) * 0.01) AS `sum_channel_direct_indirect_gmv`
FROM `test_pt8`
GROUP BY  `id`,`pt`;
-- result:
-- !result
REFRESH MATERIALIZED VIEW `test_mv1` WITH SYNC MODE;
<<<<<<< HEAD
function: check_hit_materialized_view("SELECT SUM((gmv+gmv2)*0.01) FROM test_pt8 WHERE pt = '20241126' AND id IN ( SELECT id FROM test_pt9 WHERE id = '1');", "test_mv1")
=======
-- result:
019b020f-7067-730f-9344-2b7084761390
-- !result
function: print_hit_materialized_view("SELECT SUM((gmv+gmv2)*0.01) FROM test_pt8 WHERE pt = '20241126' AND id IN ( SELECT id FROM test_pt9 WHERE id = '1');", "test_mv1")
>>>>>>> 81737321c4 ([Enhancement] Support push down group by expressions and mv rewrite (#66507))
-- result:
None
-- !result
SELECT SUM((gmv+gmv2)*0.01) FROM test_pt8 WHERE pt = '20241126' AND id IN ( SELECT id FROM test_pt9 WHERE id = '1');
-- result:
0.03
-- !result
-- name: test_materialized_view_agg_pushdown_rewrite_with_group_by_exprs
CREATE TABLE fact_event_requests
(
    event_date                DATE                        ,
    request_id                VARCHAR(64)                ,
    event_time                DATETIME                  , 
    event_status              VARCHAR(32)                       ,
    region_id                 INT                               ,
    site_id                   INT                               ,
    event_type                VARCHAR(16)                       ,
    location_path             ARRAY<VARCHAR(12)>               ,
    channel                   VARCHAR(8)                        
)
ENGINE = olap
PARTITION BY RANGE (event_date)
(
    START ("20251001") END ("20251101") EVERY (INTERVAL 1 DAY)
)
DISTRIBUTED BY HASH(channel, request_id) BUCKETS 16
PROPERTIES
(
    "replication_num" = "1"
);
-- result:
-- !result
insert into fact_event_requests values('20251001', '1', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '2', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '3', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '4', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '5', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '6', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '7', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '8', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile'),
('20251001', '9', '20251001', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile');
-- result:
-- !result
CREATE TABLE dim_location_area
(
    geohash              VARCHAR(12),
    area_name            VARCHAR(64)        
)
DISTRIBUTED BY HASH(geohash) BUCKETS 8
PROPERTIES
(
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO dim_location_area values('1234567890', 'Zone-1'), 
('1234567891', 'Zone-2'),
('1234567892', 'Zone-3'),
('1234567893', 'Zone-4'),
('1234567894', 'Zone-5'),
('1234567895', 'Zone-6'),
('1234567896', 'Zone-7'),
('1234567897', 'Zone-8');
-- result:
-- !result
CREATE MATERIALIZED VIEW mv_hourly_events
DISTRIBUTED BY RANDOM
Partition by (event_date)
AS
SELECT
    event_date,
    DATE_TRUNC('hour', event_time) as metric_time_1h,
    region_id,
    site_id,
    channel,
    location_path[cardinality(location_path)] as last_geohash,
    COUNT(request_id) as total_requests
FROM fact_event_requests  
WHERE event_type = 'TYPE_A'
GROUP BY event_date, metric_time_1h, region_id, site_id, channel, last_geohash;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW mv_hourly_events WITH SYNC MODE;
-- result:
019b020e-3633-74ce-aee0-8ca01da6a8e9
-- !result
function: print_hit_materialized_view("SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;", "mv_hourly_events")
-- result:
True
-- !result
SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;
-- result:
2025-10-01 00:00:00	9.0
-- !result
INSERT INTO fact_event_requests values('20251001', '10', '20251001 10:00:00', 'SUCCESS', 1, 1, 'TYPE_A', ['1234567890'], 'mobile');
-- result:
-- !result
function: print_hit_materialized_view("SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;", "mv_hourly_events")
-- result:
False
-- !result
SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;
-- result:
None	1.0
2025-10-01 00:00:00	9.0
-- !result
INSERT INTO dim_location_area values('1234567898', 'Zone-9');
-- result:
-- !result
function: print_hit_materialized_view("SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;", "mv_hourly_events")
-- result:
False
-- !result
SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;
-- result:
None	1.0
2025-10-01 00:00:00	9.0
-- !result
[UC]REFRESH MATERIALIZED VIEW mv_hourly_events WITH SYNC MODE;
-- result:
019b020e-5bec-7a88-b174-fcbc85a09aea
-- !result
function: print_hit_materialized_view("SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;", "mv_hourly_events")
-- result:
True
-- !result
SELECT DATE_TRUNC('hour', event_time) as metric_time_1h, CAST(COUNT(request_id) AS DOUBLE) FROM fact_event_requests AS fact_data_source LEFT JOIN (SELECT geohash, max(area_name) AS area_name FROM dim_location_area GROUP BY 1) AS dim_location_area ON dim_location_area.geohash = location_path[cardinality(location_path)] WHERE event_date = 20251001 AND area_name IN ('Zone-1') AND event_type = 'TYPE_A' GROUP BY 1 ORDER BY 1 limit 3;
-- result:
None	1.0
2025-10-01 00:00:00	9.0
-- !result
drop materialized view mv_hourly_events;
-- result:
-- !result
drop table fact_event_requests;
-- result:
-- !result
drop table dim_location_area;
-- result:
-- !result