-- name: test_create_mv_with_properties
create database test_create_mv_with_properties;
-- result:
-- !result
use test_create_mv_with_properties;
-- result:
-- !result
CREATE TABLE t1 (
  num int,
  dt datetime
)
DUPLICATE KEY(`num`)
PARTITION BY  date_trunc('day', dt) 
DISTRIBUTED BY HASH(`num`);
-- result:
-- !result
INSERT INTO t1 VALUES 
  (1,"2020-06-15"),(2,"2020-06-18"),(3,"2020-06-21"),(4,"2020-06-24"),
  (1,"2020-07-02"),(2,"2020-07-05"),(3,"2020-07-08"),(4,"2020-07-11"),
  (1,"2020-07-16"),(2,"2020-07-19"),(3,"2020-07-22"),(4,"2020-07-25"),
  (2,"2020-06-15"),(3,"2020-06-18"),(4,"2020-06-21"),(5,"2020-06-24"),
  (2,"2020-07-02"),(3,"2020-07-05"),(4,"2020-07-08"),(5,"2020-07-11");
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv1 
PARTITION BY dt 
REFRESH DEFERRED MANUAL 
PROPERTIES (
    "replication_num" = "1",
    "task_priority" = "100",
    "task_retry_attempts" = "3"
)
AS 
  SELECT dt,sum(num) FROM t1 GROUP BY dt;
-- result:
-- !result
SHOW CREATE MATERIALIZED VIEW test_mv1;
-- result:
test_mv1	CREATE MATERIALIZED VIEW `test_mv1` (`dt`, `sum(num)`)
PARTITION BY (`dt`)
DISTRIBUTED BY RANDOM
REFRESH DEFERRED MANUAL
PROPERTIES (
"replicated_storage" = "true",
"task_priority" = "100",
"task_retry_attempts" = "3",
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS SELECT `t1`.`dt`, sum(`t1`.`num`) AS `sum(num)`
FROM `test_create_mv_with_properties`.`t1`
GROUP BY `t1`.`dt`;
-- !result
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(1) FROM test_mv1;
-- result:
12
-- !result
ALTER MATERIALIZED VIEW test_mv1 SET ("task_priority" = "20");
-- result:
-- !result
ALTER MATERIALIZED VIEW test_mv1 SET ("task_retry_attempts" = "10");
-- result:
-- !result
SHOW CREATE MATERIALIZED VIEW test_mv1;
-- result:
test_mv1	CREATE MATERIALIZED VIEW `test_mv1` (`dt`, `sum(num)`)
PARTITION BY (`dt`)
DISTRIBUTED BY RANDOM
REFRESH DEFERRED MANUAL
PROPERTIES (
"replicated_storage" = "true",
"task_priority" = "20",
"task_retry_attempts" = "10",
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS SELECT `t1`.`dt`, sum(`t1`.`num`) AS `sum(num)`
FROM `test_create_mv_with_properties`.`t1`
GROUP BY `t1`.`dt`;
-- !result
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(1) FROM test_mv1;
-- result:
12
-- !result
DROP MATERIALIZED VIEW test_mv1;
-- result:
-- !result
CREATE MATERIALIZED VIEW test_mv1 
PARTITION BY dt 
REFRESH DEFERRED ASYNC 
PROPERTIES (
   "replication_num" = "1",
    "task_priority" = "100",
    "task_retry_attempts" = "3",
    "event_trigger_delay_period" = "1 minute"
)
AS 
  SELECT dt,sum(num) FROM t1 GROUP BY dt;
-- result:
-- !result
SHOW CREATE MATERIALIZED VIEW test_mv1;
-- result:
test_mv1	CREATE MATERIALIZED VIEW `test_mv1` (`dt`, `sum(num)`)
PARTITION BY (`dt`)
DISTRIBUTED BY RANDOM
REFRESH DEFERRED ASYNC
PROPERTIES (
"replicated_storage" = "true",
"event_trigger_delay_period" = "1 minute",
"task_priority" = "100",
"task_retry_attempts" = "3",
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS SELECT `t1`.`dt`, sum(`t1`.`num`) AS `sum(num)`
FROM `test_create_mv_with_properties`.`t1`
GROUP BY `t1`.`dt`;
-- !result
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(1) FROM test_mv1;
-- result:
12
-- !result
ALTER MATERIALIZED VIEW test_mv1 SET ("event_trigger_delay_period" = "5 minute");
-- result:
-- !result
SHOW CREATE MATERIALIZED VIEW test_mv1;
-- result:
test_mv1	CREATE MATERIALIZED VIEW `test_mv1` (`dt`, `sum(num)`)
PARTITION BY (`dt`)
DISTRIBUTED BY RANDOM
REFRESH DEFERRED ASYNC
PROPERTIES (
"replicated_storage" = "true",
"event_trigger_delay_period" = "5 minute",
"task_priority" = "100",
"task_retry_attempts" = "3",
"replication_num" = "1",
"storage_medium" = "HDD"
)
AS SELECT `t1`.`dt`, sum(`t1`.`num`) AS `sum(num)`
FROM `test_create_mv_with_properties`.`t1`
GROUP BY `t1`.`dt`;
-- !result
REFRESH MATERIALIZED VIEW test_mv1 WITH SYNC MODE;
SELECT COUNT(1) FROM test_mv1;
-- result:
12
-- !result
DROP DATABASE test_create_mv_with_properties FORCE;
-- result:
-- !result