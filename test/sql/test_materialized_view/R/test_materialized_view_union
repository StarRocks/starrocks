
-- name: test_materialized_view_union_all_unaligned
CREATE TABLE IF NOT EXISTS t1 (
    leg_id VARCHAR(100) NOT NULL,
    cabin_class VARCHAR(1) NOT NULL,
    observation_date DATE NOT NULL
)
DUPLICATE KEY(leg_id, cabin_class)
PARTITION BY date_trunc('day', observation_date);
-- result:
-- !result
CREATE TABLE IF NOT EXISTS t2 (
    leg_id VARCHAR(100) NOT NULL,
    cabin_class VARCHAR(1) NOT NULL,
    observation_date DATE NOT NULL
)
DUPLICATE KEY(leg_id, cabin_class)
PARTITION BY date_trunc('day', observation_date);
-- result:
-- !result
CREATE TABLE IF NOT EXISTS t3 (
    leg_id VARCHAR(100) NOT NULL,
    cabin_class VARCHAR(1) NOT NULL,
    observation_date DATE NOT NULL
)
DUPLICATE KEY(leg_id, cabin_class)
PARTITION BY date_trunc('month', observation_date);
-- result:
-- !result
CREATE TABLE IF NOT EXISTS t4 (
    leg_id VARCHAR(100) NOT NULL,
    cabin_class VARCHAR(1) NOT NULL,
    observation_date DATE NOT NULL
)
DUPLICATE KEY(leg_id, cabin_class)
PARTITION BY RANGE(observation_date) (
  PARTITION p0 VALUES LESS THAN ('2024-03-01'),
  PARTITION p1 VALUES LESS THAN ('2024-03-02'),
  PARTITION p2 VALUES LESS THAN ('2024-04-02')
);
-- result:
-- !result
insert into t1 (leg_id, cabin_class, observation_date) values
('FL_123', 'Y', '2024-03-21'),
('FL_124', 'Y', '2024-03-21'),
('FL_125', 'Y', '2024-03-21'),
('FL_126', 'Y', '2024-03-21');
-- result:
-- !result
insert into t2 (leg_id, cabin_class, observation_date) values
('FL_123', 'Y', '2024-03-22'),
('FL_124', 'Y', '2024-03-22'),
('FL_125', 'Y', '2024-03-22'),
('FL_126', 'Y', '2024-03-22');
-- result:
-- !result
insert into t3 (leg_id, cabin_class, observation_date) values
('FL_123', 'Y', '2024-03-22'),
('FL_124', 'Y', '2024-03-22'),
('FL_125', 'Y', '2024-03-22'),
('FL_126', 'Y', '2024-03-22');
-- result:
-- !result
CREATE MATERIALIZED VIEW v1 
PARTITION BY date_trunc('day', observation_date)
DISTRIBUTED BY HASH(leg_id)
REFRESH DEFERRED ASYNC
AS 
SELECT * FROM t1
UNION ALL
SELECT * FROM t2;
-- result:
-- !result
	
REFRESH MATERIALIZED VIEW v1 WITH SYNC MODE;
-- result:
4c6f86f1-2d22-11ef-9d69-e67f2420b196
-- !result
select count(*) from v1;
-- result:
8
-- !result
CREATE MATERIALIZED VIEW v2
PARTITION BY date_trunc('day', observation_date)
DISTRIBUTED BY HASH(leg_id)
REFRESH DEFERRED ASYNC
AS 
SELECT * FROM t1
UNION ALL
SELECT * FROM t3;
-- result:
-- !result
CREATE MATERIALIZED VIEW v3
PARTITION BY date_trunc('day', observation_date)
DISTRIBUTED BY HASH(leg_id)
REFRESH DEFERRED ASYNC
AS 
SELECT * FROM t1
UNION ALL
SELECT * FROM t4;
-- result:
-- !result