-- name: test_mv_rewrite_with_iceberg_bugs1
create external catalog mv_iceberg_${uuid0}
properties
(
    "type" = "iceberg",
    "iceberg.catalog.type" = "hive",
    "hive.metastore.uris" = "${iceberg_catalog_hive_metastore_uris}"
);
-- result:
-- !result
set catalog mv_iceberg_${uuid0};
-- result:
-- !result
create database mv_iceberg_db_${uuid0};
-- result:
-- !result
use mv_iceberg_db_${uuid0};
-- result:
-- !result
CREATE TABLE t1 (
    num int,
    dt varchar(30)
)PARTITION BY (dt);
-- result:
-- !result
INSERT INTO t1 VALUES (1,"2020-06-15"),(2,"2020-06-18"),(3,"2020-06-21"),(4,"2020-06-24"),
    (1,"2020-07-02"),(2,"2020-07-05"),(3,"2020-07-08"),(4,"2020-07-11"),
    (1,"2020-07-16"),(2,"2020-07-19"),(3,"2020-07-22"),(4,"2020-07-25"),
    (2,"2020-06-15"),(3,"2020-06-18"),(4,"2020-06-21"),(5,"2020-06-24"),
    (2,"2020-07-02"),(3,"2020-07-05"),(4,"2020-07-08"),(5,"2020-07-11"),
    (2,"2020-07-16"),(3,"2020-07-19"),(4,"2020-07-22"),(5,"2020-07-25");
-- result:
-- !result
set catalog default_catalog;
-- result:
-- !result
create database db_${uuid0};
-- result:
-- !result
use db_${uuid0};
-- result:
-- !result
CREATE MATERIALIZED VIEW mv1 PARTITION BY dt1 REFRESH MANUAL AS 
SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1;
-- result:
-- !result
REFRESH MATERIALIZED VIEW mv1 WITH SYNC MODE;
SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;
-- result:
2020-06-01	24
2020-07-01	48
-- !result
function: print_hit_materialized_view("SELECT date_trunc('month',str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;", "mv1")
-- result:
True
-- !result
INSERT INTO mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 VALUES (3,"2020-06-15");
-- result:
-- !result
function: print_hit_materialized_view("SELECT date_trunc('month',str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;", "mv1")
-- result:
True
-- !result
SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;
-- result:
2020-06-01	27
2020-07-01	48
-- !result
drop database default_catalog.db_${uuid0} ;
-- result:
-- !result
DROP TABLE mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 FORCE;
-- result:
-- !result
drop database mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0};
-- result:
-- !result
DROP CATALOG mv_iceberg_${uuid0};
-- result:
-- !result