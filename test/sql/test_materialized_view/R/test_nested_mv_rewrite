-- name: test_nested_mv_rewrite_with_case_when
create table dal_aaaa (
ffund_union string,
 famt bigint, 
  fuser_id string,
  fdate bigint
)
PARTITION BY range(fdate) (
    PARTITION p1 VALUES LESS THAN ("20230703"),
    PARTITION p2 VALUES LESS THAN ("20230706"),
    PARTITION p3 VALUES LESS THAN ("20230716")
 )
  DISTRIBUTED BY HASH(fuser_id) 
  PROPERTIES (
    "replication_num" = "1"
);

insert into  dal_aaaa (ffund_union,famt,fuser_id,fdate)
values ('xfdfdf',100,'xxxxx',20230702);
insert into  dal_aaaa (ffund_union,famt,fuser_id,fdate)
values ('xfdafdf',100,'xxxdxx',20230715);

create table dal_bbb(
    ffund_union string, 
    famt bigint, 
    fuser_id string,
    fdate bigint
)
PARTITION BY range(fdate) (
    PARTITION p1 VALUES LESS THAN ("20230703"),
    PARTITION p2 VALUES LESS THAN ("20230706"),
    PARTITION p3 VALUES LESS THAN ("20230716")
 )
 DISTRIBUTED BY HASH(fuser_id) 
 PROPERTIES (
    "replication_num" = "1"
);

create table dim_ccc(
     fdate bigint,
     `lvl1` string,
     `ffund_union`  string
) DISTRIBUTED BY HASH(ffund_union)
PROPERTIES (
    "replication_num" = "1"
);

create MATERIALIZED VIEW join_mv1
DISTRIBUTED BY HASH(a_ds, dim_1_ffund_union_5061_lvl1)
REFRESH MANUAL
AS
SELECT `fdate` AS a_ds, a.`ffund_union_5061_lvl1` AS `dim_1_ffund_union_5061_lvl1`, SUM(CASE 
                WHEN `1154_famt` IS NOT NULL THEN `1154_famt`
            END) / 100 AS `1154_7969`
        FROM (
            SELECT t1.*, t3.`lvl1` AS `ffund_union_5061_lvl1`
            FROM (
                SELECT *, t8.`1154_ffund_union` AS `ffund_union`, t8.`1154_fuser_id` AS `fuser_id`, t8.`1154_fdate` AS `fdate`, t8.`1154_fdd_event_code` AS `fdd_event_code`
                    , t8.`1154_ds` AS `ds`
                FROM (
                    SELECT t7.`1154_fdate` AS `1154_fdate`, t7.`1154_ffund_union` AS `1154_ffund_union`, t7.`1154_fdd_event_code` AS `1154_fdd_event_code`, t7.`1154_fuser_id` AS `1154_fuser_id`, t7.`1154_ds` AS `1154_ds`
                        , t7.`1154_famt` AS `1154_famt`
                    FROM (
                        SELECT ffund_union AS `1154_ffund_union`, famt AS `1154_famt`, fdate AS `1154_fdate`, fuser_id AS `1154_fuser_id`, 'all' AS `1154_fdd_event_code`
                            , fdate AS `1154_ds`
                        FROM dal_aaaa
                        WHERE fdate >= 20230713
                            AND fdate < 20230720
                    ) t7
                ) t8
            ) t1
                LEFT JOIN (
                    SELECT  
                        t2.`lvl1` AS lvl1 , t2.`ffund_union` AS ffund_union
                    FROM dim_ccc t2
                    WHERE t2.`fdate` = 20230719
                ) t3
                ON t1.`ffund_union` = t3.`ffund_union`
        ) a
        GROUP BY a_ds, `dim_1_ffund_union_5061_lvl1`;

create MATERIALIZED VIEW join_mv2
DISTRIBUTED BY HASH(a_ds, dim_1_ffund_union_5061_lvl1)
REFRESH MANUAL
AS
SELECT `fdate` AS a_ds, a.`ffund_union_5061_lvl1` AS `dim_1_ffund_union_5061_lvl1`, SUM(CASE 
                    WHEN `1162_famt` IS NOT NULL THEN `1162_famt`
                END) / 100 AS `1162_7970`
            FROM (
                SELECT t12.*, t14.`lvl1` AS `ffund_union_5061_lvl1`
                FROM (
                    SELECT *, t19.`1162_ffund_union` AS `ffund_union`, t19.`1162_fuser_id` AS `fuser_id`, t19.`1162_fdate` AS `fdate`, t19.`1162_fdd_event_code` AS `fdd_event_code`
                        , t19.`1162_ds` AS `ds`
                    FROM (
                        SELECT t18.`1162_fdate` AS `1162_fdate`, t18.`1162_ffund_union` AS `1162_ffund_union`, t18.`1162_fdd_event_code` AS `1162_fdd_event_code`, t18.`1162_fuser_id` AS `1162_fuser_id`, t18.`1162_ds` AS `1162_ds`
                            , t18.`1162_famt` AS `1162_famt`
                        FROM (
                            SELECT ffund_union AS `1162_ffund_union`, famt AS `1162_famt`, fdate AS `1162_fdate`, fuser_id AS `1162_fuser_id`, 'all' AS `1162_fdd_event_code`
                                , fdate AS `1162_ds`
                            FROM dal_bbb
                            WHERE fdate >= 20230713
                                AND fdate < 20230720
                        ) t18
                    ) t19
                ) t12
                    LEFT JOIN (
                        SELECT t13.`lvl1` AS lvl1 , t13.`ffund_union` AS ffund_union
                        FROM dim_ccc t13
                        WHERE t13.`fdate` = 20230719
                    ) t14
                    ON t12.`ffund_union` = t14.`ffund_union`
            ) a
            GROUP BY a_ds, `dim_1_ffund_union_5061_lvl1`;

create MATERIALIZED VIEW join_mv3
DISTRIBUTED BY HASH(a_ds, dim_1_ffund_union_5061_lvl1)
REFRESH MANUAL
AS

    SELECT CASE 
            WHEN t_join0.a_ds IS NOT NULL THEN t_join0.a_ds
            WHEN t_join1.a_ds IS NOT NULL THEN t_join1.a_ds
            ELSE NULL
        END AS a_ds
        , CASE 
            WHEN t_join0.`dim_1_ffund_union_5061_lvl1` IS NOT NULL THEN t_join0.`dim_1_ffund_union_5061_lvl1`
            WHEN t_join1.`dim_1_ffund_union_5061_lvl1` IS NOT NULL THEN t_join1.`dim_1_ffund_union_5061_lvl1`
            ELSE NULL
        END AS `dim_1_ffund_union_5061_lvl1`
        , COALESCE(`1154_7969`, 0) - COALESCE(`1162_7970`, 0) AS index_0_8179
    FROM join_mv1 t_join0
        FULL JOIN join_mv2 t_join1
        ON coalesce(CAST(t_join0.a_ds AS string), '无值') = coalesce(CAST(t_join1.a_ds AS string), '无值')
            AND coalesce(CAST(t_join0.`dim_1_ffund_union_5061_lvl1` AS string), '无值') = coalesce(CAST(t_join1.`dim_1_ffund_union_5061_lvl1` AS string), '无值');
 

refresh materialized view join_mv1 with sync mode;
refresh materialized view join_mv2 with sync mode;
refresh materialized view join_mv3 with sync mode;

explain logical
  SELECT CASE 
            WHEN t_join0.a_ds IS NOT NULL THEN t_join0.a_ds
            WHEN t_join1.a_ds IS NOT NULL THEN t_join1.a_ds
            ELSE NULL
        END AS a_ds
        , CASE 
            WHEN t_join0.`dim_1_ffund_union_5061_lvl1` IS NOT NULL THEN t_join0.`dim_1_ffund_union_5061_lvl1`
            WHEN t_join1.`dim_1_ffund_union_5061_lvl1` IS NOT NULL THEN t_join1.`dim_1_ffund_union_5061_lvl1`
            ELSE NULL
        END AS `dim_1_ffund_union_5061_lvl1`
        , COALESCE(`1154_7969`, 0) - COALESCE(`1162_7970`, 0) AS index_0_8179
    FROM (
        SELECT `fdate` AS a_ds, a.`ffund_union_5061_lvl1` AS `dim_1_ffund_union_5061_lvl1`, SUM(CASE 
                WHEN `1154_famt` IS NOT NULL THEN `1154_famt`
            END) / 100 AS `1154_7969`
        FROM (
            SELECT t1.*, t3.`lvl1` AS `ffund_union_5061_lvl1`
            FROM (
                SELECT *, t8.`1154_ffund_union` AS `ffund_union`, t8.`1154_fuser_id` AS `fuser_id`, t8.`1154_fdate` AS `fdate`, t8.`1154_fdd_event_code` AS `fdd_event_code`
                    , t8.`1154_ds` AS `ds`
                FROM (
                    SELECT t7.`1154_fdate` AS `1154_fdate`, t7.`1154_ffund_union` AS `1154_ffund_union`, t7.`1154_fdd_event_code` AS `1154_fdd_event_code`, t7.`1154_fuser_id` AS `1154_fuser_id`, t7.`1154_ds` AS `1154_ds`
                        , t7.`1154_famt` AS `1154_famt`
                    FROM (
                        SELECT ffund_union AS `1154_ffund_union`, famt AS `1154_famt`, fdate AS `1154_fdate`, fuser_id AS `1154_fuser_id`, 'all' AS `1154_fdd_event_code`
                            , fdate AS `1154_ds`
                        FROM dal_aaaa
                        WHERE fdate >= 20230713
                            AND fdate < 20230720
                    ) t7
                ) t8
            ) t1
                LEFT JOIN (
                    SELECT  
                        t2.`lvl1` AS lvl1 , t2.`ffund_union` AS ffund_union
                    FROM dim_ccc t2
                    WHERE t2.`fdate` = 20230719
                ) t3
                ON t1.`ffund_union` = t3.`ffund_union`
        ) a
        GROUP BY a_ds, `dim_1_ffund_union_5061_lvl1`
    ) t_join0
        FULL JOIN (
            SELECT `fdate` AS a_ds, a.`ffund_union_5061_lvl1` AS `dim_1_ffund_union_5061_lvl1`, SUM(CASE 
                    WHEN `1162_famt` IS NOT NULL THEN `1162_famt`
                END) / 100 AS `1162_7970`
            FROM (
                SELECT t12.*, t14.`lvl1` AS `ffund_union_5061_lvl1`
                FROM (
                    SELECT *, t19.`1162_ffund_union` AS `ffund_union`, t19.`1162_fuser_id` AS `fuser_id`, t19.`1162_fdate` AS `fdate`, t19.`1162_fdd_event_code` AS `fdd_event_code`
                        , t19.`1162_ds` AS `ds`
                    FROM (
                        SELECT t18.`1162_fdate` AS `1162_fdate`, t18.`1162_ffund_union` AS `1162_ffund_union`, t18.`1162_fdd_event_code` AS `1162_fdd_event_code`, t18.`1162_fuser_id` AS `1162_fuser_id`, t18.`1162_ds` AS `1162_ds`
                            , t18.`1162_famt` AS `1162_famt`
                        FROM (
                            SELECT ffund_union AS `1162_ffund_union`, famt AS `1162_famt`, fdate AS `1162_fdate`, fuser_id AS `1162_fuser_id`, 'all' AS `1162_fdd_event_code`
                                , fdate AS `1162_ds`
                            FROM dal_bbb
                            WHERE fdate >= 20230713
                                AND fdate < 20230720
                        ) t18
                    ) t19
                ) t12
                    LEFT JOIN (
                        SELECT t13.`lvl1` AS lvl1 , t13.`ffund_union` AS ffund_union
                        FROM dim_ccc t13
                        WHERE t13.`fdate` = 20230719
                    ) t14
                    ON t12.`ffund_union` = t14.`ffund_union`
            ) a
            GROUP BY a_ds, `dim_1_ffund_union_5061_lvl1`
        ) t_join1
        ON coalesce(CAST(t_join0.a_ds AS string), '无值') = coalesce(CAST(t_join1.a_ds AS string), '无值')
            AND coalesce(CAST(t_join0.`dim_1_ffund_union_5061_lvl1` AS string), '无值') = coalesce(CAST(t_join1.`dim_1_ffund_union_5061_lvl1` AS string), '无值');
-- result:
<<<<<<< HEAD
[REGEX]join_mv3
=======
[{"id":0,"name":"join_mv1","level":0,"related_mvs":[{"id":0,"name":"join_mv3","level":1,"related_mvs":[]}]}]
-- !result
[UC]select regexp_replace(inspect_related_mv('dal_bbb'), '"id":[0-9]+', '"id":0');
-- result:
[{"id":0,"name":"join_mv2","level":0,"related_mvs":[{"id":0,"name":"join_mv3","level":1,"related_mvs":[]}]}]
-- !result
[UC]select regexp_replace(inspect_related_mv('dim_ccc'), '"id":[0-9]+', '"id":0');
-- result:
[{"id":0,"name":"join_mv2","level":0,"related_mvs":[{"id":0,"name":"join_mv3","level":1,"related_mvs":[]}]},{"id":0,"name":"join_mv1","level":0,"related_mvs":[]}]
-- !result
[UC]select regexp_replace(inspect_related_mv('join_mv1'), '"id":[0-9]+', '"id":0');
-- result:
[{"id":0,"name":"join_mv3","level":0,"related_mvs":[]}]
-- !result
[UC]select regexp_replace(inspect_related_mv('join_mv2'), '"id":[0-9]+', '"id":0');
-- result:
[{"id":0,"name":"join_mv3","level":0,"related_mvs":[]}]
-- !result
[UC]select inspect_related_mv('join_mv3');
-- result:
[]
-- !result
-- name: test_nested_mv_with_partial_compensation
CREATE TABLE t1 (
    `k1` INT,
    `v1` INT,
    `v2` INT)
DUPLICATE KEY(`k1`)
PARTITION BY RANGE(`k1`)
(
PARTITION `p1` VALUES LESS THAN ('2'),
PARTITION `p2` VALUES LESS THAN ('3'),
PARTITION `p3` VALUES LESS THAN ('4'),
PARTITION `p4` VALUES LESS THAN ('5'),
PARTITION `p5` VALUES LESS THAN ('6'),
PARTITION `p6` VALUES LESS THAN ('7')
)
DISTRIBUTED BY HASH(k1);
-- result:
-- !result
insert into t1 values (1,1,1),(1,1,2),(1,1,3),(1,2,1),(1,2,2),(1,2,3),(1,3,1),(1,3,2),(1,3,3)
    ,(2,1,1),(2,1,2),(2,1,3),(2,2,1),(2,2,2),(2,2,3),(2,3,1),(2,3,2),(2,3,3)
    ,(3,1,1),(3,1,2),(3,1,3),(3,2,1),(3,2,2),(3,2,3),(3,3,1),(3,3,2),(3,3,3);
-- result:
-- !result
CREATE MATERIALIZED VIEW mv1 PARTITION BY k1 DISTRIBUTED BY HASH(k1) BUCKETS 10
REFRESH DEFERRED MANUAL AS SELECT k1, v1 as k2, v2 as k3 from t1;
-- result:
-- !result
CREATE MATERIALIZED VIEW mv2 PARTITION BY k1 DISTRIBUTED BY HASH(k1) BUCKETS 10
REFRESH DEFERRED MANUAL AS SELECT k1, count(k2) as count_k2, sum(k3) as sum_k3 from mv1 group by k1;
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW mv2 WITH SYNC MODE;
-- result:
019aed92-815f-7f22-b30b-b65ccb6c64bf
-- !result
select count(1) from (
    select k1, v1, v2 from mv1 where k1 = 1
    union all
    select k1, v1, v2 from t1 where k1 = 2
    union all
    select k1, v1, v2 from mv1 where k1 = 3
    union all
    select k1, v1, v2 from mv1 where k1 = 4
) as t;
-- result:
E: (1064, "Getting analyzing error. Detail message: Column 'v1' cannot be resolved.")
-- !result
function: print_hit_materialized_views("SELECT k1, count(v1), sum(v2) from t1 group by k1;")
-- result:

-- !result
SELECT k1, count(v1), sum(v2) from t1 group by k1;
-- result:
2	9	18
3	9	18
1	9	18
-- !result
[UC]REFRESH MATERIALIZED VIEW mv1 WITH SYNC MODE;
-- result:
019aed92-887e-7d51-a47d-da3f6a7c3aa7
-- !result
select count(1) from (
    select k1, v1, v2 from mv1 where k1 = 1
    union all
    select k1, v1, v2 from t1 where k1 = 2
    union all
    select k1, v1, v2 from mv1 where k1 = 3
    union all
    select k1, v1, v2 from mv1 where k1 = 4
) as t;
-- result:
E: (1064, "Getting analyzing error. Detail message: Column 'v1' cannot be resolved.")
-- !result
function: print_hit_materialized_views("SELECT k1, count(v1), sum(v2) from t1 group by k1;")
-- result:

-- !result
SELECT k1, count(v1), sum(v2) from t1 group by k1;
-- result:
3	9	18
1	9	18
2	9	18
-- !result
insert into t1 values (4,1,1);
-- result:
-- !result
[UC]REFRESH MATERIALIZED VIEW mv2 WITH SYNC MODE;
-- result:
019aed92-982c-7502-ad24-8e7a292be34a
-- !result
select count(1) from (
    select k1, v1, v2 from mv1 where k1 = 1
    union all
    select k1, v1, v2 from t1 where k1 = 2
    union all
    select k1, v1, v2 from mv1 where k1 = 3
    union all
    select k1, v1, v2 from mv1 where k1 = 4
) as t;
-- result:
E: (1064, "Getting analyzing error. Detail message: Column 'v1' cannot be resolved.")
-- !result
function: print_hit_materialized_views("SELECT k1, count(v1), sum(v2) from t1 group by k1;")
-- result:

-- !result
SELECT k1, count(v1), sum(v2) from t1 group by k1;
-- result:
2	9	18
3	9	18
1	9	18
4	1	1
-- !result
[UC]REFRESH MATERIALIZED VIEW mv1 WITH SYNC MODE;
-- result:
019aed92-a67d-7c4d-9e93-c09e478457c2
-- !result
select count(1) from (
    select k1, v1, v2 from mv1 where k1 = 1
    union all
    select k1, v1, v2 from t1 where k1 = 2
    union all
    select k1, v1, v2 from mv1 where k1 = 3
    union all
    select k1, v1, v2 from mv1 where k1 = 4
) as t;
-- result:
E: (1064, "Getting analyzing error. Detail message: Column 'v1' cannot be resolved.")
-- !result
function: print_hit_materialized_views("SELECT k1, count(v1), sum(v2) from t1 group by k1;")
-- result:

-- !result
SELECT k1, count(v1), sum(v2) from t1 group by k1;
-- result:
1	9	18
2	9	18
4	1	1
3	9	18
-- !result
drop materialized view mv1;
-- result:
-- !result
drop materialized view mv2;
-- result:
-- !result
drop table t1;  
-- result:
-- !result
>>>>>>> a23e2be635 ([BugFix] Fix mv compensation bugs when query contains multi times for the same table (#66369))
