-- name: test_agg_join_on_multi_tables_rewrite
set enable_view_based_mv_rewrite = true;
-- result:
-- !result
CREATE TABLE `t1` (
`v4` bigint NULL COMMENT "",
`v5` bigint NULL COMMENT "",
`v6` bigint NULL
) ENGINE=OLAP
DUPLICATE KEY(`v4`, `v5`, v6)
DISTRIBUTED BY HASH(`v4`) BUCKETS 3
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO `t1` (`v4`, `v5`, `v6`) VALUES (1, 10, 100);
-- result:
-- !result
INSERT INTO `t1` (`v4`, `v5`, `v6`) VALUES (2, 20, 200);
-- result:
-- !result
INSERT INTO `t1` (`v4`, `v5`, `v6`) VALUES (3, 30, 300);
-- result:
-- !result
INSERT INTO `t1` (`v4`, `v5`, `v6`) VALUES (4, 40, 400);
-- result:
-- !result
INSERT INTO `t1` (`v4`, `v5`, `v6`) VALUES (5, 50, 500);
-- result:
-- !result
CREATE TABLE `t2` (
`c4` bigint NULL COMMENT "",
`c5` bigint NULL COMMENT "",
`c6` bigint NULL
) ENGINE=OLAP
DUPLICATE KEY(`c4`, `c5`, c6)
DISTRIBUTED BY HASH(`c4`) BUCKETS 3
PROPERTIES (
    "replication_num" = "1"
);
-- result:
-- !result
INSERT INTO `t2` (`c4`, `c5`, `c6`) VALUES (1, 1009, 10009);
-- result:
-- !result
INSERT INTO `t2` (`c4`, `c5`, `c6`) VALUES (2, NULL, 10010);
-- result:
-- !result
INSERT INTO `t2` (`c4`, `c5`, `c6`) VALUES (3, 1011, NULL);
-- result:
-- !result
INSERT INTO `t2` (`c4`, `c5`, `c6`) VALUES (4, 1009, 10009);
-- result:
-- !result
INSERT INTO `t2` (`c4`, `c5`, `c6`) VALUES (5, NULL, 10010);
-- result:
-- !result
create view agg_view_1
as
select v4, sum(v5) as total from t1 group by v4;
-- result:
-- !result
create materialized view mv_1
DISTRIBUTED by hash(`v4`)
refresh manual
as
select v4, total, c5, c6 from t2 join agg_view_1 on c4 = v4;
-- result:
-- !result
refresh materialized view mv_1 with sync mode;
function: check_hit_materialized_view("select v4, total, c5, c6 from t2 join agg_view_1 on c4 = v4", "mv_1")
-- result:
None
-- !result
-- name: test_agg_join_on_single_tables_rewrite
CREATE TABLE t1 (
                    k1 INT,
                    v1 INT,
                    v2 INT)
                DUPLICATE KEY(k1)
                DISTRIBUTED BY HASH(k1);
-- result:
E: (1064, 'Table replication num should be less than or equal to the number of available BE nodes. You can change this default by setting the replication_num table properties. Current alive backend is [10001]. , table=t1, default_replication_num=3')
-- !result
insert into t1 values (1,1,1),(2,1,1),(3,1,1),(1,2,3),(2,2,3),(3,2,3);
-- result:
E: (1064, 'Getting analyzing error. Detail message: Table t1 is not found.')
-- !result
create view v1 as select k1,sum(v1) as sum_v1 from t1 group by k1;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_db_9801fcb40dfc11ef88b62207f0c2897f.t1'.")
-- !result
create materialized view mv_2 refresh manual as select v1.k1,v1.sum_v1,t1.v1 from v1 join t1 on v1.k1=t1.k1;
-- result:
E: (5502, "Getting analyzing error. Detail message: Unknown table 'test_db_9801fcb40dfc11ef88b62207f0c2897f.v1'.")
-- !result
refresh materialized view mv_2 with sync mode;
set enable_view_based_mv_rewrite = true;
-- result:
-- !result
function: check_hit_materialized_view("select v1.k1,v1.sum_v1,t1.v1 from v1 join t1 on v1.k1=t1.k1 order by 1,3;", "mv_2")