-- name: test_mv_rewrite_with_iceberg_bugs1 @slow

create external catalog mv_iceberg_${uuid0}
properties
(
    "type" = "iceberg",
    "iceberg.catalog.type" = "hive",
    "hive.metastore.uris" = "${iceberg_catalog_hive_metastore_uris}"
);

-- create iceberg table
set catalog mv_iceberg_${uuid0};
create database mv_iceberg_db_${uuid0};
use mv_iceberg_db_${uuid0};

CREATE TABLE t1 (
    num int,
    dt varchar(30)
)PARTITION BY (dt);
INSERT INTO t1 VALUES (1,"2020-06-15"),(2,"2020-06-18"),(3,"2020-06-21"),(4,"2020-06-24"),
    (1,"2020-07-02"),(2,"2020-07-05"),(3,"2020-07-08"),(4,"2020-07-11"),
    (1,"2020-07-16"),(2,"2020-07-19"),(3,"2020-07-22"),(4,"2020-07-25"),
    (2,"2020-06-15"),(3,"2020-06-18"),(4,"2020-06-21"),(5,"2020-06-24"),
    (2,"2020-07-02"),(3,"2020-07-05"),(4,"2020-07-08"),(5,"2020-07-11"),
    (2,"2020-07-16"),(3,"2020-07-19"),(4,"2020-07-22"),(5,"2020-07-25");

set catalog default_catalog;
create database db_${uuid0};
use db_${uuid0};

CREATE MATERIALIZED VIEW mv1 PARTITION BY dt1 REFRESH MANUAL AS 
SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1;

REFRESH MATERIALIZED VIEW mv1 WITH SYNC MODE;

SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;
function: print_hit_materialized_view("SELECT date_trunc('month',str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;", "mv1")

INSERT INTO mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 VALUES (3,"2020-06-15");

function: print_hit_materialized_view("SELECT date_trunc('month',str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;", "mv1")
SELECT date_trunc("month",str2date(dt,'%Y-%m-%d')) as dt1,sum(num) FROM mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 GROUP BY dt1 order by 1;

drop database default_catalog.db_${uuid0} force;
DROP TABLE mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0}.t1 FORCE;
drop database mv_iceberg_${uuid0}.mv_iceberg_db_${uuid0} FORCE;
DROP CATALOG mv_iceberg_${uuid0};
