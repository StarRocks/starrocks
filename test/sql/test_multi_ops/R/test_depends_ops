-- name: test_depends_ops
set enable_wait_dependent_event = true;
-- result:
-- !result
create table t0 (c0 INT, c1 BIGINT) DUPLICATE KEY(c0) DISTRIBUTED BY HASH(c0) BUCKETS 4 PROPERTIES('replication_num' = '1');
-- result:
-- !result
insert into
    t0
SELECT
    generate_series,
    4096 - generate_series
FROM
    TABLE(generate_series(1, 4096));
-- result:
-- !result
insert into
    t0
select
    *
from
    t0;
-- result:
-- !result
insert into
    t0
select
    *
from
    t0;
-- result:
-- !result
select
    count(*)
from
    t0;
-- result:
16384
-- !result
with aggregated_table as (
    select
        trim(c0) as c0,
        c1 as c1
    from
        t0
    group by
        1,
        2
)
select
    *
from
    aggregated_table l1
    left join [shuffle] aggregated_table r1 on l1.c0 = r1.c0
    and l1.c1 = r1.c1
order by
    1,
    2,
    3,
    4 desc
limit
    10;
-- result:
1	4095	1	4095
10	4086	10	4086
100	3996	100	3996
1000	3096	1000	3096
1001	3095	1001	3095
1002	3094	1002	3094
1003	3093	1003	3093
1004	3092	1004	3092
1005	3091	1005	3091
1006	3090	1006	3090
-- !result
with aggregated_table as (
    select
        trim(c0) as c0,
        c1 as c1
    from
        t0
    group by
        1,
        2
)
select
    count(*)
from
    (
        select
            *
        from
            aggregated_table l1
            left join [shuffle] aggregated_table r1 on l1.c0 = r1.c0
            and l1.c1 = r1.c1
            left join [shuffle] aggregated_table r2 on l1.c0 = r2.c0
            and l1.c1 = r2.c1
    ) tb;
-- result:
4096
-- !result
with aggregated_table as (
    select
        trim(c0) as c0,
        c1 as c1
    from
        t0
    group by
        1,
        2
)
select
    sum(l1.c0),
    sum(l1.c1),
    sum(l1.c0),
    sum(l1.c1)
from
    aggregated_table l1
    left join [shuffle] aggregated_table r1 on l1.c0 = r1.c0
    and l1.c1 = r1.c1
    left join [shuffle] aggregated_table r2 on l1.c0 = r2.c0
    and l1.c1 = r2.c1;
-- result:
8390656.0	8386560	8390656.0	8386560
-- !result
create view aggregated_table as
select
    trim(c0) as c0,
    c1 as c1
from
    t0
group by
    1,
    2;
-- result:
-- !result
select l.c1, sum(l.c0) ,sum(r.c0) from aggregated_table l join aggregated_table r on l.c0 <= r.c0 and r.c0 < 10 group by 1 order by 2, 3 limit 10;
-- result:
4087	9.0	9.0
4095	9.0	45.0
4088	16.0	17.0
4094	16.0	44.0
4089	21.0	24.0
4093	21.0	42.0
4090	24.0	30.0
4092	24.0	39.0
4091	25.0	35.0
4016	80.0	9.0
-- !result
select l.c1, l.c0 from aggregated_table l except select r.c1, r.c0 from aggregated_table r;
-- result:
-- !result
select l.c1, l.c0 from aggregated_table l intersect select r.c1, r.c0 from aggregated_table r order by 1, 2 limit 10;
-- result:
0	4096
1	4095
2	4094
3	4093
4	4092
5	4091
6	4090
7	4089
8	4088
9	4087
-- !result
