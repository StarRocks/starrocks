-- name: test_http_request_basic
-- description: Basic tests for http_request() function with Named Parameters
-- Note: Uses jsonplaceholder.typicode.com as a reliable public API
-- Response format: {"status": <code>, "body": <content>} or {"status": -1, "body": null, "error": "<message>"}
--
-- Function signature:
--   http_request(
--     url VARCHAR,           -- Required: The URL to request
--     method VARCHAR,        -- Default: 'GET'
--     body VARCHAR,          -- Default: ''
--     headers VARCHAR,       -- Default: '{}' (JSON object)
--     timeout_ms INT,        -- Default: 30000
--     ssl_verify BOOLEAN,    -- Default: true
--     username VARCHAR,      -- Default: ''
--     password VARCHAR       -- Default: ''
--   ) -> VARCHAR

-- Setup: Reset security configuration and allow external API hosts for basic functional tests
ADMIN SET FRONTEND CONFIG ("http_request_security_level" = "3");
-- result:
-- !result
ADMIN SET FRONTEND CONFIG ("http_request_host_allowlist_regexp" = "jsonplaceholder\\.typicode\\.com|.*\\.badssl\\.com");
-- result:
-- !result
-- Allow ssl_verify=false for SSL verification tests
ADMIN SET FRONTEND CONFIG ("http_request_ssl_verification_required" = "false");
-- result:
-- !result

-- Wait for config propagation to BE (heartbeat interval is typically 1 second)
SELECT sleep(2);
-- result:
1
-- !result

-- Test 1: NULL input returns error (required parameter cannot be NULL)
SELECT http_request(url => NULL);
-- result:
E: (1064, "Getting analyzing error. Detail message: http_request() required parameter 'url' cannot be NULL.")
-- !result

-- Test 2: Empty string returns JSON with error
SELECT json_query(http_request(url => ''), '$.status') as status;
-- result:
-1
-- !result

-- Test 3: Invalid URL returns JSON with error
SELECT json_query(http_request(url => 'not a valid url'), '$.status') as status;
-- result:
-1
-- !result

-- Test 4: Simple GET request (url only) - check status code
SELECT json_query(http_request(url => 'https://jsonplaceholder.typicode.com/posts/1'), '$.status') as status;
-- result:
200
-- !result

-- Test 5: GET and parse JSON response body
SELECT json_query(
    json_query(http_request(url => 'https://jsonplaceholder.typicode.com/posts/1'), '$.body'),
    '$.id'
) as post_id;
-- result:
1
-- !result

-- Test 6: POST with Named Parameters
SELECT json_query(
    json_query(http_request(
        url => 'https://jsonplaceholder.typicode.com/posts',
        method => 'POST',
        headers => '{"Content-Type": "application/json"}',
        body => '{"title": "test post", "body": "hello world", "userId": 1}',
        timeout_ms => 30000
    ), '$.body'),
    '$.title'
) as created_title;
-- result:
"test post"
-- !result

-- Test 7: DELETE request with Named Parameters
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'DELETE'
), '$.status') as status;
-- result:
200
-- !result

-- Test 8: Request with SSL options (disable verification)
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    ssl_verify => false
), '$.status') as status;
-- result:
200
-- !result

-- Test 9: Invalid domain returns JSON with status -1 (network error)
SELECT json_query(http_request(
    url => 'https://invalid-domain-that-does-not-exist-12345.com/api',
    timeout_ms => 5000
), '$.status') as status;
-- result:
-1
-- !result

-- Test 10: HTTP 404 error returns JSON with status 404
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/99999'
), '$.status') as status;
-- result:
404
-- !result

-- Test 11: GET with custom headers using Named Parameters
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    headers => '{"Accept": "application/json"}'
), '$.status') as status;
-- result:
200
-- !result

-- Test 12: Very short timeout returns JSON with status -1 (timeout error)
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    timeout_ms => 1
), '$.status') as status;
-- result:
-1
-- !result

-- Test 13: Large response (100 posts ~27KB) - should work within 1MB limit
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts'
), '$.status') as status;
-- result:
200
-- !result

-- Test 14: Very large response (photos ~25MB) - exceeds 1MB limit, returns error
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/photos',
    timeout_ms => 60000
), '$.status') as status;
-- result:
-1
-- !result

-- Test 15: POST with body as string (not auto-stringify)
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts',
    method => 'POST',
    headers => '{"Content-Type": "text/plain"}',
    body => 'plain text body'
), '$.status') as status;
-- result:
201
-- !result

-- ============================================================
-- SSL Verification Tests (using badssl.com test sites)
-- ============================================================

-- Test 19: Self-signed certificate with ssl_verify=true (default) - should fail
SELECT json_query(http_request(url => 'https://self-signed.badssl.com/'), '$.status') as status;
-- result:
-1
-- !result

-- Test 20: Self-signed certificate with ssl_verify=false - should succeed
SELECT json_query(http_request(
    url => 'https://self-signed.badssl.com/',
    ssl_verify => false
), '$.status') as status;
-- result:
200
-- !result

-- Test 21: Expired certificate with ssl_verify=true (default) - should fail
SELECT json_query(http_request(url => 'https://expired.badssl.com/'), '$.status') as status;
-- result:
-1
-- !result

-- Test 22: Expired certificate with ssl_verify=false - should succeed
SELECT json_query(http_request(
    url => 'https://expired.badssl.com/',
    ssl_verify => false
), '$.status') as status;
-- result:
200
-- !result

-- ============================================================
-- Named Parameter Order Tests
-- ============================================================

-- Test 23: Named parameters in different order (should work the same)
SELECT json_query(http_request(
    method => 'GET',
    timeout_ms => 30000,
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    ssl_verify => true
), '$.status') as status;
-- result:
200
-- !result

-- Test 24: Only required parameter (url)
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1'
), '$.status') as status;
-- result:
200
-- !result

-- ============================================================
-- HEAD and OPTIONS Method Tests (using jsonplaceholder)
-- ============================================================

-- Test 25: HEAD request - returns headers only (no body)
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'HEAD'
), '$.status') as status;
-- result:
200
-- !result

-- Test 26: OPTIONS request - returns allowed methods
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'OPTIONS'
), '$.status') as status;
-- result:
204
-- !result

-- Test 27: HEAD request - body should be empty or null
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'HEAD'
), '$.body') as body;
-- result:
""
-- !result

-- ============================================================
-- Invalid HTTP Method Tests
-- ============================================================

-- Test 28: Invalid method 'INVALID' - should return error
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'INVALID'
), '$.status') as status;
-- result:
-1
-- !result

-- Test 29: Invalid method error message should contain 'Invalid HTTP method'
SELECT CAST(json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'INVALID'
), '$.error') AS STRING) LIKE '%Invalid HTTP method%' as has_error_message;
-- result:
1
-- !result

-- Test 30: Invalid method 'PATCH' - not in allowed list
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'PATCH'
), '$.status') as status;
-- result:
-1
-- !result

-- Test 31: Empty method string - should return error
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => ''
), '$.status') as status;
-- result:
-1
-- !result

-- Test 32: Case insensitive method (lowercase 'get')
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'get'
), '$.status') as status;
-- result:
200
-- !result

-- Test 33: Case insensitive method (mixed case 'GeT')
SELECT json_query(http_request(
    url => 'https://jsonplaceholder.typicode.com/posts/1',
    method => 'GeT'
), '$.status') as status;
-- result:
200
-- !result

-- Cleanup: Reset configuration to default
ADMIN SET FRONTEND CONFIG ("http_request_host_allowlist_regexp" = "");
-- result:
-- !result
ADMIN SET FRONTEND CONFIG ("http_request_ssl_verification_required" = "true");
-- result:
-- !result
