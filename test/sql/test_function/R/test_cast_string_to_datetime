-- name: test_cast_string_to_datetime
create table t1 (
    k1 int NULL,
    date_str string,
    datetime_str string,
    date_str_with_whitespace string,
    datetime_str_with_whitespace string
)
duplicate key(k1)
distributed by hash(k1) buckets 32;
-- result:
-- !result
CREATE TABLE __row_util (
  k1 bigint null
) ENGINE=OLAP
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 32;
-- result:
-- !result
insert into __row_util select generate_series from TABLE(generate_series(0, 10000 - 1));
-- result:
-- !result
insert into __row_util select k1 + 20000 from __row_util;
-- result:
-- !result
insert into __row_util select k1 + 40000 from __row_util;
-- result:
-- !result
insert into __row_util select k1 + 80000 from __row_util;
-- result:
-- !result
insert into t1
select
    cast(random() *2e9 as int),
    cast(cast(date_add('2020-01-01', INTERVAL row_number() over() DAY) as date) as varchar),
    concat(cast(cast(date_add('2020-01-01', INTERVAL row_number() over() DAY) as date) as varchar), ' 01:02:03'),
    concat('  ', cast(cast(date_add('2020-01-01', INTERVAL row_number() over() DAY) as date) as varchar), '  '),
    concat('   ', cast(cast(date_add('2020-01-01', INTERVAL row_number() over() DAY) as date) as varchar), ' 01:02:03  ')
from __row_util;
-- result:
-- !result
insert into t1 (date_str)
values
    ("20200101"),
    ("20200101010203"),
    ("20200101T010203"),
    ("20200101T0102033"),
    ("20200101T010203.123"),

    ("200101"),
    ("200101010203"),
    ("200101T010203"),
    ("200101T0102033"),
    ("200101T010203.123"),

    ("2020.01.01"),
    ("2020.01.01T01.02.03"),
    ("2020.01.01T01.02.033"),
    ("2020.01.01T01.0203.123"),

    ("  20200101 "),
    ("  20200101010203   "),
    ("  20200101T010203"),
    ("20200101T0102033  "),
    ("  20200101T010203.123    \n"),
    ("  20200101T010203.123    \n \t \v \f \r "),

    ("2020.13.29"),
    ("2020.13.61"),

    ("2020.02.29"),
    ("2020.02.28"),
    ("2000.02.29"),
    ("2000.02.28"),

    ("2021.02.28"),
    ("2100.02.28"),

    ("invalid"),

    ("2021.02.29"),
    ("2100.02.29"),

    ("?100.02.28"),
    ("2?00.02.28"),
    ("21?0.02.28"),
    ("210?.02.28"),
    ("2100902.28"),
    ("2100.?2.28"),
    ("2100.0?.28"),
    ("2100.02928"),
    ("2100.02.?8"),
    ("2100.02.2?"),
    ("2020-01-01T01:02:03Z"),            -- Basic Z format
    ("2020-01-01T01:02:03.123Z"),        -- Z with 3 microseconds
    ("2020-01-01T01:02:03.123456Z"),     -- Z with 6 microseconds
    ("2020-01-01T01:02:03.1Z"),          -- Z with 1 microsecond
    ("  2020-01-01T01:02:03Z  "),        -- Z with whitespace
    ("  2020-01-01T01:02:03.123Z  "),    -- Z with microseconds and whitespace

    -- Invalid Z format tests:
    ("2020-01-01T01:02:03z"),            -- lowercase z
    ("2020-01-01T01:02:03Zextra"),       -- extra chars after Z
    ("2020-01-01T01:02:03.Z"),           -- decimal but no microseconds
    ("2020-01-01T01:02:03.1234567Z");    -- too many microsecond digits;
-- result:
-- !result
select
    ifnull(sum(murmur_hash3_32(
        cast(date_str as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(date_str_with_whitespace as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(datetime_str as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(datetime_str_with_whitespace as datetime)
    )), 0)
from t1;
-- result:
-1393794079612
-- !result
insert into t1
select
    cast(random() *2e9 as int),
    null, null, null ,null
from __row_util;
-- result:
-- !result
select
    ifnull(sum(murmur_hash3_32(
        cast(date_str as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(date_str_with_whitespace as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(datetime_str as datetime)
    )), 0) +
    ifnull(sum(murmur_hash3_32(
        cast(datetime_str_with_whitespace as datetime)
    )), 0)
from t1;
-- result:
-1393794079612
-- !result
select cast(column_0 as datetime) from (values (NULL)) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("20200101")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("20200101010203")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("20200101T010203")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("20200101T0102033")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("20200101T010203.123")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("200101")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("200101010203")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("200101T010203")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("200101T0102033")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("200101T010203.123")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("2020.01.01")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2020.01.01T01.02.03")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2020.01.01T01.02.033")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2020.01.01T01.0203.123")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("  20200101 ")) as tmp;
-- result:
2020-01-01 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("  20200101010203   ")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("  20200101T010203")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("20200101T0102033  ")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("  20200101T010203.123    \n")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("  20200101T010203.123    \n \t \v \f \r ")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("2020.13.29")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2020.13.61")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2020.02.29")) as tmp;
-- result:
2020-02-29 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2020.02.28")) as tmp;
-- result:
2020-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2000.02.29")) as tmp;
-- result:
2000-02-29 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2000.02.28")) as tmp;
-- result:
2000-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2021.02.28")) as tmp;
-- result:
2021-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2100.02.28")) as tmp;
-- result:
2100-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("invalid")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2021.02.29")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2100.02.29")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("?100.02.28")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2?00.02.28")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("21?0.02.28")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("210?.02.28")) as tmp;
-- result:
0210-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2100902.28")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2100.?2.28")) as tmp;
-- result:
2100-02-28 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2100.0?.28")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2100.02928")) as tmp;
-- result:
None
-- !result
select cast(column_0 as datetime) from (values ("2100.02.?8")) as tmp;
-- result:
2100-02-08 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2100.02.2?")) as tmp;
-- result:
2100-02-02 00:00:00
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03Z")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03.123Z")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03.123456Z")) as tmp;
-- result:
2020-01-01 01:02:03.123456
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03.1Z")) as tmp;
-- result:
2020-01-01 01:02:03.100000
-- !result
select cast(column_0 as datetime) from (values ("  2020-01-01T01:02:03Z  ")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("  2020-01-01T01:02:03.123Z  ")) as tmp;
-- result:
2020-01-01 01:02:03.123000
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03z")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03Zextra")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03.Z")) as tmp;
-- result:
2020-01-01 01:02:03
-- !result
select cast(column_0 as datetime) from (values ("2020-01-01T01:02:03.1234567Z")) as tmp;
-- result:
2020-01-01 01:02:03.123456
-- !result