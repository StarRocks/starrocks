-- name: test_regex
CREATE TABLE `ts` (
  `str` varchar(65533) NULL COMMENT "",
  `regex` varchar(65533) NULL COMMENT "",
  `replaced` varchar(65533) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`str`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`str`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into ts values ('abcd', '.*', 'xx'), ('abcd', 'a.*', 'xx'), ('abcd', '.*abc.*', 'xx'), ('abcd', '.*cd', 'xx'), ('abcd', 'bc', 'xx'), ('', '', 'xx'), (NULL, '', 'xx'), ('abc中文def', '[\\p{Han}]+', 'xx');
-- result:
-- !result
insert into ts values ('a b c', " ", "-"), ('           XXXX', '       ', '');
-- result:
-- !result
insert into ts values ('xxxx', "x", "-"), ('xxxx', "xx", "-"), ('xxxx', "xxx", "-"), ('xxxx', "xxxx", "-");
-- result:
-- !result
insert into ts values ('xxxx', "not", "xxxxxxxx"), ('xxaxx', 'xx', 'aaa'), ('xaxaxax', 'xax', '-');
-- result:
-- !result
select regexp_replace('abcd', '.*', 'xx');
-- result:
xx
-- !result
select regexp_replace('abcd', 'a.*', 'xx');
-- result:
xx
-- !result
select regexp_replace('abcd', '.*abc.*', 'xx');
-- result:
xx
-- !result
select regexp_replace('abcd', '.*cd', 'xx');
-- result:
xx
-- !result
select regexp_replace('abcd', 'bc', 'xx');
-- result:
axxd
-- !result
select regexp_replace('', '', 'xx');
-- result:
-- !result
select regexp_replace(NULL, '', 'xx');
-- result:
None
-- !result
select regexp_replace('abc中文def', '中文', 'xx');
-- result:
abcxxdef
-- !result
select regexp_replace('abc中文def', '[\\p{Han}]+', 'xx');
-- result:
abcxxdef
-- !result
select regexp_replace('a b c', " ", "-");
-- result:
a-b-c
-- !result
select regexp_replace('           XXXX', '       ', '');
-- result:
    XXXX
-- !result
select regexp_replace('xxxx', "x", "-");
-- result:
----
-- !result
select regexp_replace('xxxx', "xx", "-"); 
select regexp_replace('xxxx', "xxx", "-");
-- result:
--
-- !result
select regexp_replace('xxxx', "xxxx", "-");
-- result:
-
-- !result
select regexp_replace('xxxx', "not", "xxxxxxxx");
-- result:
xxxx
-- !result
select regexp_replace('xxaxx', 'xx', 'aaa'); 
select regexp_replace('xaxaxax', 'xax', '-');
-- result:
aaaaaaa
-- !result
select str, regex, replaced, regexp_replace(str, regex, replaced) from ts order by str, regex, replaced;
-- result:
None		xx	None
		xx	xx
           XXXX	       		    XXXX
a b c	 	-	a-b-c
abcd	.*	xx	xx
abcd	.*abc.*	xx	xx
abcd	.*cd	xx	xx
abcd	a.*	xx	xx
abcd	bc	xx	axxd
abc中文def	[\p{Han}]+	xx	abcxxdef
xaxaxax	xax	-	-a-
xxaxx	xx	aaa	aaaaaaa
xxxx	not	xxxxxxxx	xxxx
xxxx	x	-	----
xxxx	xx	-	--
xxxx	xxx	-	-x
xxxx	xxxx	-	-
-- !result
CREATE TABLE `tsr` (
  `str` varchar(65533) NULL COMMENT "",
  `regex` varchar(65533) NULL COMMENT "",
  `pos` int NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`str`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`str`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into tsr values ("AbCdExCeF", "([[:lower:]]+)C([[:lower:]]+)", 3), ("AbCdExCeF", "([[:lower:]]+)C([[:lower:]]+)", 0);
-- result:
-- !result
SELECT regexp_extract_all("AbCdExCeF", "([[:lower:]]+)C([[:lower:]]+)", 0);
-- result:
["bCd","xCe"]
-- !result
SELECT regexp_extract_all(str, "([[:lower:]]+)C([[:lower:]]+)", 0) from tsr;
-- result:
["bCd","xCe"]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all(str, regex, 0) from tsr;
-- result:
["bCd","xCe"]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all(str, regex, pos) from tsr;
-- result:
[]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all(str, "([[:lower:]]+)C([[:lower:]]+)", pos) from tsr;
-- result:
[]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all("AbCdExCeF", "([[:lower:]]+)C([[:lower:]]+)", pos) from tsr;
-- result:
[]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all("AbCdExCeF", regex, pos) from tsr;
-- result:
[]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all(str, "([[:lower:]]+)C([[:lower:]]+)", pos) from tsr;
-- result:
[]
["bCd","xCe"]
-- !result
SELECT regexp_extract_all("AbCdExCeF", "([[:lower:]]+)C([[:lower:]]+)", 3);
-- result:
[]
-- !result
SELECT regexp_extract_all(str, "([[:lower:]]+)C([[:lower:]]+)", 3) from tsr;
-- result:
[]
[]
-- !result
SELECT regexp_extract_all(str, regex, 3) from tsr;
-- result:
[]
[]
-- !result
SELECT regexp_position('a.b:c;d', '[.]');
-- result:
2
-- !result
SELECT regexp_position('a.b:c;d', '[\\.:;]', 2);
-- result:
2
-- !result
SELECT regexp_position('a.b:c;d', ':');
-- result:
4
-- !result
SELECT regexp_position('a,b,c', ',');
-- result:
2
-- !result
SELECT regexp_position('a1b2c3d', '[0-9]');
-- result:
2
-- !result
SELECT regexp_position('a,b,c', ',', 3);
-- result:
4
-- !result
SELECT regexp_position('a1b2c3d', '[0-9]', 5);
-- result:
6
-- !result
SELECT regexp_position('a1b2c3d4e', '[0-9]', 4, 2);
-- result:
6
-- !result
SELECT regexp_position('a1b2c3d',  '[0-9]', 4, 3);
-- result:
-1
-- !result
SELECT regexp_position('a1b2c3d', '', 1);
-- result:
1
-- !result
SELECT regexp_position('a1b2c3d', '', 2);
-- result:
2
-- !result
SELECT regexp_position('a1b2c3d', '', 2, 2);
-- result:
3
-- !result
SELECT regexp_position('a1b2c3d', '', 2, 6);
-- result:
7
-- !result
SELECT regexp_position('a1b2c3d', '', 2, 7);
-- result:
8
-- !result
SELECT regexp_position('a1b2c3d', '', 2, 8);
-- result:
-1
-- !result
SELECT regexp_position('', ',');
-- result:
-1
-- !result
SELECT regexp_position('', ',', 4);
-- result:
-1
-- !result
SELECT regexp_position('', ',', 4, 2);
-- result:
-1
-- !result
SELECT regexp_position('a,b,c',  ',', 2);
-- result:
2
-- !result
SELECT regexp_position('a1b2c3d', '[0-9]', 4);
-- result:
4
-- !result
SELECT regexp_position('a,b,c', ',', 1000);
-- result:
-1
-- !result
SELECT regexp_position('a,b,c', ',', 8);
-- result:
-1
-- !result
SELECT regexp_position('有朋$%X自9远方来', '[0-9]', 7);
-- result:
7
-- !result
SELECT regexp_position('有朋$%X自9远方9来', '[0-9]', 10, 1);
-- result:
10
-- !result
SELECT regexp_position('有朋$%X自9远方9来', '[0-9]', 10, 2);
-- result:
-1
-- !result
SELECT regexp_position('有朋$%X自9远方9来', '来', 999);
-- result:
-1
-- !result
SELECT regexp_position('行成于思str而毁123于随', '于', 3, 2);
-- result:
13
-- !result
SELECT regexp_position('行成于思str而毁123于随', '',  3, 1);
-- result:
3
-- !result
SELECT regexp_position('行成于思str而毁123于随', '',  3, 2);
-- result:
4
-- !result
SELECT regexp_position(column_0, 'T') FROM (VALUES ('2024-01-01T01:61:00')) AS tmp;
-- result:
11
-- !result
SELECT regexp_position(column_0, '61') FROM (VALUES ('2024-01-01T01:61:00')) AS tmp;
-- result:
15
-- !result
SELECT regexp_position(column_0, '0', 1, 3) FROM (VALUES ('2024-01-01T01:61:00')) AS tmp;
-- result:
9
-- !result
SELECT regexp_position(column_0, 'Z', 20) FROM (VALUES ('2024-01-01T01:61:00')) AS tmp;
-- result:
-1
-- !result
SELECT regexp_position(column_0, '01', 12, 2) FROM (VALUES ('2024-01-01T01:61:00')) AS tmp;
-- result:
-1
-- !result
SELECT regexp_position(column_0, '(unclosed') FROM (VALUES ('oops')) AS tmp;
-- result:
[REGEX].*Invalid regex expression: \(unclosed.*
-- !result
SELECT regexp_position(column_0, 'x') FROM (VALUES (NULL)) AS tmp;
-- result:
None
-- !result
CREATE TABLE `tsp_general` (
  `str` varchar(65533) NULL COMMENT "",
  `pattern` varchar(65533) NULL COMMENT "",
  `start_pos` int NULL COMMENT "",
  `occurrence` int NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`str`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`str`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into tsp_general values 
('abcdef123ghi', '[0-9]+', 1, 1),
('abc def ghi', '\\s+', 1, 1),
('test@email.com', '@[a-zA-Z]+', 1, 1),
('hello world hello universe', 'hello', 1, 2),
('complex(pattern)test', '\\([^)]*\\)', 1, 1),
('abc123def456ghi', '[0-9]{2,}', 1, 2),
('', '.', 1, 1),
(NULL, '[0-9]', 1, 1),
('test string', NULL, 1, 1),
(NULL, NULL, 1, 1);
-- result:
-- !result
SELECT str, pattern, regexp_position(str, pattern) from tsp_general order by str, pattern;
-- result:
None	None	None
None	[0-9]	None
	.	-1
abc def ghi	\s+	4
abc123def456ghi	[0-9]{2,}	4
abcdef123ghi	[0-9]+	7
complex(pattern)test	\([^)]*\)	8
hello world hello universe	hello	1
test string	None	None
test@email.com	@[a-zA-Z]+	5
-- !result
SELECT str, pattern, start_pos, regexp_position(str, pattern, start_pos) from tsp_general where start_pos is not null order by str, pattern;
-- result:
None	None	1	None
None	[0-9]	1	None
	.	1	-1
abc def ghi	\s+	1	4
abc123def456ghi	[0-9]{2,}	1	4
abcdef123ghi	[0-9]+	1	7
complex(pattern)test	\([^)]*\)	1	8
hello world hello universe	hello	1	1
test string	None	1	None
test@email.com	@[a-zA-Z]+	1	5
-- !result
SELECT str, pattern, start_pos, occurrence, regexp_position(str, pattern, start_pos, occurrence) from tsp_general where start_pos is not null and occurrence is not null order by str, pattern;
-- result:
None	None	1	1	None
None	[0-9]	1	1	None
	.	1	1	-1
abc def ghi	\s+	1	1	4
abc123def456ghi	[0-9]{2,}	1	2	10
abcdef123ghi	[0-9]+	1	1	7
complex(pattern)test	\([^)]*\)	1	1	8
hello world hello universe	hello	1	2	13
test string	None	1	1	None
test@email.com	@[a-zA-Z]+	1	1	5
-- !result
SELECT regexp_position(NULL, '[0-9]');
-- result:
None
-- !result
SELECT regexp_position('test', NULL);
-- result:
None
-- !result
SELECT regexp_position(NULL, NULL);
-- result:
None
-- !result
SELECT regexp_position(NULL, '[0-9]', 1);
-- result:
None
-- !result
SELECT regexp_position('test', NULL, 1);
-- result:
None
-- !result
SELECT regexp_position('test', '[0-9]', NULL);
-- result:
None
-- !result
SELECT regexp_position(NULL, '[0-9]', 1, 1);
-- result:
None
-- !result
SELECT regexp_position('test', NULL, 1, 1);
-- result:
None
-- !result
SELECT regexp_position('test', '[0-9]', NULL, 1);
-- result:
None
-- !result
SELECT regexp_position('test', '[0-9]', 1, NULL);
-- result:
None
-- !result
SELECT regexp_position('test string', '[0-9');
-- result:
[REGEX].*Invalid regex expression: \[0-9.*
-- !result
SELECT regexp_position('test string', '(unclosed');
-- result:
[REGEX].*Invalid regex expression: \(unclosed.*
-- !result
SELECT regexp_position('test string', '?invalid');
-- result:
[REGEX].*Invalid regex expression: \?invalid.*
-- !result
SELECT regexp_position('test string', '*invalid');
-- result:
[REGEX].*Invalid regex expression: \*invalid.*
-- !result
SELECT regexp_position('test string', '+invalid');
-- result:
[REGEX].*Invalid regex expression: \+invalid.*
-- !result
SELECT regexp_position('test string', '\\');
-- result:
[REGEX].*Invalid regex expression: \\
-- !result
SELECT regexp_position('test', '[0-9]', 0);
-- result:
-1
-- !result
SELECT regexp_position('test', '[0-9]', -1);
-- result:
-1
-- !result
SELECT regexp_position('test', '[0-9]', 1, 0);
-- result:
-1
-- !result
SELECT regexp_position('test', '[0-9]', 1, -1);
-- result:
-1
-- !result
CREATE TABLE `tsc` (
  `str` varchar(65533) NULL COMMENT "",
  `regex` varchar(65533) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`str`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`str`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into tsc values ('abc123def456', '[0-9]'), ('test.com test.net test.org', '\\.'), ('a b  c   d', '\\s+'), ('ababababab', 'ab'), ('', '.'), (NULL, '.');
-- result:
-- !result
select regexp_count('abc123def456', '[0-9]');
-- result:
6
-- !result
select regexp_count('test.com test.net test.org', '\\.');
-- result:
3
-- !result
select regexp_count('a b  c   d', '\\s+');
-- result:
3
-- !result
select regexp_count('ababababab', 'ab');
-- result:
5
-- !result
select regexp_count('', '.');
-- result:
0
-- !result
select regexp_count(NULL, '.');
-- result:
None
-- !result
select regexp_count('abc', NULL);
-- result:
None
-- !result
select regexp_count('abc中文def', '[\\p{Han}]+');
-- result:
1
-- !result
select regexp_count('AbCdExCeF', 'C');
-- result:
2
-- !result
select regexp_count('1a 2b 14m', '\\d+');
-- result:
3
-- !result
select str, regex, regexp_count(str, regex) from tsc order by str, regex;
-- result:
None	.	None
	.	0
a b  c   d	\s+	3
ababababab	ab	5
abc123def456	[0-9]	6
test.com test.net test.org	\.	3
-- !result
CREATE TABLE `tsc_invalid` (
  `str` varchar(65533) NULL COMMENT "",
  `regex` varchar(65533) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`str`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`str`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into tsc_invalid values 
('abc123def456', '[0-9'),
('test string', '(unclosed'),
('repetition test', '?invalid'),
('valid test', 'valid');
-- result:
-- !result
select str, regex, regexp_count(str, regex) from tsc_invalid order by str, regex;
-- result:
abc123def456	[0-9	None
repetition test	?invalid	None
test string	(unclosed	None
valid test	valid	1
-- !result
select regexp_count('test string', '[0-9');
-- result:
[REGEX].*Invalid regex expression: \[0-9.*
-- !result
select regexp_count('test string', '(unclosed');
-- result:
[REGEX].*Invalid regex expression: \(unclosed.*
-- !result
select regexp_count('test string', '?invalid');
-- result:
[REGEX].*Invalid regex expression: \?invalid.*
-- !result
select regexp_count('test string', 'a{,}');
-- result:
0
-- !result
select regexp_count(NULL, '[0-9');
-- result:
None
-- !result
select regexp_count('', '[0-9');
-- result:
[REGEX].*Invalid regex expression: \[0-9.*
-- !result
select regexp_count('test', NULL);
-- result:
None
-- !result
CREATE TABLE `test_regexp_replace_multirow` (
  `column_value` varchar(100) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`column_value`)
COMMENT "OLAP"
DISTRIBUTED BY HASH(`column_value`) BUCKETS 1 PROPERTIES ("replication_num" = "1");
-- result:
-- !result
insert into test_regexp_replace_multirow values 
('activity_60_package_2'),
('activity_50_package_7'),
('activity_70_package_1'),
('nomatch_value'),
('test_package_suffix');
-- result:
-- !result
SELECT regexp_replace(column_value, '_package_.*', '') 
FROM (VALUES 
    ('activity_60_package_2'),
    ('activity_50_package_7')
) AS t(column_value);
-- result:
activity_60
activity_50
-- !result
SELECT regexp_replace(column_value, '_package_.*', '') 
FROM test_regexp_replace_multirow 
ORDER BY column_value;
-- result:
activity_50
activity_60
activity_70
nomatch_value
test
-- !result
SELECT regexp_replace(column_value, '_[0-9]+', '_X') 
FROM test_regexp_replace_multirow 
ORDER BY column_value;
-- result:
activity_X_package_X
activity_X_package_X
activity_X_package_X
nomatch_value
test_package_suffix
-- !result
SELECT regexp_replace(column_value, '_package_', '_pkg_') 
FROM test_regexp_replace_multirow 
ORDER BY column_value;
-- result:
activity_50_pkg_7
activity_60_pkg_2
activity_70_pkg_1
nomatch_value
test_pkg_suffix
-- !result
DROP TABLE test_regexp_replace_multirow;
-- result:
-- !result