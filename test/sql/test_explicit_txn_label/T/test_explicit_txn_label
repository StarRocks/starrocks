-- name: test_begin_with_label_already_used_by_insert @sequential
create database db_${uuid0};
use db_${uuid0};

create table t1(id int) primary key(id);

-- First, start a transaction with INSERT using a specific label
insert /*+ SET_VAR(query_timeout=300) */ into t1 with label test_label_${uuid0} values(1);

-- Attempt to begin a new transaction with the same label should fail
begin with label test_label_${uuid0};

-- name: test_begin_with_label_already_used_by_another_begin @sequential
create database db_${uuid1};
use db_${uuid1};

create table t1(id int) primary key(id);

-- Start a transaction with BEGIN using a specific label
begin with label test_label_${uuid1};
insert into t1 values(1);

-- Attempt to begin another transaction with the same label should fail (in another session)
-- Since we cannot test multi-session in this framework, we verify that commit works
-- and then test that the same label cannot be reused while the first txn is still active
commit;

-- After commit, the label should still be marked as used (VISIBLE status)
-- Trying to use it again should fail
begin with label test_label_${uuid1};

-- name: test_begin_with_valid_label @sequential
create database db_${uuid2};
use db_${uuid2};

create table t1(id int) primary key(id);

-- Begin with a new unique label should succeed
begin with label test_unique_label_${uuid2};
insert into t1 values(100);
commit;

select * from t1 order by id;

-- name: test_begin_with_label_reuse_after_rollback @sequential
create database db_${uuid3};
use db_${uuid3};

create table t1(id int) primary key(id);

-- Start a transaction with BEGIN using a specific label
begin with label test_label_${uuid3};
insert into t1 values(1);

-- Rollback the transaction (ABORTED status)
rollback;

-- After rollback, the label should be reusable (ABORTED transactions don't block label reuse)
begin with label test_label_${uuid3};
insert into t1 values(200);
commit;

select * from t1 order by id;
