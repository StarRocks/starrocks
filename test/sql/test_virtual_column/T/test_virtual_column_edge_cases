-- name: test_virtual_column_edge_cases

-- Test edge cases and error handling for virtual column _tablet_id_

create database if not exists test_virtual_column_db;
use test_virtual_column_db;

-- Test 1: Virtual column with empty table
create table empty_table (
    k1 int,
    k2 int
)
duplicate key(k1)
distributed by hash(k1) buckets 1
properties("replication_num" = "1");

[UC]select _tablet_id_, k1, k2 from empty_table;

-- Test 2: Virtual column with single row
insert into empty_table values (1, 10);
[UC]select _tablet_id_, k1, k2 from empty_table;

-- Test 3: Virtual column in subquery
[UC]select * from (
    select _tablet_id_, k1, k2 from empty_table
) t order by k1;

-- Test 4: Virtual column in CTE
[UC]with t as (
    select _tablet_id_, k1, k2 from empty_table
)
select * from t order by k1;

-- Test 5: Virtual column with UNION
create table table2 (
    k1 int,
    k2 int
)
duplicate key(k1)
distributed by hash(k1) buckets 1
properties("replication_num" = "1");

insert into table2 values (2, 20);

[UC]select _tablet_id_, k1, k2 from empty_table
union all
select _tablet_id_, k1, k2 from table2
order by k1;

-- Test 6: Virtual column with window function
[UC]select k1, k2, _tablet_id_,
    row_number() over (partition by _tablet_id_ order by k1) as rn
from empty_table
order by k1;

-- Test 7: Virtual column in HAVING clause
[UC]select _tablet_id_, count(*) as cnt
from empty_table
group by _tablet_id_
having count(*) > 0
order by _tablet_id_;

-- Test 8: Virtual column with DISTINCT
[UC]select distinct _tablet_id_ from empty_table order by _tablet_id_;

-- Test 9: Virtual column type should be BIGINT
[UC]select typeof(_tablet_id_) as col_type, _tablet_id_ from empty_table limit 1;

-- Test 10: Multiple virtual columns in same query (only _tablet_id_ is supported)
[UC]select _tablet_id_ as t1, _tablet_id_ as t2, k1, k2 from empty_table order by k1;

-- Cleanup
drop table if exists empty_table;
drop table if exists table2;
drop database if exists test_virtual_column_db;

