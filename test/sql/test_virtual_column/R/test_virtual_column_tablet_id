-- name: test_virtual_column_tablet_id
create database if not exists test_virtual_column_db;
-- result:
-- !result
use test_virtual_column_db;
-- result:
-- !result
create table olap_table (
    k1 int,
    k2 int,
    v1 string
)
duplicate key(k1)
distributed by hash(k1) buckets 3
properties("replication_num" = "1");
-- result:
-- !result
insert into olap_table values
(1, 10, 'a'),
(2, 20, 'b'),
(3, 30, 'c'),
(4, 40, 'd'),
(5, 50, 'e');
-- result:
-- !result
[UC]select _tablet_id_, k1, k2 from olap_table order by k1;
-- result:
12136474	1	10
12136472	2	20
12136474	3	30
12136476	4	40
12136476	5	50
-- !result
select * from olap_table order by k1;
-- result:
1	10	a
2	20	b
3	30	c
4	40	d
5	50	e
-- !result
[UC]select _tablet_id_, count(*) as row_count, sum(k2) as sum_k2
from olap_table
group by _tablet_id_
order by _tablet_id_;
-- result:
12136472	1	20
12136474	2	40
12136476	2	90
-- !result
[UC]select _tablet_id_, min(k1) as min_k1, max(k1) as max_k1, count(*) as cnt
from olap_table
group by _tablet_id_
order by _tablet_id_;
-- result:
12136472	2	2	1
12136474	1	3	2
12136476	4	5	2
-- !result
[UC]select k1, k2, _tablet_id_ from olap_table where _tablet_id_ > 0 order by k1;
-- result:
1	10	12136474
2	20	12136472
3	30	12136474
4	40	12136476
5	50	12136476
-- !result
desc olap_table;
-- result:
k1	int	YES	true	None	
k2	int	YES	false	None	
v1	varchar(65533)	YES	false	None	
-- !result
show create table olap_table;
-- result:
olap_table	CREATE TABLE `olap_table` (
  `k1` int(11) NULL COMMENT "",
  `k2` int(11) NULL COMMENT "",
  `v1` varchar(65533) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 3 
PROPERTIES (
"compression" = "LZ4",
"fast_schema_evolution" = "true",
"replicated_storage" = "true",
"replication_num" = "1"
);
-- !result
[UC]select a._tablet_id_ as tablet_id_a, b._tablet_id_ as tablet_id_b, a.k1, a.k2, b.k2 as k2_b
from olap_table a
join olap_table b on a.k1 = b.k1
order by a.k1
limit 5;
-- result:
12136474	12136474	1	10	10
12136472	12136472	2	20	20
12136474	12136474	3	30	30
12136476	12136476	4	40	40
12136476	12136476	5	50	50
-- !result
[UC]select k1, k2, _tablet_id_ from olap_table order by _tablet_id_, k1;
-- result:
2	20	12136472
1	10	12136474
3	30	12136474
4	40	12136476
5	50	12136476
-- !result
[UC]select _tablet_id_, k1, k2 from olap_table order by k1 limit 3;
-- result:
12136474	1	10
12136472	2	20
12136474	3	30
-- !result
create table olap_table_with_tablet_id (
    k1 int,
    _tablet_id_ bigint,
    v1 string
)
duplicate key(k1)
distributed by hash(k1) buckets 3
properties("replication_num" = "1");
-- result:
-- !result
insert into olap_table_with_tablet_id values
(1, 100, 'a'),
(2, 200, 'b'),
(3, 300, 'c');
-- result:
-- !result
select _tablet_id_, k1, v1 from olap_table_with_tablet_id order by k1;
-- result:
100	1	a
200	2	b
300	3	c
-- !result
desc olap_table_with_tablet_id;
-- result:
k1	int	YES	true	None	
_tablet_id_	bigint(20)	YES	false	None	
v1	varchar(65533)	YES	false	None	
-- !result
show create table olap_table_with_tablet_id;
-- result:
olap_table_with_tablet_id	CREATE TABLE `olap_table_with_tablet_id` (
  `k1` int(11) NULL COMMENT "",
  `_tablet_id_` bigint(20) NULL COMMENT "",
  `v1` varchar(65533) NULL COMMENT ""
) ENGINE=OLAP 
DUPLICATE KEY(`k1`)
DISTRIBUTED BY HASH(`k1`) BUCKETS 3 
PROPERTIES (
"compression" = "LZ4",
"fast_schema_evolution" = "true",
"replicated_storage" = "true",
"replication_num" = "1"
);
-- !result
select k1, v1, _tablet_id_ from olap_table_with_tablet_id where _tablet_id_ > 150 order by k1;
-- result:
2	b	200
3	c	300
-- !result
select _tablet_id_, count(*) as cnt, sum(k1) as sum_k1
from olap_table_with_tablet_id
group by _tablet_id_
order by _tablet_id_;
-- result:
100	1	1
200	1	2
300	1	3
-- !result
select * from olap_table_with_tablet_id order by k1;
-- result:
1	100	a
2	200	b
3	300	c
-- !result
drop table if exists olap_table;
-- result:
-- !result
drop table if exists olap_table_with_tablet_id;
-- result:
-- !result
drop database if exists test_virtual_column_db;
-- result:
-- !result