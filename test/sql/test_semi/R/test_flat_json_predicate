-- name: test_normal_flat_json_predicate @system
CREATE TABLE js2 (
    v1 BIGINT NULL,
    j1 JSON NULL
)
DUPLICATE KEY (v1)
DISTRIBUTED BY HASH(`v1`) BUCKETS 1
PROPERTIES ( "replication_num" = "1" );
-- result:
-- !result
CREATE TABLE js3 (
    v1 BIGINT NULL,
    j1 JSON NULL
)
DUPLICATE KEY (v1)
DISTRIBUTED BY HASH(`v1`) BUCKETS 1
PROPERTIES ( "replication_num" = "1" );
-- result:
-- !result
set enable_profile = true;
-- result:
-- !result
set cbo_json_v2_rewrite = true;
-- result:
-- !result
create view profile_late_materialize as
select trim(unnest) 
from table(unnest(split(get_query_profile(last_query_id()), '\n')))
where unnest like '%LateMaterialize%' 
order by unnest;
-- result:
-- !result
create view profile_filter_rows as
select trim(unnest) 
from table(unnest(split(get_query_profile(last_query_id()), '\n')))
where unnest like '%FilterRows%' AND CAST(REGEXP_EXTRACT(unnest, '(\\d+)', 1) AS INT) != 0
order by unnest;
-- result:
-- !result
create view profile_dict as
select trim(unnest) 
from table(unnest(split(get_query_profile(last_query_id()), '\n')))
where unnest like '%DictDecodeCount%' AND CAST(REGEXP_EXTRACT(unnest, '(\\d+)', 1) AS INT) != 0
order by unnest;
-- result:
-- !result
insert into js2 
select 
    generate_series, 
    json_object('f1', generate_series)
from (table(generate_series(1, 1000)));
-- result:
-- !result
select * from js2 where get_json_int(j1, '$.f1') = -1;
-- result:
-- !result
select * from profile_filter_rows;
-- result:
- ZoneMapIndexFilterRows: 1.000K (1000)
-- !result
select * from js2 where get_json_int(j1, '$.f1') = 1;
-- result:
1	{"f1": 1}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 999
-- !result
select * from js2 where get_json_int(j1, '$.f1') = 1 or get_json_int(j1, '$.f1') = 2;
-- result:
1	{"f1": 1}
2	{"f1": 2}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 998
-- !result
select * from js2 where get_json_int(j1, '$.f1') in (1, 2, 3, 4);
-- result:
1	{"f1": 1}
2	{"f1": 2}
3	{"f1": 3}
4	{"f1": 4}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 996
-- !result
select get_json_int(j1, '$.f1') from js2 where get_json_int(j1, '$.f1') = -1;
-- result:
-- !result
select get_json_int(j1, '$.f1') from js2 where get_json_int(j1, '$.f1') = 1;
-- result:
1
-- !result
select get_json_int(j1, '$.f1') from js2 where get_json_int(j1, '$.f1') = 1 or get_json_int(j1, '$.f1') = 2;
-- result:
1
2
-- !result
select get_json_int(j1, '$.f1') from js2 where get_json_int(j1, '$.f1') in (1, 2, 3, 4);
-- result:
1
2
3
4
-- !result
insert into js2 
select 
    generate_series, 
    json_object('f2', generate_series)
from (table(generate_series(1, 1000)));
-- result:
-- !result
select * from js2 where get_json_int(j1, '$.f1') = -1;
-- result:
-- !result
select * from profile_filter_rows;
-- result:
- ZoneMapIndexFilterRows: 1.000K (1000)
- PredFilterRows: 1.000K (1000)
-- !result
select * from js2 where get_json_int(j1, '$.f1') = 1;
-- result:
1	{"f1": 1}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 1.999K (1999)
-- !result
select * from js2 where get_json_int(j1, '$.f1') = 1 or get_json_int(j1, '$.f1') = 2;
-- result:
1	{"f1": 1}
2	{"f1": 2}
-- !result
select * from profile_filter_rows;
-- result:
-- !result
select * from js2 where get_json_int(j1, '$.f1') in (1, 2, 3, 4);
-- result:
1	{"f1": 1}
2	{"f1": 2}
3	{"f1": 3}
4	{"f1": 4}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 1.996K (1996)
-- !result
select * from js2 where get_json_int(j1, '$.f2') = -1;
-- result:
-- !result
select * from profile_filter_rows;
-- result:
- ZoneMapIndexFilterRows: 1.000K (1000)
- PredFilterRows: 1.000K (1000)
-- !result
select * from js2 where get_json_int(j1, '$.f2') = 1;
-- result:
1	{"f2": 1}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 1.999K (1999)
-- !result
select * from js2 where get_json_int(j1, '$.f2') = 1 or get_json_int(j1, '$.f2') = 2;
-- result:
1	{"f2": 1}
2	{"f2": 2}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 1.998K (1998)
-- !result
select * from js2 where get_json_int(j1, '$.f2') in (1, 2, 3, 4);
-- result:
1	{"f2": 1}
2	{"f2": 2}
3	{"f2": 3}
4	{"f2": 4}
-- !result
select * from profile_filter_rows;
-- result:
- PredFilterRows: 1.996K (1996)
-- !result
insert into js2 
select 
    generate_series, 
    json_object('f1', generate_series, 'f2', generate_series)
from (table(generate_series(1, 1000)));
-- result:
-- !result
select count(get_json_int(j1, '$.f2')) from js2 where get_json_int(j1, '$.f1') < 100;
-- result:
99
-- !result
select * from profile_late_materialize;
-- result:
-- !result
insert into js3
select 
    generate_series, 
    json_object('f1', concat('a', generate_series%10))
from (table(generate_series(1, 1000)));
-- result:
-- !result
select count(*) from js3 where get_json_string(j1, 'f1') = 'a0';
-- result:
100
-- !result
select * from profile_dict;
-- result:
-- !result
select count(*) from js3 where get_json_string(j1, 'f1') = 'a0';
-- result:
100
-- !result
select * from profile_dict;
-- result:
-- !result