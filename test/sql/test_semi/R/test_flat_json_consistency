-- name: test_flat_json_consistency
CREATE TABLE `test_json_cast_map` (
  `c1` bigint(20) NULL COMMENT "",
  `c2` json NULL COMMENT ""
) DISTRIBUTED BY HASH(c1) BUCKETS 1;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(2, '{"level1": {"level2": {"level3": {"level4": {}}}}}'),
(9, '{"100": {"200": {"300": "abc"}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"level4": {}}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), 100.200.300(VARCHAR), level1.level2.level3.level4.5(VARCHAR), remain(JSON)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(2, '{"level1": {"level2": {"level3": {"level4": {}}}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"level4": {}}}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), level1.level2.level3.level4.5(VARCHAR), remain(JSON)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(9, '{"100": {"200": {"300": "abc"}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), 100.200.300(VARCHAR), level1.level2.level3.level4.5(VARCHAR)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(2, '{"level1": {"level2": {"level3": {"level4": {"5":"def"}}}}}'),
(3, '{"level1": {"level2": {"level3": {"level4": {"6":"ghi"}}}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"level4": {"5": "def"}}}}}
3	{"level1": {"level2": {"level3": {"level4": {"6": "ghi"}}}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), level1.level2.level3.level4.5(VARCHAR), level1.level2.level3.level4.6(VARCHAR)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(2, '{"level1": {"level2": {"level3": {"level4": {}}}}}'),
(9, '{"100": {"200": {"300": "abc"}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
2	{"level1": {"level2": {"level3": {"level4": {}}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), 100.200.300(VARCHAR), remain(JSON)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(2, '{"level1": {"level2": {"level3": {"level4": {}}}}}'),
(3, '{"level1": {"level2": {"level3": {}}}}'),
(4, '{"level1": {"level2": {}}}'),
(5, '{"level1": {}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"level4": {}}}}}
3	{"level1": {"level2": {"level3": {}}}}
4	{"level1": {"level2": {}}}
5	{"level1": {}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
[]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(5, '{"level1": {}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
5	{"level1": {}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), level1.level2.level3.level4.5(VARCHAR), remain(JSON)"]
-- !result
truncate table test_json_cast_map;
-- result:
-- !result
insert into test_json_cast_map values
(1, '{"100": {}}'),
(9, '{"100": {"200": {"300": "abc"}}}');
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"100": {}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
select flat_json_meta(c2) from test_json_cast_map [_META_];
-- result:
["nulls(TINYINT), 100.200.300(VARCHAR), remain(JSON)"]
-- !result
CREATE TABLE source_data(c1 int, c2 json);
-- result:
-- !result
insert into source_data values
(1, '{"level1": {"level2": {"level3": {"level4": {"5":"abc"}}}}}'),
(2, '{"level1": {"level2": {"level3": {"4":23234982794}}}}'),
(3, '{"level1": {"level2": {"level3": {"4":true}}}}'),
(4, '{"level1": {"level2": {"level3": {"4":null}}}}'),
(5, '{"level1": {"level2": {"level3": {"4":["abc", 100, 200]}}}}'),
(6, '{"level1": {"level2": {"level3": {"4":{"5": "abc"}}}}}'),
(7, '{"level1": {"level2": {"level3": "abc"}}}'),
(8, '{"100": {"200": {"300": {"500":"abc"}}}}'),
(9, '{"100": {"200": {"300": "abc"}}}');
-- result:
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE test_json_cast_map (c1 int, c2 json) 
DISTRIBUTED BY RANDOM BUCKETS 1;
-- result:
-- !result
insert into test_json_cast_map select * from source_data;
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"4": 23234982794}}}}
3	{"level1": {"level2": {"level3": {"4": true}}}}
4	{"level1": {"level2": {"level3": {"4": null}}}}
5	{"level1": {"level2": {"level3": {"4": ["abc", 100, 200]}}}}
6	{"level1": {"level2": {"level3": {"4": {"5": "abc"}}}}}
7	{"level1": {"level2": {"level3": "abc"}}}
8	{"100": {"200": {"300": {"500": "abc"}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE test_json_cast_map (c1 int, c2 json) 
DISTRIBUTED BY RANDOM BUCKETS 2;
-- result:
-- !result
insert into test_json_cast_map select * from source_data;
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"4": 23234982794}}}}
3	{"level1": {"level2": {"level3": {"4": true}}}}
4	{"level1": {"level2": {"level3": {"4": null}}}}
5	{"level1": {"level2": {"level3": {"4": ["abc", 100, 200]}}}}
6	{"level1": {"level2": {"level3": {"4": {"5": "abc"}}}}}
7	{"level1": {"level2": {"level3": "abc"}}}
8	{"100": {"200": {"300": {"500": "abc"}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE test_json_cast_map (c1 int, c2 json) 
DISTRIBUTED BY RANDOM BUCKETS 3;
-- result:
-- !result
insert into test_json_cast_map select * from source_data;
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"4": 23234982794}}}}
3	{"level1": {"level2": {"level3": {"4": true}}}}
4	{"level1": {"level2": {"level3": {"4": null}}}}
5	{"level1": {"level2": {"level3": {"4": ["abc", 100, 200]}}}}
6	{"level1": {"level2": {"level3": {"4": {"5": "abc"}}}}}
7	{"level1": {"level2": {"level3": "abc"}}}
8	{"100": {"200": {"300": {"500": "abc"}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE test_json_cast_map (c1 int, c2 json)
DISTRIBUTED BY RANDOM BUCKETS 4;
-- result:
-- !result
insert into test_json_cast_map select * from source_data;
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"4": 23234982794}}}}
3	{"level1": {"level2": {"level3": {"4": true}}}}
4	{"level1": {"level2": {"level3": {"4": null}}}}
5	{"level1": {"level2": {"level3": {"4": ["abc", 100, 200]}}}}
6	{"level1": {"level2": {"level3": {"4": {"5": "abc"}}}}}
7	{"level1": {"level2": {"level3": "abc"}}}
8	{"100": {"200": {"300": {"500": "abc"}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE test_json_cast_map (c1 int, c2 json)
DISTRIBUTED BY RANDOM BUCKETS 5;
-- result:
-- !result
insert into test_json_cast_map select * from source_data;
-- result:
-- !result
select * from test_json_cast_map order by c1;
-- result:
1	{"level1": {"level2": {"level3": {"level4": {"5": "abc"}}}}}
2	{"level1": {"level2": {"level3": {"4": 23234982794}}}}
3	{"level1": {"level2": {"level3": {"4": true}}}}
4	{"level1": {"level2": {"level3": {"4": null}}}}
5	{"level1": {"level2": {"level3": {"4": ["abc", 100, 200]}}}}
6	{"level1": {"level2": {"level3": {"4": {"5": "abc"}}}}}
7	{"level1": {"level2": {"level3": "abc"}}}
8	{"100": {"200": {"300": {"500": "abc"}}}}
9	{"100": {"200": {"300": "abc"}}}
-- !result
drop table test_json_cast_map;
-- result:
-- !result
CREATE TABLE t_flat_json_remain (c1 int, c2 json)
DISTRIBUTED BY HASH(c1) BUCKETS 1;
-- result:
-- !result
insert into t_flat_json_remain values
(1, '{"k9": {"k2": {"k0": "A", "k1": "B", "k2": -1, "k3": 2, "k4": "Z"}}}');
-- result:
-- !result
select flat_json_meta(c2) from t_flat_json_remain [_META_];
-- result:
["nulls(TINYINT), k9.k2.k0(VARCHAR), k9.k2.k1(VARCHAR), k9.k2.k2(BIGINT), k9.k2.k3(BIGINT), k9.k2.k4(VARCHAR)"]
-- !result
select c2 -> '$.k9' from t_flat_json_remain;
-- result:
{"k2": {"k0": "A", "k1": "B", "k2": -1, "k3": 2, "k4": "Z"}}
-- !result
select c2 -> '$.k9.k2' from t_flat_json_remain;
-- result:
{"k0": "A", "k1": "B", "k2": -1, "k3": 2, "k4": "Z"}
-- !result
select c2 -> '$.k9.k2.k2' from t_flat_json_remain;
-- result:
-1
-- !result
truncate table t_flat_json_remain;
-- result:
-- !result
insert into t_flat_json_remain values
(1, '{"k9": {"k2": {"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}}}'),
(2, '{"k9": {"k2": {"k0": "A", "k4": "Z"}}}');
-- result:
-- !result
select flat_json_meta(c2) from t_flat_json_remain [_META_];
-- result:
["nulls(TINYINT), k9.k2.k0(VARCHAR), k9.k2.k1(VARCHAR), k9.k2.k2(BIGINT), k9.k2.k3(BIGINT), k9.k2.k4(VARCHAR)"]
-- !result
select c1, c2 -> '$.k9.k2' from t_flat_json_remain order by c1;
-- result:
1	{"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}
2	{"k0": "A", "k4": "Z"}
-- !result
truncate table t_flat_json_remain;
-- result:
-- !result
insert into t_flat_json_remain values
(1, '{"k9": {"k2": {"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}}}'),
(2, '{"k9": {"k2": "JSON"}}');
-- result:
-- !result
select flat_json_meta(c2) from t_flat_json_remain [_META_];
-- result:
["nulls(TINYINT), k9.k2(JSON), remain(JSON)"]
-- !result
select c1, c2 -> '$.k9' from t_flat_json_remain order by c1;
-- result:
1	{"k2": {"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}}
2	{"k2": "JSON"}
-- !result
select c1, c2 -> '$.k9.k2' from t_flat_json_remain order by c1;
-- result:
1	{"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}
2	"JSON"
-- !result
select c1, c2 -> '$.k9.k2.k0' from t_flat_json_remain order by c1;
-- result:
1	"A"
2	None
-- !result
truncate table t_flat_json_remain;
-- result:
-- !result
insert into t_flat_json_remain values
(1, '{"k9": {"k2": {"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}}}'),
(2, '{"k9": {"k1": "JSON"}}');
-- result:
-- !result
select flat_json_meta(c2) from t_flat_json_remain [_META_];
-- result:
["nulls(TINYINT), k9.k1(VARCHAR), k9.k2.k0(VARCHAR), k9.k2.k1(VARCHAR), k9.k2.k2(BIGINT), k9.k2.k3(BIGINT), k9.k2.k4(VARCHAR)"]
-- !result
select c1, c2 -> '$.k9' from t_flat_json_remain order by c1;
-- result:
1	{"k2": {"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}}
2	{"k1": "JSON"}
-- !result
select c1, c2 -> '$.k9.k1' from t_flat_json_remain order by c1;
-- result:
1	None
2	"JSON"
-- !result
select c1, c2 -> '$.k9.k2' from t_flat_json_remain order by c1;
-- result:
1	{"k0": "A", "k1": "B", "k2": 10, "k3": 20, "k4": "Z"}
2	{}
-- !result
select c1, c2 -> '$.k9.k2.k0' from t_flat_json_remain order by c1;
-- result:
1	"A"
2	None
-- !result
drop table t_flat_json_remain;
-- result:
-- !result