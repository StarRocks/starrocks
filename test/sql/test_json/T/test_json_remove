-- name: test_json_remove
CREATE DATABASE test_json_remove;
USE test_json_remove;

-- Test basic json_remove functionality with literal JSON strings
SELECT json_remove('{"a": 1, "b": 2, "c": 3}', '$.a') as remove_single_key;
SELECT json_remove('{"a": 1, "b": 2, "c": 3}', '$.a', '$.c') as remove_multiple_keys;
SELECT json_remove('{"a": 1, "b": [10, 20, 30]}', '$.b[1]') as remove_array_element;

-- Test with nested objects
SELECT json_remove('{"a": {"x": 1, "y": 2}, "b": 3}', '$.a.x') as remove_nested_key;
SELECT json_remove('{"level1": {"level2": {"level3": "value"}}}', '$.level1.level2') as remove_nested_object;

-- Test edge cases
SELECT json_remove('{"a": 1, "b": 2}', '$.nonexistent') as remove_nonexistent_key;
SELECT json_remove('{"a": 1, "b": 2}', 'invalid_path') as remove_invalid_path;
SELECT json_remove('{"a": 1, "b": 2}', '$.a', '$.nonexistent', '$.b') as remove_mixed_paths;

-- Test with empty objects and arrays
SELECT json_remove('{}', '$.a') as remove_from_empty_object;
SELECT json_remove('{"a": 1}', '$.a') as remove_all_keys;
SELECT json_remove('{"a": []}', '$.a') as remove_empty_array;

-- Test with various JSON data types
SELECT json_remove('{"str": "hello", "num": 42, "bool": true, "null": null}', '$.str', '$.bool') as remove_various_types;

-- Test with complex nested structures
SELECT json_remove('{"users": [{"id": 1, "name": "John"}, {"id": 2, "name": "Jane"}], "count": 2}', '$.count') as remove_from_complex;

-- Create a table to test with JSON columns
CREATE TABLE json_test_table (
  id INT,
  json_data JSON
) DUPLICATE KEY(id);

-- Insert test data
INSERT INTO json_test_table VALUES
(1, parse_json('{"name": "Alice", "age": 30, "city": "New York"}')),
(2, parse_json('{"name": "Bob", "age": 25, "city": "San Francisco", "hobbies": ["reading", "gaming"]}')),
(3, parse_json('{"product": "laptop", "price": 999.99, "specs": {"cpu": "Intel", "ram": "16GB"}}')),
(4, parse_json('{"empty": {}, "array": [1, 2, 3, 4, 5]}')),
(5, parse_json('null'));

-- Test json_remove with table data
SELECT id, json_remove(json_data, '$.age') as without_age FROM json_test_table WHERE id = 1;
SELECT id, json_remove(json_data, '$.city', '$.hobbies') as filtered_data FROM json_test_table WHERE id = 2;
SELECT id, json_remove(json_data, '$.specs.ram') as without_ram FROM json_test_table WHERE id = 3;
SELECT id, json_remove(json_data, '$.array[2]', '$.array[3]') as removed_elements FROM json_test_table WHERE id = 4;

-- Test with NULL JSON data
SELECT id, json_remove(json_data, '$.any') as null_result FROM json_test_table WHERE id = 5;

-- Test json_remove with multiple paths on table data
SELECT id, json_remove(json_data, '$.name', '$.city') as minimal_data FROM json_test_table WHERE id <= 2 ORDER BY id;

-- Test combining json_remove with other JSON functions
SELECT json_length(json_remove('{"a": 1, "b": 2, "c": 3}', '$.b')) as length_after_remove;
SELECT json_keys(json_remove('{"x": 1, "y": 2, "z": 3}', '$.y')) as keys_after_remove;
SELECT json_exists(json_remove('{"a": 1, "b": 2}', '$.a'), '$.a') as exists_after_remove;

-- Test with parse_json
SELECT json_remove(parse_json('{"temp": "data", "keep": "this"}'), '$.temp') as parsed_and_removed;

-- Test error handling and edge cases
SELECT json_remove('{"a": 1}', '$') as root_path;
SELECT json_remove('{"a": 1}', '$.') as dot_path;

-- Test with deeply nested structure
SELECT json_remove('{"a": {"b": {"c": {"d": {"e": "deep"}}}}}', '$.a.b.c.d') as remove_deep_nested;

-- Test removing from arrays at different positions
SELECT json_remove('{"arr": [0, 1, 2, 3, 4]}', '$.arr[0]') as remove_first_element;
SELECT json_remove('{"arr": [0, 1, 2, 3, 4]}', '$.arr[4]') as remove_last_element;
SELECT json_remove('{"arr": [0, 1, 2, 3, 4]}', '$.arr[2]') as remove_middle_element;

-- Test with string values containing special characters
SELECT json_remove('{"key with spaces": "value", "normal": "data"}', '$."key with spaces"') as remove_special_key;

-- Clean up
DROP TABLE json_test_table;
DROP DATABASE test_json_remove;