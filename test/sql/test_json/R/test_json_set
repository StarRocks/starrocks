-- name: test_json_set
CREATE DATABASE IF NOT EXISTS test_json_set_db;
-- result:
-- !result

USE test_json_set_db;
-- result:
-- !result

SELECT json_set('{"a": 1, "b": 2}', '$.a', 10) as update_existing;
-- result:
{"a": 10, "b": 2}
-- !result

SELECT json_set('{"a": 1}', '$.b', 2) as insert_new;
-- result:
{"a": 1, "b": 2}
-- !result

SELECT json_set('{"a": 1, "b": 2}', '$.a', 10, '$.c', 3) as mixed_ops;
-- result:
{"a": 10, "b": 2, "c": 3}
-- !result

SELECT json_set('{"a": {"x": 1, "y": 2}}', '$.a.x', 100) as update_nested;
-- result:
{"a": {"x": 100, "y": 2}}
-- !result

SELECT json_set('{"a": {"x": 1}}', '$.a.y', 200) as insert_nested;
-- result:
{"a": {"x": 1, "y": 200}}
-- !result

SELECT json_set('{"level1": {"level2": {"target": "old"}}}', '$.level1.level2.target', "new") as deep_update;
-- result:
{"level1": {"level2": {"target": "new"}}}
-- !result

SELECT json_set('{"arr": [10, 20, 30]}', '$.arr[1]', 99) as update_array_index;
-- result:
{"arr": [10, 99, 30]}
-- !result

SELECT json_set('{"arr": [10, 20]}', '$.arr[100]', 30) as append_array;
-- result:
{"arr": [10, 20, 30]}
-- !result

SELECT json_set('[1, 2, 3]', '$[0]', 9) as root_array_update;
-- result:
[9, 2, 3]
-- !result

SELECT json_set('{"a": 1}', '$.a.b', 2) as set_on_scalar;
-- result:
{"a": 1}
-- !result

SELECT json_set('{"a": 1}', '$.missing_parent.child', 2) as missing_parent;
-- result:
{"a": 1}
-- !result

SELECT json_set('{"a": 1}', '$', '{"new": "doc"}') as replace_root;
-- result:
{"new": "doc"}
-- !result

SELECT if(json_set('{"k": "old"}', '$.k', null) IS NULL, 'NULL_OK', 'FAIL') as set_sql_null;
-- result:
NULL_OK
-- !result

SELECT json_set('{"k": "old"}', '$.k', parse_json('null')) as set_json_null;
-- result:
{"k": "null"}
-- !result

SELECT json_set('{"k": "old"}', '$.k', true) as set_bool;
-- result:
{"k": true}
-- !result

SELECT json_set('{"k": "old"}', '$.k', parse_json('{"sub": "json"}')) as set_json_object;
-- result:
{"k": {"sub": "json"}}
-- !result

SELECT json_set('{"k": "old"}', '$.k', 123.456) as set_double;
-- result:
{"k": 123.456}
-- !result

SELECT json_set('{"a": 1}', '$.a', 10, '$.b', 20, '$.a', 30) as chain_override;
-- result:
{"a": 30, "b": 20}
-- !result

CREATE TABLE json_set_test_table (
    id INT, 
    data JSON
) DUPLICATE KEY(id)
PROPERTIES("replication_num" = "1");
-- result:
-- !result

INSERT INTO json_set_test_table VALUES 
(1, parse_json('{"name": "Alice", "tags": ["A"]}')),
(2, parse_json('{"name": "Bob", "score": 10}')),
(3, NULL),
(4, parse_json('{}'));
-- result:
-- !result

SELECT id, json_set(data, '$.score', 100) FROM json_set_test_table WHERE id = 2;
-- result:
2	{"name": "Bob", "score": 100}
-- !result

SELECT id, json_set(data, '$.city', 'Wonderland') FROM json_set_test_table WHERE id = 1;
-- result:
1	{"city": "Wonderland", "name": "Alice", "tags": ["A"]}
-- !result

SELECT id, json_set(data, '$.tags[1]', 'B') FROM json_set_test_table WHERE id = 1;
-- result:
1	{"name": "Alice", "tags": ["A", "B"]}
-- !result

SELECT id, if(json_set(data, '$.a', 1) IS NULL, 'NULL_OK', 'FAIL') FROM json_set_test_table WHERE id = 3;
-- result:
3	NULL_OK
-- !result

SELECT if(json_set(null, '$.a', 1) IS NULL, 'NULL_OK', 'FAIL') as null_doc;
-- result:
NULL_OK
-- !result

SELECT if(json_set('{"a": 1}', null, 1) IS NULL, 'NULL_OK', 'FAIL') as null_path;
-- result:
NULL_OK
-- !result

SELECT if(json_set('{"a": 1}', '$.a', 1, null, 2) IS NULL, 'NULL_OK', 'FAIL') as null_path_arg2;
-- result:
NULL_OK
-- !result

SELECT json_set('{"a": 1}', '$."key.with.dot"', 2) as escaped_key;
-- result:
{"a": 1, "key.with.dot": 2}
-- !result

SELECT json_set('{"a": [1, 2]}', '$.a[*]', 10);
-- result:
{"a": [1, 2]}
-- !result

DROP TABLE json_set_test_table;
-- result:
-- !result

DROP DATABASE test_json_set_db;
-- result:
-- !result