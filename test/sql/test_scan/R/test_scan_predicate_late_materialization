-- name: test_predicate_late_materialization 
drop table if exists predicate_lm_v1_sparse;
-- result:
-- !result
drop table if exists predicate_lm_v2_low_full;
-- result:
-- !result
drop table if exists predicate_lm_v2_low_half_null;
-- result:
-- !result
drop table if exists predicate_lm_v2_high_half_null;
-- result:
-- !result
drop table if exists predicate_lm_v2_high_full;
-- result:
-- !result
create table predicate_lm_v1_sparse (
    id int,
    col_string string,
    col_int int
)
duplicate key(id)
distributed by hash(id)
properties(
    "replication_num" = "1"
);
-- result:
-- !result
create table predicate_lm_v2_low_full (
    id int,
    col_string string not null,
    col_int int
)
duplicate key(id)
distributed by hash(id)
properties(
    "replication_num" = "1"
);
-- result:
-- !result
create table predicate_lm_v2_low_half_null (
    id int,
    col_string string,
    col_int int
)
duplicate key(id)
distributed by hash(id)
properties(
    "replication_num" = "1"
);
-- result:
-- !result
create table predicate_lm_v2_high_half_null (
    id int,
    col_string string,
    col_int int
)
duplicate key(id)
distributed by hash(id)
properties(
    "replication_num" = "1"
);
-- result:
-- !result
create table predicate_lm_v2_high_full (
    id int,
    col_string string not null,
    col_int int
)
duplicate key(id)
distributed by hash(id)
properties(
    "replication_num" = "1"
);
-- result:
-- !result
insert into predicate_lm_v1_sparse
select id,
       if(id <= 5900, NULL, if(id % 2 = 0, 'xxx', 'abc')),
       id
from table(generate_series(1, 6000)) gen(id);
-- result:
-- !result
insert into predicate_lm_v2_low_full
select id,
       if(id % 4 = 0, 'abc', 'xxx'),
       id
from table(generate_series(1, 8000)) gen(id);
-- result:
-- !result
insert into predicate_lm_v2_low_half_null
select id,
       case
           when id % 2 then NULL
           when id % 5 = 0 then 'abc'
           else 'xxx'
       end,
       id
from table(generate_series(1, 8000)) gen(id);
-- result:
-- !result
insert into predicate_lm_v2_high_half_null
select id,
       case
           when id % 2  then NULL
           when id % 177 then 'xxx'
           else concat('value_', id)
       end,
       id
from table(generate_series(1, 12000)) gen(id);
-- result:
-- !result
insert into predicate_lm_v2_high_full
select id,
       case
           when id % 177 then 'xxx'
           else concat('value_', id)
       end,
       id
from table(generate_series(1, 9000)) gen(id);
-- result:
-- !result
sync;
-- result:
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v1_sparse where col_string like 'xxx';
-- result:
50
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v1_sparse where col_string like 'xxx';
-- result:
50
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_full where col_string like 'xxx';
-- result:
6000
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_full where col_string like 'xxx';
-- result:
6000
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_half_null where col_string like 'xxx';
-- result:
3200
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_half_null where col_string like 'xxx';
-- result:
3200
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set cbo_enable_low_cardinality_optimize = false;
-- result:
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_half_null where col_string like 'xxx';
-- result:
3200
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v2_low_half_null where col_string like 'xxx';
-- result:
3200
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v2_high_half_null where col_string like 'xxx';
-- result:
5967
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
select count(*) from predicate_lm_v2_high_full where col_string != '' and col_int % 2 = 0;
-- result:
4500
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v2_high_half_null where col_string like 'xxx';
-- result:
5967
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
select count(*) from predicate_lm_v2_high_full where col_string != '' and col_int % 2 = 0;
-- result:
4500
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx';
-- result:
8950
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
select count(*) from predicate_lm_v2_high_full where col_string != '' and col_int % 2 = 0;
-- result:
4500
-- !result
set enable_predicate_col_late_materialize = false;
-- result:
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx';
-- result:
8950
-- !result
select count(*) from predicate_lm_v2_high_full where col_string like 'xxx' and col_int % 2 = 0;
-- result:
4475
-- !result
select count(*) from predicate_lm_v2_high_full where col_string != '' and col_int % 2 = 0;
-- result:
4500
-- !result
set enable_predicate_col_late_materialize = true;
-- result:
-- !result
drop table if exists predicate_lm_v1_sparse;
-- result:
-- !result
drop table if exists predicate_lm_v2_low_full;
-- result:
-- !result
drop table if exists predicate_lm_v2_low_half_null;
-- result:
-- !result
drop table if exists predicate_lm_v2_high_half_null;
-- result:
-- !result
drop table if exists predicate_lm_v2_high_full;
-- result:
-- !result