-- name: test_iceberg_partition_column_position

create external catalog ice_cat_${uuid0}
properties
(
    "type" = "iceberg",
    "iceberg.catalog.type" = "hive",
    "hive.metastore.uris" = "${iceberg_catalog_hive_metastore_uris}"
);
set catalog ice_cat_${uuid0};
create database ice_db_${uuid0};
use ice_db_${uuid0};

-- test partition column at the beginning
create table test_part_beginning (
  dt date,
  id bigint,
  data string
)
partition by (dt);

insert into test_part_beginning values ('2023-01-01', 1, 'data1');
insert into test_part_beginning values ('2023-01-02', 2, 'data2');
select * from test_part_beginning order by id;
drop table test_part_beginning force;

-- test partition column in the middle
create table test_part_middle (
  id bigint,
  dt date,
  data string
)
partition by (dt);

insert into test_part_middle values (1, '2023-01-01', 'data1');
insert into test_part_middle values (2, '2023-01-02', 'data2');
select * from test_part_middle order by id;
drop table test_part_middle force;

-- test partition column at the end
create table test_part_end (
  id bigint,
  data string,
  dt date
)
partition by (dt);

insert into test_part_end values (1, 'data1', '2023-01-01');
insert into test_part_end values (2, 'data2', '2023-01-02');
select * from test_part_end order by id;
drop table test_part_end force;

-- test multiple partition columns at different positions
create table test_multi_part (
  id bigint,
  dt date,
  region string,
  data string
)
partition by (dt, region);

insert into test_multi_part values (1, '2023-01-01', 'east', 'data1');
insert into test_multi_part values (2, '2023-01-02', 'west', 'data2');
select * from test_multi_part order by id;
drop table test_multi_part force;

-- test partition column at the beginning with year transform
create table test_part_year_beginning (
  dt date,
  id bigint,
  data string
)
partition by year(dt);

insert into test_part_year_beginning values ('2023-01-01', 1, 'data1');
insert into test_part_year_beginning values ('2024-01-01', 2, 'data2');
select * from test_part_year_beginning order by id;
drop table test_part_year_beginning force;

-- test partition column in the middle with month transform
create table test_part_month_middle (
  id bigint,
  dt date,
  data string
)
partition by month(dt);

insert into test_part_month_middle values (1, '2023-01-01', 'data1');
insert into test_part_month_middle values (2, '2023-02-01', 'data2');
select * from test_part_month_middle order by id;
drop table test_part_month_middle force;

-- test partition column at the end with day transform
create table test_part_day_end (
  id bigint,
  data string,
  dt date
)
partition by day(dt);

insert into test_part_day_end values (1, 'data1', '2023-01-01');
insert into test_part_day_end values (2, 'data2', '2023-01-15');
select * from test_part_day_end order by id;
drop table test_part_day_end force;

-- test partition column at the beginning with hour transform
create table test_part_hour_beginning (
  ts datetime,
  id bigint,
  data string
)
partition by hour(ts);

insert into test_part_hour_beginning values ('2023-01-01 10:00:00', 1, 'data1');
insert into test_part_hour_beginning values ('2023-01-01 15:00:00', 2, 'data2');
select * from test_part_hour_beginning order by id;
drop table test_part_hour_beginning force;

-- test partition column in the middle with truncate transform
create table test_part_truncate_middle (
  id bigint,
  name string,
  data string
)
partition by truncate(name, 5);

insert into test_part_truncate_middle values (1, 'hello', 'data1');
insert into test_part_truncate_middle values (2, 'world', 'data2');
select * from test_part_truncate_middle order by id;
drop table test_part_truncate_middle force;

-- test partition column at the end with bucket transform
create table test_part_bucket_end (
  id bigint,
  data string,
  user_id bigint
)
partition by bucket(user_id, 10);

insert into test_part_bucket_end values (1, 'data1', 100);
insert into test_part_bucket_end values (2, 'data2', 200);
select * from test_part_bucket_end order by id;
drop table test_part_bucket_end force;

-- test multiple partition columns with transforms at different positions
create table test_multi_transform (
  id bigint,
  dt date,
  region string,
  data string
)
partition by year(dt), bucket(region, 5);

insert into test_multi_transform values (1, '2023-01-01', 'east', 'data1');
insert into test_multi_transform values (2, '2023-02-01', 'west', 'data2');
select * from test_multi_transform order by id;
drop table test_multi_transform force;

-- test partition column at the beginning with multiple columns
create table test_part_beginning_multi (
  dt date,
  region string,
  id bigint,
  data string
)
partition by (dt, region);

insert into test_part_beginning_multi values ('2023-01-01', 'east', 1, 'data1');
insert into test_part_beginning_multi values ('2023-01-02', 'west', 2, 'data2');
select * from test_part_beginning_multi order by id;
drop table test_part_beginning_multi force;

drop database ice_db_${uuid0};
drop catalog ice_cat_${uuid0};

set catalog default_catalog;