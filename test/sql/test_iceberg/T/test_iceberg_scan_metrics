-- name: test_iceberg_scan_metrics

create external catalog iceberg_sink_${uuid0} PROPERTIES (
    "type"  =  "iceberg",
    "iceberg.catalog.type"  =  "hive",
    "iceberg.catalog.hive.metastore.uris"="${hive_metastore_uris}",
    "aws.s3.access_key"  =  "${oss_ak}",
    "aws.s3.secret_key"  =  "${oss_sk}",
    "aws.s3.endpoint"  =  "${oss_endpoint}",
    "enable_iceberg_metadata_cache" = "false"
);

function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'total-planning-duration')
function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'result-data-files')
function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'result-delete-files')
function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'scanned-data-manifests')
function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'total-file-size-in-bytes')
function: assert_explain_verbose_contains('select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1', 'scanned-delete-manifests')

set enable_profile=true;
set enable_async_profile=false;
select * from iceberg_sink_${uuid0}.iceberg_ci_db.t2 limit 1;

select get_query_profile(last_query_id());
