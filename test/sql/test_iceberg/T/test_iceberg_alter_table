-- name: test_iceberg_alter_table

create external catalog iceberg_sql_test_${uuid0}
PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hive", "iceberg.catalog.hive.metastore.uris"="${iceberg_catalog_hive_metastore_uris}");

create database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
create table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0} (
  id bigint,
  data string
)
comment "table comment"
properties (
"file_format"="parquet"
);

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col1 string comment 'col1';
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col2 string null comment 'col2' after id;

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column (col3 string comment 'col3', col4 INT DEFAULT "1");

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
rename column col1 to col11;

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col5 string not null default "--";

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
modify column col4 BIGINT;

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
drop column col4;

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
rename new_ice_tbl_${uuid0};

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0}
comment = "new comment";

alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0}
set ('file_format'='orc');

drop table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0} force;


-- partition evolution test

use iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};

create table test_part_evo (
  id bigint,
  data string,
  dt date,
  value bigint  
);

alter table test_part_evo add partition column dt, truncate(value, 10), bucket(id, 10);
insert into test_part_evo values (1, 'data1', '2023-01-01', 100);
insert into test_part_evo values (2, 'data2', '2023-01-02', 200);
insert into test_part_evo values (3, 'data3', '2023-01-03', 300);
insert into test_part_evo values (4, 'data4', '2023-01-04', 400);

function: assert_query_contains("show create table test_part_evo", "PARTITION BY `dt`, truncate(`value`, 10), bucket(`id`, 10)")

alter table test_part_evo drop partition column dt;
alter table test_part_evo add partition column month(dt);
insert into test_part_evo values (5, 'data5', '2023-01-05', 500);

function: assert_query_contains("show create table test_part_evo", "PARTITION BY truncate(`value`, 10), bucket(`id`, 10), month(`dt`)")

select * from test_part_evo order by id;

alter table test_part_evo drop partition column truncate(value, 10), bucket(id, 10);

function: assert_query_contains("show create table test_part_evo", "PARTITION BY month(`dt`)")

select * from test_part_evo order by id;

function: assert_query_error_contains("alter table test_part_evo add partition column fn(dt)", "Unsupported partition transform")

function: assert_query_error_contains("alter table test_part_evo add partition column month(dt)", "Failed to add partition column")

function: assert_query_error_contains("alter table test_part_evo drop partition column day(dt)", "Failed to drop partition column")

drop table test_part_evo force;
drop database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};

set catalog default_catalog;
drop catalog iceberg_sql_test_${uuid0};
