-- name: test_iceberg_rewrite

create external catalog iceberg_sql_test_${uuid0} PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hive", "iceberg.catalog.hive.metastore.uris"="${iceberg_catalog_hive_metastore_uris}","enable_iceberg_metadata_cache"="true","aws.s3.access_key" = "${oss_ak}","aws.s3.secret_key" = "${oss_sk}","aws.s3.endpoint" = "${oss_endpoint}");

create database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0} properties (
    "location" = "oss://${oss_bucket}/iceberg_db_${uuid0}/test_iceberg_rewrite/${uuid0}"
);

CREATE TABLE iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`test_table` (
    `name` VARCHAR(1048576),
    `tenant` VARCHAR(1048576),
    `p_year` INT
)
PARTITION BY (`tenant`, `p_year`);

INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_1', 'tenant_A', 2025);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_2', 'tenant_A', 2025);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_3', 'tenant_B', 2025);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_4', 'tenant_B', 2025);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_5', 'tenant_A', 2024);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_6', 'tenant_A', 2024);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_7', 'tenant_B', 2024);
INSERT INTO iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table VALUES ('log_entry_7', 'tenant_B', 2024);

ALTER TABLE iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`test_table` EXECUTE rewrite_data_files("min_file_size_bytes"= 134217728) where p_year=2025;

select count(*) from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table$files;

ALTER TABLE iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`test_table` EXECUTE rewrite_data_files("min_file_size_bytes"= 134217728);

select count(*) from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table$files;

drop table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_table;
drop database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
drop catalog iceberg_sql_test_${uuid0};
