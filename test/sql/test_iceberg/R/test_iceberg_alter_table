-- name: test_iceberg_alter_table
create external catalog iceberg_sql_test_${uuid0}
PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hive", "iceberg.catalog.hive.metastore.uris"="${iceberg_catalog_hive_metastore_uris}");
-- result:
-- !result
create database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
create table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0} (
  id bigint,
  data string
)
comment "table comment"
properties (
"file_format"="parquet"
);
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col1 string comment 'col1';
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col2 string null comment 'col2' after id;
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column (col3 string comment 'col3', col4 INT DEFAULT "1");
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
rename column col1 to col11;
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
add column col5 string not null default "--";
-- result:
E: (1064, 'column in iceberg table must be nullable.')
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
modify column col4 BIGINT;
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
drop column col4;
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.ice_tbl_${uuid0}
rename new_ice_tbl_${uuid0};
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0}
comment = "new comment";
-- result:
-- !result
alter table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0}
set ('file_format'='orc');
-- result:
-- !result
drop table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.new_ice_tbl_${uuid0} force;
-- result:
-- !result
use iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
create table test_part_evo (
  id bigint,
  data string,
  dt date,
  value bigint  
);
-- result:
-- !result
alter table test_part_evo add partition column dt, truncate(value, 10), bucket(id, 10);
-- result:
-- !result
insert into test_part_evo values (1, 'data1', '2023-01-01', 100);
-- result:
-- !result
insert into test_part_evo values (2, 'data2', '2023-01-02', 200);
-- result:
-- !result
insert into test_part_evo values (3, 'data3', '2023-01-03', 300);
-- result:
-- !result
insert into test_part_evo values (4, 'data4', '2023-01-04', 400);
-- result:
-- !result
function: assert_query_contains("show create table test_part_evo", "PARTITION BY `dt`, truncate(`value`, 10), bucket(`id`, 10)")
-- result:
None
-- !result
alter table test_part_evo drop partition column dt;
-- result:
-- !result
alter table test_part_evo add partition column month(dt);
-- result:
-- !result
insert into test_part_evo values (5, 'data5', '2023-01-05', 500);
-- result:
-- !result
function: assert_query_contains("show create table test_part_evo", "PARTITION BY truncate(`value`, 10), bucket(`id`, 10), month(`dt`)")
-- result:
None
-- !result
select * from test_part_evo order by id;
-- result:
1	data1	2023-01-01	100
2	data2	2023-01-02	200
3	data3	2023-01-03	300
4	data4	2023-01-04	400
5	data5	2023-01-05	500
-- !result
alter table test_part_evo drop partition column truncate(value, 10), bucket(id, 10);
-- result:
-- !result
function: assert_query_contains("show create table test_part_evo", "PARTITION BY month(`dt`)")
-- result:
None
-- !result
select * from test_part_evo order by id;
-- result:
1	data1	2023-01-01	100
2	data2	2023-01-02	200
3	data3	2023-01-03	300
4	data4	2023-01-04	400
5	data5	2023-01-05	500
-- !result
function: assert_query_error_contains("alter table test_part_evo add partition column fn(dt)", "Unsupported partition transform")
-- result:
None
-- !result
function: assert_query_error_contains("alter table test_part_evo add partition column month(dt)", "Failed to add partition column")
-- result:
None
-- !result
function: assert_query_error_contains("alter table test_part_evo drop partition column day(dt)", "Failed to drop partition column")
-- result:
None
-- !result
drop table test_part_evo force;
-- result:
-- !result
drop database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
set catalog default_catalog;
-- result:
-- !result
drop catalog iceberg_sql_test_${uuid0};
-- result:
-- !result