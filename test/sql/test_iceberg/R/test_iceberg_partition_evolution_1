-- name: test_iceberg_partition_evolution_1
create external catalog iceberg_sql_test_${uuid0}
PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hive", "iceberg.catalog.hive.metastore.uris"="${iceberg_catalog_hive_metastore_uris}");
-- result:
-- !result
create database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
use iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
drop table if exists test_users_bucketed;
-- result:
-- !result
CREATE TABLE test_users_bucketed (
  user_id BIGINT,
  country STRING,
  score   DOUBLE
)
PARTITION BY bucket(user_id, 16);
-- result:
-- !result
INSERT INTO test_users_bucketed VALUES
 (1, 'US',  1.0),
 (2, 'US',  2.0),
 (3, 'CN',  3.0),
 (4, 'CN',  4.0),
 (5, 'JP',  5.0);
-- result:
-- !result
ALTER TABLE test_users_bucketed drop partition column bucket(user_id, 16);
-- result:
-- !result
ALTER TABLE test_users_bucketed add partition column bucket(user_id, 32);
-- result:
-- !result
INSERT INTO test_users_bucketed VALUES
 (6,  'US',  6.0),
 (7,  'CN',  7.0),
 (16, 'US', 16.0),
 (32, 'CN', 32.0);
-- result:
-- !result
SELECT COUNT(*) AS cnt, SUM(score) AS sum_score FROM test_users_bucketed; 

SELECT country, COUNT(*) AS c, SUM(score) AS s FROM test_users_bucketed GROUP BY country ORDER BY country;
-- result:
9	76.0
-- !result
SELECT COUNT(*), SUM(score) FROM test_users_bucketed WHERE user_id IN (1,2,3,4,5,6,7,16,32);
-- result:
9	76.0
-- !result
function: assert_explain_verbose_contains("SELECT COUNT(*), SUM(score) FROM test_users_bucketed WHERE user_id IN (1,2,3,4,5,6,7,16,32);", "partitions=7/8")
-- result:
None
-- !result
SELECT COUNT(*), SUM(score) FROM test_users_bucketed WHERE user_id IN (1,2,3,4);
-- result:
4	10.0
-- !result
function: assert_explain_verbose_contains("SELECT COUNT(*), SUM(score) FROM test_users_bucketed WHERE user_id IN (1,2,3,4);", "partitions=3/8")
-- result:
None
-- !result
function: assert_query_contains("analyze table test_users_bucketed;", "OK")
-- result:
None
-- !result
drop table test_users_bucketed force;
-- result:
-- !result
drop database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
set catalog default_catalog;
-- result:
-- !result
drop catalog iceberg_sql_test_${uuid0};
-- result:
-- !result