-- name: test_iceberg_variant_query_0
create external catalog iceberg_sql_test_${uuid0}
PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hadoop", "iceberg.catalog.warehouse"="oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/warehouse/");
-- result:
-- !result
shell: ossutil64 mkdir oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/warehouse/iceberg_variant > /dev/null
-- result:
0

-- !result
use iceberg_sql_test_${uuid0}.iceberg_variant;
-- result:
-- !result
CREATE TABLE variant_test_cases (
    case_id INT,
    case_label STRING,
    int_val INT,
    string_val STRING,
    float_val DOUBLE,
    decimal_val DECIMAL(18, 4),
    struct_val STRUCT<id INT, name STRING, counters MAP<STRING, INT>, status STRING>,
    json_val STRING,
    map_val MAP<STRING, STRING>,
    array_val ARRAY<DOUBLE>,
    variant_from_int VARIANT,
    variant_from_string VARIANT,
    variant_from_float VARIANT,
    variant_from_decimal VARIANT,
    variant_from_struct VARIANT,
    variant_from_json VARIANT,
    variant_from_map VARIANT,
    variant_from_array VARIANT,
    variant_mixed VARIANT,
    deep_struct_val STRUCT<
        profile STRUCT<
            handle STRING,
            contact STRUCT<
                emails ARRAY<STRING>,
                phones ARRAY<STRUCT<channel STRING, number STRING>>
            >,
            preferences MAP<STRING, STRUCT<enabled BOOLEAN, path STRING>>
        >,
        history ARRAY<STRUCT<ts STRING, status STRING, meta MAP<STRING, STRING>>>
    >,
    deep_map_val MAP<
        STRING,
        STRUCT<
            limits MAP<STRING, INT>,
            routes ARRAY<STRUCT<pattern STRING, methods ARRAY<STRING>>>,
            metadata STRUCT<label STRING, path STRING>
        >
    >,
    deep_array_val ARRAY<
        STRUCT<
            slot INT,
            nodes ARRAY<
                STRUCT<
                    id STRING,
                    status STRING,
                    metrics MAP<STRING, DOUBLE>,
                    transitions ARRAY<STRUCT<state STRING, at STRING>>
                >
            >
        >
    >,
    deep_json_val STRING,
    variant_deep_struct VARIANT,
    variant_deep_map VARIANT,
    variant_deep_array VARIANT,
    variant_deep_json VARIANT
) 
properties(
  'format-version' = '3'
);
-- result:
-- !result
shell: ossutil64 sync ./sql/test_iceberg/data/variant_query_0/ oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/variant_query_0/ > /dev/null
-- result:
0

-- !result
alter table variant_test_cases execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/variant_query_0/data/00000-0-968ed6e2-3543-431b-ba6c-b41704fb5cd7-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_test_cases execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/variant_query_0/data/00001-1-968ed6e2-3543-431b-ba6c-b41704fb5cd7-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_test_cases execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/variant_query_0/data/00002-2-968ed6e2-3543-431b-ba6c-b41704fb5cd7-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_test_cases execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/variant_query_0/data/00003-3-968ed6e2-3543-431b-ba6c-b41704fb5cd7-0-00001.parquet', file_format='parquet');
-- result:
-- !result
SELECT 'Query 1: Validate scalar round-trip extractions via get_variant_* helpers.' AS case_description;
-- result:
Query 1: Validate scalar round-trip extractions via get_variant_* helpers.
-- !result
SELECT
    case_id,
    get_variant_int(variant_from_int, '$')          AS variant_int_value,
    get_variant_double(variant_from_float, '$')     AS variant_float_value,
    get_variant_double(variant_from_decimal, '$')   AS variant_decimal_value,
    get_variant_string(variant_from_string, '$')    AS variant_string_value
FROM variant_test_cases
ORDER BY case_id;
-- result:
1	42	None	None	42
2	-7	None	None	-7
3	None	None	None	
4	2048	None	None	2048
-- !result
SELECT 'Query 2: Exercise struct/map/array field projection via get_variant_*.' AS case_description;
-- result:
Query 2: Exercise struct/map/array field projection via get_variant_*.
-- !result
SELECT
    case_id,
    get_variant_string(variant_from_struct, '$.name')             AS struct_name,
    get_variant_int(variant_from_struct, '$.counters.success')    AS struct_success,
    get_variant_string(variant_from_map, '$.tier')                AS tier_label,
    get_variant_double(variant_from_array, '$[0]')                AS array_first,
    get_variant_double(variant_from_array, '$[2]')                AS array_third
FROM variant_test_cases
ORDER BY case_id;
-- result:
1	alpha	10	hot	None	None
2	beta	0	cold	None	None
3	None	None	None	None	None
4	delta	99	warm	None	None
-- !result
SELECT 'Query 3: Use variant_query + CAST to coerce nested payloads into primitives.' AS case_description;
-- result:
Query 3: Use variant_query + CAST to coerce nested payloads into primitives.
-- !result
SELECT
    case_id,
    CAST(variant_query(variant_mixed, '$.thresholds.warn') AS INT)     AS warn_threshold,
    CAST(variant_query(variant_mixed, '$.thresholds.critical') AS INT) AS critical_threshold,
    CAST(variant_query(variant_mixed, '$.tags[0]') AS STRING)          AS first_tag,
    CAST(variant_query(variant_mixed, '$.tags[1]') AS STRING)          AS second_tag,
    CAST(variant_query(variant_mixed, '$.paths.first') AS STRING)      AS first_path_expr,
    CAST(variant_query(variant_mixed, '$.composite.ints[1]') AS INT)   AS composite_midpoint
FROM variant_test_cases
ORDER BY case_id;
-- result:
1	20	28	prod	codex	None	None
2	None	None	staging	None	$.composite.ints[0]	0
3	None	None	None	None	None	None
4	None	None	None	None	None	None
-- !result
SELECT 'Query 4: Cover complex JSON path navigation across nested arrays and maps.' AS case_description;
-- result:
Query 4: Cover complex JSON path navigation across nested arrays and maps.
-- !result
SELECT
    case_id,
    CAST(variant_query(variant_mixed, '$.routing.routes[1].pattern') AS STRING)       AS nested_route_pattern,
    CAST(variant_query(variant_mixed, '$.routing.routes[1].methods[1]') AS STRING)    AS nested_route_method,
    CAST(variant_query(variant_mixed, '$.matrix[1][0].val') AS INT)                   AS matrix_value,
    CAST(variant_query(variant_mixed, '$.deep.layers[1].payload.next.reasons[0]') AS STRING) AS deepest_reason,
    CAST(variant_query(variant_mixed, '$.deep.flags["key.with.dot"].child.leaf') AS INT)    AS dotted_leaf,
    CAST(variant_query(variant_mixed, '$.deep.flags["key-with-dash"]') AS BOOLEAN)          AS dashed_flag
FROM variant_test_cases
ORDER BY case_id;
-- result:
1	None	None	None	None	None	None
2	None	None	None	None	None	None
3	None	None	None	None	None	None
4	/api/v1/{tenant}/jobs/**	DELETE	3	pending	123	0
-- !result
SELECT 'Query 5: Stress CAST combinations from Variant into the major primitive types.' AS case_description;
-- result:
Query 5: Stress CAST combinations from Variant into the major primitive types.
-- !result
SELECT
    case_id,
    CAST(variant_query(variant_mixed, '$.typed.bool_true') AS BOOLEAN)       AS cast_bool_true,
    CAST(variant_query(variant_mixed, '$.typed.bool_false') AS BOOLEAN)      AS cast_bool_false,
    CAST(variant_query(variant_mixed, '$.typed.int_as_string') AS BIGINT)    AS cast_bigint_from_string,
    CAST(variant_query(variant_mixed, '$.typed.decimal_text') AS DECIMAL(9, 3)) AS cast_decimal_text,
    -- CAST(variant_query(variant_mixed, '$.typed.timestamp_text') AS DATETIME) AS cast_timestamp,
    CAST(variant_query(variant_mixed, '$.matrix[0][1].val') AS SMALLINT)     AS cast_smallint_nested
FROM variant_test_cases
ORDER BY case_id;
-- result:
1	None	None	None	None	None
2	None	None	None	None	None
3	None	None	None	None	None
4	1	0	None	45.678	2
-- !result
shell: ossutil64 rm -rf oss://${oss_bucket}/test_iceberg_variant_query_0/${uuid0}/ > /dev/null
-- result:
0

-- !result
drop table variant_test_cases force;
-- result:
-- !result
set catalog default_catalog;
-- result:
-- !result
drop catalog iceberg_sql_test_${uuid0};
-- result:
-- !result