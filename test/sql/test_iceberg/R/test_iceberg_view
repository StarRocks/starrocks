-- name: test_iceberg_view @sequential
create external catalog iceberg_sql_test_${uuid0} PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hive", "iceberg.catalog.hive.metastore.uris"="${iceberg_catalog_hive_metastore_uris}","enable_iceberg_metadata_cache"="true","aws.s3.access_key" = "${oss_ak}","aws.s3.secret_key" = "${oss_sk}","aws.s3.endpoint" = "${oss_endpoint}");
-- result:
-- !result
create database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0} properties (
    "location" = "oss://${oss_bucket}/test_iceberg_view${uuid0}/iceberg_db/${uuid0}"
);
-- result:
-- !result
CREATE TABLE iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`day_partition` (
 `k1` int(11) DEFAULT NULL,
 `ts` datetime DEFAULT NULL
)
PARTITION BY day(`ts`);
-- result:
-- !result
insert into iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`day_partition` values (1, '2023-06-01 00:00:00');
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_${uuid0} as select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.day_partition;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_${uuid0};
-- result:
1	2023-06-01 00:00:00
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_${uuid0};
-- result:
-- !result
CREATE TABLE iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`iceberg_v2_parquet_partitioned_table` (
 `k1` int(11) DEFAULT NULL,
 `k2` string DEFAULT NULL,
 `k3` string DEFAULT NULL
)
PARTITION BY (`k3`);
-- result:
-- !result
insert into iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.`iceberg_v2_parquet_partitioned_table` values (1, 'beijing', 'zhangsan'), (2, 'shanghai', 'lisi');
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0}
properties ("owner"="alex") as select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0} order by k1;
-- result:
1	beijing	zhangsan
2	shanghai	lisi
-- !result
show create view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0};
-- result:
[REGEX].*"owner" = "alex".*
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0};
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0}
properties ("owner"="alex", "comment"="this is a test view") as select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0} order by k1;
-- result:
1	beijing	zhangsan
2	shanghai	lisi
-- !result
show create view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0};
-- result:
[REGEX].*("owner" = "alex".*"comment" = "this is a test view"|"comment" = "this is a test view".*"owner" = "alex").*
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_with_properties_${uuid0};
-- result:
-- !result
create database default_catalog.test_internal_db_${uuid0};
-- result:
-- !result
create view if not exists default_catalog.test_internal_db_${uuid0}.test_internal_view_${uuid0} properties ("key"="value") as select 1 from dual;
-- result:
E: (1064, 'Getting analyzing error. Detail message: Setting properties is only supported for Iceberg views.')
-- !result
drop database default_catalog.test_internal_db_${uuid0};
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} as select k1, k2 from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} order by k1;
-- result:
1	beijing
2	shanghai
-- !result
alter view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} add dialect select k1, k2, k3 from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
E: (1064, 'Invalid view version: Cannot add multiple queries for dialect starrocks')
-- !result
alter view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} add dialect starrocks select k1, k2, k3 from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
E: (1064, 'Invalid view version: Cannot add multiple queries for dialect starrocks')
-- !result
alter view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} modify dialect starrocks select k1, k2, k3 from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} order by k1;
-- result:
1	beijing	zhangsan
2	shanghai	lisi
-- !result
alter view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0} set properties ('k1'='v1');
-- result:
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_alter_iceberg_view_${uuid0};
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0} as
with cte as (select 1 as col1) select * from cte;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0};
-- result:
1
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0};
-- result:
-- !result
create view if not exists iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0} as
with cte as (select k1, k2 from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table) select * from cte;
-- result:
-- !result
select * from iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0} order by k1;
-- result:
1	beijing
2	shanghai
-- !result
drop view iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.test_iceberg_view_cte_${uuid0};
-- result:
-- !result
drop table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.day_partition;
-- result:
-- !result
drop table iceberg_sql_test_${uuid0}.iceberg_db_${uuid0}.iceberg_v2_parquet_partitioned_table;
-- result:
-- !result
drop database iceberg_sql_test_${uuid0}.iceberg_db_${uuid0};
-- result:
-- !result
drop catalog iceberg_sql_test_${uuid0};
-- result:
-- !result
shell: ossutil64 rm -rf oss://${oss_bucket}/test_iceberg_view${uuid0}/iceberg_db/${uuid0} > /dev/null || echo "exit 0" >/dev/null
-- result:
0

-- !result