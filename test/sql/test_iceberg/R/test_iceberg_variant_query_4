-- name: test_iceberg_variant_query_4
create external catalog iceberg_sql_test_${uuid0}
PROPERTIES ("type"="iceberg", "iceberg.catalog.type"="hadoop", "iceberg.catalog.warehouse"="oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/warehouse/");
-- result:
-- !result
shell: ossutil64 mkdir oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/warehouse/iceberg_variant > /dev/null
-- result:
0

-- !result
use iceberg_sql_test_${uuid0}.iceberg_variant;
-- result:
-- !result
CREATE TABLE variant_string_unicode_test (
    test_id INT,
    test_label STRING,
    expected_value STRING,
    variant_col VARIANT
)
properties(
  'format-version' = '3'
);
-- result:
-- !result
CREATE TABLE variant_string_size_test (
    test_id INT,
    test_label STRING,
    size_bytes INT,
    variant_col VARIANT
)
properties(
  'format-version' = '3'
);
-- result:
-- !result
shell: ossutil64 cp ./sql/test_iceberg/data/variant_string_unicode_test/data/00000-0-25ecb658-ed0c-4f1e-9886-eda14c03c061-0-00001.parquet oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_unicode_test/data/00000-0-25ecb658-ed0c-4f1e-9886-eda14c03c061-0-00001.parquet > /dev/null
-- result:
0

-- !result
shell: ossutil64 cp ./sql/test_iceberg/data/variant_string_size_test/data/00000-10-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00000-10-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet > /dev/null
-- result:
0

-- !result
shell: ossutil64 cp ./sql/test_iceberg/data/variant_string_size_test/data/00001-11-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00001-11-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet > /dev/null
-- result:
0

-- !result
shell: ossutil64 cp ./sql/test_iceberg/data/variant_string_size_test/data/00002-12-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00002-12-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet > /dev/null
-- result:
0

-- !result
shell: ossutil64 cp ./sql/test_iceberg/data/variant_string_size_test/data/00003-13-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00003-13-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet > /dev/null
-- result:
0

-- !result
alter table variant_string_unicode_test execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_unicode_test/data/00000-0-25ecb658-ed0c-4f1e-9886-eda14c03c061-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_string_size_test execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00000-10-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_string_size_test execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00001-11-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_string_size_test execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00002-12-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet', file_format='parquet');
-- result:
-- !result
alter table variant_string_size_test execute add_files(location='oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/variant_string_size_test/data/00003-13-c43c64d6-c3e1-4607-b065-7884504d3b70-0-00001.parquet', file_format='parquet');
-- result:
-- !result
SELECT 'Query 1: Validate Unicode string extraction from VARIANT' AS test_description;
-- result:
Query 1: Validate Unicode string extraction from VARIANT
-- !result
SELECT
    test_id,
    test_label,
    get_variant_string(variant_col, '$') as extracted_value,
    expected_value,
    CASE
        WHEN get_variant_string(variant_col, '$') = expected_value THEN 'PASS'
        ELSE 'FAIL'
    END as test_result,
    variant_typeof(variant_query(variant_col, '$')) as value_type
FROM variant_string_unicode_test
ORDER BY test_id;
-- result:
1	chinese	ä½ å¥½ä¸–ç•Œ	ä½ å¥½ä¸–ç•Œ	PASS	String
2	arabic	Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ	Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ	PASS	String
3	emoji	Hello ğŸ‘‹ World ğŸŒ	Hello ğŸ‘‹ World ğŸŒ	PASS	String
4	cyrillic	ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€	ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€	PASS	String
5	japanese	ã“ã‚“ã«ã¡ã¯	ã“ã‚“ã«ã¡ã¯	PASS	String
6	korean	ì•ˆë…•í•˜ì„¸ìš”	ì•ˆë…•í•˜ì„¸ìš”	PASS	String
7	mixed	ğŸ‰ Test æµ‹è¯• Ğ¢ĞµÑÑ‚ Ø§Ø®ØªØ¨Ø§Ø± ğŸš€	ğŸ‰ Test æµ‹è¯• Ğ¢ĞµÑÑ‚ Ø§Ø®ØªØ¨Ø§Ø± ğŸš€	PASS	String
8	special_chars	Line1
Line2	Tab"Quote'Apostrophe	Line1
Line2	Tab"Quote'Apostrophe	PASS	String
9	unicode_escape	Hello	Hello	PASS	String
10	emoji_complex	ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ğŸ³ï¸â€ğŸŒˆ	ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ğŸ³ï¸â€ğŸŒˆ	PASS	String
-- !result
SELECT 'Query 2: Verify Unicode string length preservation' AS test_description;
-- result:
Query 2: Verify Unicode string length preservation
-- !result
SELECT
    test_id,
    test_label,
    LENGTH(get_variant_string(variant_col, '$')) as extracted_length,
    LENGTH(expected_value) as expected_length,
    CASE
        WHEN LENGTH(get_variant_string(variant_col, '$')) = LENGTH(expected_value) THEN 'PASS'
        ELSE 'FAIL'
    END as test_result
FROM variant_string_unicode_test
ORDER BY test_id;
-- result:
1	chinese	12	12	PASS
2	arabic	15	15	PASS
3	emoji	21	21	PASS
4	cyrillic	19	19	PASS
5	japanese	15	15	PASS
6	korean	15	15	PASS
7	mixed	43	43	PASS
8	special_chars	32	32	PASS
9	unicode_escape	5	5	PASS
10	emoji_complex	39	39	PASS
-- !result
SELECT 'Query 3: Validate large string extraction and size' AS test_description;
-- result:
Query 3: Validate large string extraction and size
-- !result
SELECT
    test_id,
    test_label,
    size_bytes,
    LENGTH(get_variant_string(variant_col, '$')) as extracted_length,
    CASE
        WHEN LENGTH(get_variant_string(variant_col, '$')) = size_bytes THEN 'PASS'
        ELSE 'FAIL'
    END as test_result,
    variant_typeof(variant_query(variant_col, '$')) as value_type
FROM variant_string_size_test
ORDER BY test_id;
-- result:
1	1KB_string	1024	1024	PASS	String
2	64KB_string	65536	65536	PASS	String
3	1MB_string	1048576	1048576	PASS	String
4	5MB_string	5242880	5242880	PASS	String
-- !result
SELECT 'Query 4: Verify large string content integrity' AS test_description;
-- result:
Query 4: Verify large string content integrity
-- !result
SELECT
    test_id,
    test_label,
    SUBSTR(get_variant_string(variant_col, '$'), 1, 10) as first_10_chars,
    SUBSTR(get_variant_string(variant_col, '$'), -10) as last_10_chars,
    CASE test_id
        WHEN 1 THEN 'AAAAAAAAAA'
        WHEN 2 THEN 'BBBBBBBBBB'
        WHEN 3 THEN 'CCCCCCCCCC'
        WHEN 4 THEN 'DDDDDDDDDD'
    END as expected_first_10,
    CASE
        WHEN SUBSTR(get_variant_string(variant_col, '$'), 1, 10) =
             (CASE test_id
                WHEN 1 THEN 'AAAAAAAAAA'
                WHEN 2 THEN 'BBBBBBBBBB'
                WHEN 3 THEN 'CCCCCCCCCC'
                WHEN 4 THEN 'DDDDDDDDDD'
              END)
        THEN 'PASS'
        ELSE 'FAIL'
    END as test_result
FROM variant_string_size_test
ORDER BY test_id;
-- result:
1	1KB_string	AAAAAAAAAA	AAAAAAAAAA	AAAAAAAAAA	PASS
2	64KB_string	BBBBBBBBBB	BBBBBBBBBB	BBBBBBBBBB	PASS
3	1MB_string	CCCCCCCCCC	CCCCCCCCCC	CCCCCCCCCC	PASS
4	5MB_string	DDDDDDDDDD	DDDDDDDDDD	DDDDDDDDDD	PASS
-- !result
SELECT 'Query 5: CAST VARIANT strings to VARCHAR' AS test_description;
-- result:
Query 5: CAST VARIANT strings to VARCHAR
-- !result
SELECT
    test_id,
    test_label,
    CAST(variant_col AS VARCHAR(1000)) as cast_result,
    CASE
        WHEN CAST(variant_col AS VARCHAR(1000)) = expected_value THEN 'PASS'
        ELSE 'FAIL'
    END as test_result
FROM variant_string_unicode_test
WHERE test_id <= 7  -- Skip very long strings for VARCHAR cast
ORDER BY test_id;
-- result:
1	chinese	ä½ å¥½ä¸–ç•Œ	PASS
2	arabic	Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ	PASS
3	emoji	Hello ğŸ‘‹ World ğŸŒ	PASS
4	cyrillic	ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ Ğ¼Ğ¸Ñ€	PASS
5	japanese	ã“ã‚“ã«ã¡ã¯	PASS
6	korean	ì•ˆë…•í•˜ì„¸ìš”	PASS
7	mixed	ğŸ‰ Test æµ‹è¯• Ğ¢ĞµÑÑ‚ Ø§Ø®ØªØ¨Ø§Ø± ğŸš€	PASS
-- !result
drop table variant_string_unicode_test force;
-- result:
-- !result
drop table variant_string_size_test force;
-- result:
-- !result
set catalog default_catalog;
-- result:
-- !result
drop catalog iceberg_sql_test_${uuid0};
-- result:
-- !result
shell: ossutil64 rm -rf oss://${oss_bucket}/test_iceberg_variant_query_4/${uuid0}/ > /dev/null
-- result:
0

-- !result