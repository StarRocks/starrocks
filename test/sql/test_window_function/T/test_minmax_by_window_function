-- name: test_minmax_by_window_function

CREATE TABLE `t1_nulls` (
  `v1` int NULL,
  `v2` bigint NULL,
  `v3` largeint NULL,
  `v4` string NULL,
  `v5` json NULL,
  `v6` map<int, string> NULL,
  `v7` array<int> NULL
) ENGINE=OLAP
DUPLICATE KEY(`v1`)
DISTRIBUTED BY HASH(`v1`) BUCKETS 10
PROPERTIES (
 "replication_num" = "1"
);
insert into t1_nulls SELECT generate_series, generate_series, generate_series, generate_series, generate_series, map(generate_series, generate_series), [generate_series] FROM TABLE(generate_series(1,  40960));

select count(mb), sum(mb) from (select min_by(v1, v1) over (partition by v1) mb from t1_nulls) t;
select count(mb), sum(mb) from (select min_by(v2, v2) over (partition by v1) mb from t1_nulls) t;
select count(mb), sum(mb) from (select min_by(v3, v3) over (partition by v1) mb from t1_nulls) t;
select count(mb), max(mb) from (select min_by(v4, v4) over (partition by v1) mb from t1_nulls) t;
select count(mb), max(get_json_int(mb, "$")) from (select min_by(v5, v1) over (partition by v1) mb from t1_nulls) t;

CREATE TABLE `t1_not_nulls` (
  `v1` int,
  `v2` bigint,
  `v3` largeint,
  `v4` string,
  `v5` json,
  `v6` map<int, string>,
  `v7` array<int>
) ENGINE=OLAP
DUPLICATE KEY(`v1`)
DISTRIBUTED BY HASH(`v1`) BUCKETS 10
PROPERTIES (
 "replication_num" = "1"
);
insert into t1_not_nulls SELECT generate_series, generate_series, generate_series, generate_series, generate_series, map(generate_series, generate_series), [generate_series] FROM TABLE(generate_series(1,  40960));

select count(mb), sum(mb) from (select min_by(v1, v1) over (partition by v1) mb from t1_not_nulls) t;
select count(mb), sum(mb) from (select min_by(v2, v2) over (partition by v1) mb from t1_not_nulls) t;
select count(mb), sum(mb) from (select min_by(v3, v3) over (partition by v1) mb from t1_not_nulls) t;
select count(mb), max(mb) from (select min_by(v4, v4) over (partition by v1) mb from t1_not_nulls) t;
select count(mb), max(get_json_int(mb, "$")) from (select min_by(v5, v1) over (partition by v1) mb from t1_not_nulls) t;

select count(mb) from (select min_by(named_struct("k",v1,"v",v1), v1) over (partition by v1) mb from t1_not_nulls) t;
select count(mb) from (select min_by(named_struct("k",v1,"v",v1), v1) over (partition by v1) mb from t1_not_nulls) t;
select count(mb) from (select min_by(["k",v1,"v",v1], v1) over (partition by v1) mb from t1_not_nulls) t;
select count(mb) from (select min_by(map("k",v1), v1) over (partition by v1) mb from t1_not_nulls) t;
select count(mb) from (select min_by(map("k",[v1]), v1) over (partition by v1) mb from t1_not_nulls) t;

