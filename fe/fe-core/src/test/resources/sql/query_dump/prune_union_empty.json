{
  "statement": "select\r\n `t0`.`dim_0`,\r\n `t0`.`dim_1`,\r\n `t0`.`dim_2`,\r\n `t0`.`dim_3`,\r\n `t0`.`dim_4`,\r\n `t0`.`m_0`,\r\n `t0`.`m_1`,\r\n `t0`.`m_2`,\r\n `t0`.`m_3`,\r\n `t0`.`m_4`,\r\n `t0`.`m_5`,\r\n `t0`.`m_6`,\r\n `t0`.`m_7`,\r\n `t0`.`m_8`,\r\n `t0`.`m_9`,\r\n `t0`.`m_10`,\r\n `t0`.`m_11`,\r\n `t0`.`m_12`,\r\n `t0`.`m_13`,\r\n `t0`.`m_14`,\r\n `t0`.`m_15`,\r\n `t0`.`m_16`,\r\n `t0`.`m_17`,\r\n `t0`.`m_18`,\r\n `t0`.`m_19`,\r\n `t0`.`m_20`,\r\n `t0`.`m_21`,\r\n `t0`.`m_22`,\r\n `t0`.`m_23`,\r\n `t0`.`m_24`,\r\n `t0`.`m_25`,\r\n `t0`.`m_26`,\r\n `t0`.`m_27`,\r\n `t0`.`m_28`,\r\n `t0`.`m_29`,\r\n `t0`.`__grouping_id`\r\nfrom\r\n (\r\n select\r\n *\r\n from\r\n (\r\n select\r\n `division` as `dim_0`,\r\n `pur_dept_nbr_name` as `dim_1`,\r\n `category_nbr_name` as `dim_2`,\r\n `fineline_nbr_name` as `dim_3`,\r\n `upc_nbr_name` as `dim_4`,\r\n bitmap_union_count(`总订单量`) as `m_0`,\r\n bitmap_union_count(`总负反馈单量`) as `m_1`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n case\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`red`) then '红'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`red`)\r\n and (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`yellow`) then '黄'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`yellow`) then '绿'\r\n end,\r\n null\r\n ) as `m_2`,\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`) as `m_3`,\r\n (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`总负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_4`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n max(`yellow`),\r\n null\r\n ) as `m_5`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n max(`red`),\r\n null\r\n ) as `m_6`,\r\n bitmap_union_count(`商品负反馈单量`) / bitmap_union_count(`总订单量`) as `m_7`,\r\n (\r\n bitmap_union_count(`商品负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`商品负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_8`,\r\n bitmap_union_count(`履约负反馈单量`) / bitmap_union_count(`总订单量`) as `m_9`,\r\n (\r\n bitmap_union_count(`履约负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`履约负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_10`,\r\n bitmap_union_count(`售后&服务负反馈单量`) / bitmap_union_count(`总订单量`) as `m_11`,\r\n (\r\n bitmap_union_count(`售后&服务负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`售后&服务负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_12`,\r\n bitmap_union_count(`其他负反馈单量`) / bitmap_union_count(`总订单量`) as `m_13`,\r\n (\r\n bitmap_union_count(`其他负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`其他负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_14`,\r\n max(`top1`) as `m_15`,\r\n sum(`top1_fz`) as `m_16`,\r\n sum(`top1_fz`) / sum(`top1_fm`) as `m_17`,\r\n max(`top2`) as `m_18`,\r\n sum(`top2_fz`) as `m_19`,\r\n sum(`top2_fz`) / sum(`top2_fm`) as `m_20`,\r\n max(`top3`) as `m_21`,\r\n sum(`top3_fz`) as `m_22`,\r\n sum(`top3_fz`) / sum(`top3_fm`) as `m_23`,\r\n max(`top4`) as `m_24`,\r\n sum(`top4_fz`) as `m_25`,\r\n sum(`top4_fz`) / sum(`top4_fm`) as `m_26`,\r\n max(`top5`) as `m_27`,\r\n sum(`top5_fz`) as `m_28`,\r\n sum(`top5_fz`) / sum(`top5_fm`) as `m_29`,\r\n 0 as `__grouping_id`\r\n from\r\n (\r\n /**\r\n @creater:vn52tsy\r\n @report:大卖场顾客负反馈看板 \r\n 聚合到商品粒度，过滤订单量，不支持门店权限\r\n **/\r\n with fm as (\r\n -- 分母数据\r\n SELECT\r\n t.upc_nbr_name -- 'upc条码+商品中文名称'\r\n,\r\n df.item_cn_name,\r\n max(t.division) division -- '商品分区'\r\n,\r\n max(t.pur_dept_nbr_name) pur_dept_nbr_name -- '采购部门编号+中文名'\r\n,\r\n max(t.category_nbr_name) category_nbr_name -- '大类编号+中文名'\r\n,\r\n max(t.fineline_nbr_name) fineline_nbr_name -- '细类编号+中文名'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt1w\r\n else t.order_id_set_mtd\r\n end\r\n ) order_id_set_mtd -- '订单ID集合近一周' -- '订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt2w\r\n else t.order_id_set_lm\r\n end\r\n ) order_id_set_lm -- '订单ID集合近一周环比' -- '订单ID集合月环比'\r\n,\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt1w\r\n else t.order_id_set_mtd\r\n end\r\n ) item_order_cnt -- 商品对应的订单量\r\n from\r\n ads_ops_af_fb_voc_overview_traffic_hyper_di t -- 分母表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n left join dim.dim_af_fb_voc_upc_info_hyper_df df on (t.upc_nbr_name = df.upc_nbr)\r\n where\r\n t.ts = '2026-09-30'\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n GROUP BY\r\n t.upc_nbr_name,\r\n df.item_cn_name\r\n ),\r\n fz as (\r\n -- 分子by upc\r\n SELECT\r\n t.upc_nbr_name,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt2w\r\n else t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 商品\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_pro -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_pro_lm -- '反馈订单ID集合近一周环比'\r\n -- 履约\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_lv -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_lv_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 售后&服务\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_ser -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_ser_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 其他\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_other -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_other_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n,\r\n max(\r\n ifnull(\r\n d1.red_line_value,\r\n ifnull(d2.red_line_value, d3.red_line_value)\r\n )\r\n ) as red,\r\n max(\r\n ifnull(\r\n d1.yellow_line_value,\r\n ifnull(d2.yellow_line_value, d3.yellow_line_value)\r\n )\r\n ) as yellow,\r\n max(\r\n ifnull(\r\n d1.fb_order_id_qty_lt1w,\r\n ifnull(d2.fb_order_id_qty_lt1w, d3.fb_order_id_qty_lt1w)\r\n )\r\n ) as line_order\r\n from\r\n ads_ops_af_fb_voc_overview_hyper_di t -- 分子表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n -- 红绿灯配置表\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d1 on t.division = d1.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d1.pur_dept_nbr\r\n and SUBSTRING_INDEX(t.category_nbr_name, '+', 1) = d1.category_nbr\r\n and SUBSTRING_INDEX(t.fineline_nbr_name, '+', 1) = d1.fineline_nbr\r\n and d1.cate_type = 'fineline'\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d2 on t.division = d2.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d2.pur_dept_nbr\r\n and SUBSTRING_INDEX(t.category_nbr_name, '+', 1) = d2.category_nbr\r\n and d2.cate_type = 'category'\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d3 on t.division = d3.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d3.pur_dept_nbr\r\n and d3.cate_type = 'dept'\r\n where\r\n t.ts = '2026-09-30'\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n group by\r\n t.upc_nbr_name\r\n ),\r\n fz3 as (\r\n -- 分子数据by三级问题\r\n SELECT\r\n t.pred_third_level_label -- 三级问题\r\n,\r\n t.upc_nbr_name,\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n dense_rank() over (\r\n partition by t.upc_nbr_name\r\n order by\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) desc\r\n ) as rk\r\n from\r\n ads_ops_af_fb_voc_overview_hyper_di t -- 分子表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n where\r\n t.ts = '2026-09-30'\r\n and t.pred_third_level_label not in ('商品其他', '问题不明确', '其他回访')\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n group by\r\n t.pred_third_level_label -- 三级问题\r\n,\r\n t.upc_nbr_name -- 'upc条码+商品中文名称'\r\n ),\r\n t3 as (\r\n -- upc三级问题负反馈率\r\n SELECT\r\n t1.upc_nbr_name,\r\n t2.pred_third_level_label -- 三级问题\r\n,\r\n t1.item_order_cnt as order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n t2.fb_order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n t2.rk -- 排序\r\n from\r\n fm t1\r\n left join fz3 t2 on (t1.upc_nbr_name = t2.upc_nbr_name)\r\n ),\r\n top_1 as (\r\n SELECT\r\n -- top 1\r\n 'TOP1问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top1\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 1\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_2 as (\r\n SELECT\r\n -- top 2\r\n 'TOP2问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top2\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 2\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_3 as (\r\n SELECT\r\n -- top 3\r\n 'TOP3问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top3\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 3\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_4 as (\r\n SELECT\r\n -- top 4\r\n 'TOP4问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top4\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 4\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_5 as (\r\n SELECT\r\n -- top 5\r\n 'TOP5问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top5\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 5\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n )\r\n SELECT\r\n t1.division,\r\n t1.pur_dept_nbr_name,\r\n t1.category_nbr_name,\r\n t1.fineline_nbr_name,\r\n concat(t1.upc_nbr_name, '+', ifnull(t1.item_cn_name, '')) upc_nbr_name,\r\n t1.order_id_set_mtd as '总订单量',\r\n t2.fb_order_id_set as '总负反馈单量',\r\n t2.fb_order_id_set_pro as '商品负反馈单量',\r\n t2.fb_order_id_set_lv as '履约负反馈单量',\r\n t2.fb_order_id_set_ser as '售后&服务负反馈单量',\r\n t2.fb_order_id_set_other as '其他负反馈单量',\r\n t1.order_id_set_lm as '总订单量环比',\r\n t2.fb_order_id_set_lm as '总负反馈单量环比',\r\n t2.fb_order_id_set_pro_lm as '商品负反馈单量环比',\r\n t2.fb_order_id_set_lv_lm as '履约负反馈单量环比',\r\n t2.fb_order_id_set_ser_lm as '售后&服务负反馈单量环比',\r\n t2.fb_order_id_set_other_lm as '其他负反馈单量环比',\r\n t2.red,\r\n t2.yellow,\r\n t2.line_order,\r\n top_1.qa as top1 -- 三级问题top1\r\n,\r\n top_2.qa as top2 -- 三级问题top2\r\n,\r\n top_3.qa as top3 -- 三级问题top3\r\n,\r\n top_4.qa as top4 -- 三级问题top4\r\n,\r\n top_5.qa as top5 -- 三级问题top5\r\n,\r\n top_1.top_fz as top1_fz,\r\n top_1.top_fm as top1_fm,\r\n top_2.top_fz as top2_fz,\r\n top_2.top_fm as top2_fm,\r\n top_3.top_fz as top3_fz,\r\n top_3.top_fm as top3_fm,\r\n top_4.top_fz as top4_fz,\r\n top_4.top_fm as top4_fm,\r\n top_5.top_fz as top5_fz,\r\n top_5.top_fm as top5_fm\r\n from\r\n fm t1\r\n left join fz t2 on t1.upc_nbr_name = t2.upc_nbr_name\r\n left join top_1 on t1.upc_nbr_name = top_1.upc_nbr_name\r\n left join top_2 on t1.upc_nbr_name = top_2.upc_nbr_name\r\n left join top_3 on t1.upc_nbr_name = top_3.upc_nbr_name\r\n left join top_4 on t1.upc_nbr_name = top_4.upc_nbr_name\r\n left join top_5 on t1.upc_nbr_name = top_5.upc_nbr_name\r\n where\r\n t1.item_order_cnt >= if('30' = 'ALL', 0, '30')\r\n ) as `table_real`\r\n where\r\n (\r\n `upc_nbr_name` is not null\r\n and `upc_nbr_name` <> ''\r\n )\r\n group by\r\n `dim_0`,\r\n `dim_1`,\r\n `dim_2`,\r\n `dim_3`,\r\n `dim_4`\r\n having\r\n if(\r\n 'ALL' not in ('黄', '红'),(\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n case\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`red`) then '红'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`red`)\r\n and (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`yellow`) then '黄'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`yellow`) then '绿'\r\n end,\r\n null\r\n )\r\n ) in ('黄', '红'),\r\n 1\r\n ) = true\r\n ) x\r\n union all\r\n select\r\n *\r\n from\r\n (\r\n select\r\n cast(null as VARCHAR(50)) as `dim_0`,\r\n cast(null as VARCHAR(50)) as `dim_1`,\r\n cast(null as VARCHAR(50)) as `dim_2`,\r\n cast(null as VARCHAR(50)) as `dim_3`,\r\n cast(null as VARCHAR(50)) as `dim_4`,\r\n bitmap_union_count(`总订单量`) as `m_0`,\r\n bitmap_union_count(`总负反馈单量`) as `m_1`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n case\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`red`) then '红'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`red`)\r\n and (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) >= max(`yellow`) then '黄'\r\n when (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`)\r\n ) < max(`yellow`) then '绿'\r\n end,\r\n null\r\n ) as `m_2`,\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`) as `m_3`,\r\n (\r\n bitmap_union_count(`总负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`总负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_4`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n max(`yellow`),\r\n null\r\n ) as `m_5`,\r\n if(\r\n (bitmap_union_count(`总负反馈单量`)) > max(`line_order`)\r\n and (bitmap_union_count(`总订单量`)) > 500,\r\n max(`red`),\r\n null\r\n ) as `m_6`,\r\n bitmap_union_count(`商品负反馈单量`) / bitmap_union_count(`总订单量`) as `m_7`,\r\n (\r\n bitmap_union_count(`商品负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`商品负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_8`,\r\n bitmap_union_count(`履约负反馈单量`) / bitmap_union_count(`总订单量`) as `m_9`,\r\n (\r\n bitmap_union_count(`履约负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`履约负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_10`,\r\n bitmap_union_count(`售后&服务负反馈单量`) / bitmap_union_count(`总订单量`) as `m_11`,\r\n (\r\n bitmap_union_count(`售后&服务负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`售后&服务负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_12`,\r\n bitmap_union_count(`其他负反馈单量`) / bitmap_union_count(`总订单量`) as `m_13`,\r\n (\r\n bitmap_union_count(`其他负反馈单量`) / bitmap_union_count(`总订单量`) - bitmap_union_count(`其他负反馈单量环比`) / bitmap_union_count(`总订单量环比`)\r\n ) * 100 as `m_14`,\r\n max(`top1`) as `m_15`,\r\n sum(`top1_fz`) as `m_16`,\r\n sum(`top1_fz`) / sum(`top1_fm`) as `m_17`,\r\n max(`top2`) as `m_18`,\r\n sum(`top2_fz`) as `m_19`,\r\n sum(`top2_fz`) / sum(`top2_fm`) as `m_20`,\r\n max(`top3`) as `m_21`,\r\n sum(`top3_fz`) as `m_22`,\r\n sum(`top3_fz`) / sum(`top3_fm`) as `m_23`,\r\n max(`top4`) as `m_24`,\r\n sum(`top4_fz`) as `m_25`,\r\n sum(`top4_fz`) / sum(`top4_fm`) as `m_26`,\r\n max(`top5`) as `m_27`,\r\n sum(`top5_fz`) as `m_28`,\r\n sum(`top5_fz`) / sum(`top5_fm`) as `m_29`,\r\n 31 as `__grouping_id`\r\n from\r\n (\r\n /**\r\n @creater:vn52tsy\r\n @report:大卖场顾客负反馈看板 \r\n 聚合到商品粒度，过滤订单量，不支持门店权限\r\n **/\r\n with fm as (\r\n -- 分母数据\r\n SELECT\r\n t.upc_nbr_name -- 'upc条码+商品中文名称'\r\n,\r\n df.item_cn_name,\r\n max(t.division) division -- '商品分区'\r\n,\r\n max(t.pur_dept_nbr_name) pur_dept_nbr_name -- '采购部门编号+中文名'\r\n,\r\n max(t.category_nbr_name) category_nbr_name -- '大类编号+中文名'\r\n,\r\n max(t.fineline_nbr_name) fineline_nbr_name -- '细类编号+中文名'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt1w\r\n else t.order_id_set_mtd\r\n end\r\n ) order_id_set_mtd -- '订单ID集合近一周' -- '订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt2w\r\n else t.order_id_set_lm\r\n end\r\n ) order_id_set_lm -- '订单ID集合近一周环比' -- '订单ID集合月环比'\r\n,\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.order_id_set_lt1w\r\n else t.order_id_set_mtd\r\n end\r\n ) item_order_cnt -- 商品对应的订单量\r\n from\r\n ads_ops_af_fb_voc_overview_traffic_hyper_di t -- 分母表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n left join dim.dim_af_fb_voc_upc_info_hyper_df df on (t.upc_nbr_name = df.upc_nbr)\r\n where\r\n t.ts = '2026-09-30'\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n GROUP BY\r\n t.upc_nbr_name,\r\n df.item_cn_name\r\n ),\r\n fz as (\r\n -- 分子by upc\r\n SELECT\r\n t.upc_nbr_name,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt2w\r\n else t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 商品\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_pro -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '商品' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_pro_lm -- '反馈订单ID集合近一周环比'\r\n -- 履约\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_lv -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '履约' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_lv_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 售后&服务\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_ser -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '售后&服务' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_ser_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n -- 其他\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lt1w\r\n WHEN '周' = '月'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_id_set_other -- '反馈订单ID集合近一周' -- '反馈订单ID集合月至今'\r\n,\r\n bitmap_union(\r\n CASE\r\n WHEN '周' = '周'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lt2w\r\n WHEN '周' = '月'\r\n and t.problem_class = '其他' THEN t.fb_order_id_set_lm\r\n end\r\n ) fb_order_id_set_other_lm -- '反馈订单ID集合近一周环比' -- '反馈订单ID集合月至今环比'\r\n,\r\n max(\r\n ifnull(\r\n d1.red_line_value,\r\n ifnull(d2.red_line_value, d3.red_line_value)\r\n )\r\n ) as red,\r\n max(\r\n ifnull(\r\n d1.yellow_line_value,\r\n ifnull(d2.yellow_line_value, d3.yellow_line_value)\r\n )\r\n ) as yellow,\r\n max(\r\n ifnull(\r\n d1.fb_order_id_qty_lt1w,\r\n ifnull(d2.fb_order_id_qty_lt1w, d3.fb_order_id_qty_lt1w)\r\n )\r\n ) as line_order\r\n from\r\n ads_ops_af_fb_voc_overview_hyper_di t -- 分子表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n -- 红绿灯配置表\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d1 on t.division = d1.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d1.pur_dept_nbr\r\n and SUBSTRING_INDEX(t.category_nbr_name, '+', 1) = d1.category_nbr\r\n and SUBSTRING_INDEX(t.fineline_nbr_name, '+', 1) = d1.fineline_nbr\r\n and d1.cate_type = 'fineline'\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d2 on t.division = d2.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d2.pur_dept_nbr\r\n and SUBSTRING_INDEX(t.category_nbr_name, '+', 1) = d2.category_nbr\r\n and d2.cate_type = 'category'\r\n left join dim.dim_af_fb_ost_baseline_hyper_df d3 on t.division = d3.division\r\n and SUBSTRING_INDEX(t.pur_dept_nbr_name, '+', 1) = d3.pur_dept_nbr\r\n and d3.cate_type = 'dept'\r\n where\r\n t.ts = '2026-09-30'\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n group by\r\n t.upc_nbr_name\r\n ),\r\n fz3 as (\r\n -- 分子数据by三级问题\r\n SELECT\r\n t.pred_third_level_label -- 三级问题\r\n,\r\n t.upc_nbr_name,\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) fb_order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n dense_rank() over (\r\n partition by t.upc_nbr_name\r\n order by\r\n bitmap_union_count(\r\n CASE\r\n WHEN '周' = '周' THEN t.fb_order_id_set_lt1w\r\n else t.fb_order_id_set_mtd\r\n end\r\n ) desc\r\n ) as rk\r\n from\r\n ads_ops_af_fb_voc_overview_hyper_di t -- 分子表\r\n inner join dim.dim_af_fb_voc_store_info_hyper_df st on (\r\n t.store_nbr = st.store_nbr\r\n and st.store_status_code in ('1', '2')\r\n )\r\n inner join dim.dim_common_channel_f ch on (\r\n t.channel_id = ch.channel_id\r\n and ch.store_type = 'hyper'\r\n ) -- 渠道表\r\n where\r\n t.ts = '2026-09-30'\r\n and t.pred_third_level_label not in ('商品其他', '问题不明确', '其他回访')\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.hyper_format_name in ('ALL')\r\n ) -- added ： 2025/03/04\r\n and (\r\n 'ALL' in ('1015')\r\n OR t.store_nbr in ('1015')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.region_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.district_en in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR st.city_cn in ('ALL')\r\n )\r\n and (\r\n 'omni_channel' in ('omni_channel')\r\n OR ch.channel_type in ('omni_channel')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class1_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR ch.channel_class2_cn in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.division in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.pur_dept_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.category_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.fineline_nbr_name in ('ALL')\r\n )\r\n and (\r\n 'ALL' in ('ALL')\r\n OR t.upc_nbr_name in ('ALL')\r\n )\r\n group by\r\n t.pred_third_level_label -- 三级问题\r\n,\r\n t.upc_nbr_name -- 'upc条码+商品中文名称'\r\n ),\r\n t3 as (\r\n -- upc三级问题负反馈率\r\n SELECT\r\n t1.upc_nbr_name,\r\n t2.pred_third_level_label -- 三级问题\r\n,\r\n t1.item_order_cnt as order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n t2.fb_order_set -- '反馈订单ID集合近一周或月至今'\r\n,\r\n t2.rk -- 排序\r\n from\r\n fm t1\r\n left join fz3 t2 on (t1.upc_nbr_name = t2.upc_nbr_name)\r\n ),\r\n top_1 as (\r\n SELECT\r\n -- top 1\r\n 'TOP1问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top1\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 1\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_2 as (\r\n SELECT\r\n -- top 2\r\n 'TOP2问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top2\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 2\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_3 as (\r\n SELECT\r\n -- top 3\r\n 'TOP3问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top3\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 3\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_4 as (\r\n SELECT\r\n -- top 4\r\n 'TOP4问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top4\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 4\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n ),\r\n top_5 as (\r\n SELECT\r\n -- top 5\r\n 'TOP5问题' AS QA_TYPE,\r\n t3.upc_nbr_name,\r\n GROUP_CONCAT(distinct t3.pred_third_level_label) 'qa' -- 三级问题top5\r\n,\r\n t3.fb_order_set as top_fz,\r\n t3.order_set as top_fm\r\n from\r\n t3\r\n where\r\n t3.rk = 5\r\n and t3.fb_order_set > 0\r\n group by\r\n t3.upc_nbr_name,\r\n t3.fb_order_set,\r\n t3.order_set\r\n )\r\n SELECT\r\n t1.division,\r\n t1.pur_dept_nbr_name,\r\n t1.category_nbr_name,\r\n t1.fineline_nbr_name,\r\n concat(t1.upc_nbr_name, '+', ifnull(t1.item_cn_name, '')) upc_nbr_name,\r\n t1.order_id_set_mtd as '总订单量',\r\n t2.fb_order_id_set as '总负反馈单量',\r\n t2.fb_order_id_set_pro as '商品负反馈单量',\r\n t2.fb_order_id_set_lv as '履约负反馈单量',\r\n t2.fb_order_id_set_ser as '售后&服务负反馈单量',\r\n t2.fb_order_id_set_other as '其他负反馈单量',\r\n t1.order_id_set_lm as '总订单量环比',\r\n t2.fb_order_id_set_lm as '总负反馈单量环比',\r\n t2.fb_order_id_set_pro_lm as '商品负反馈单量环比',\r\n t2.fb_order_id_set_lv_lm as '履约负反馈单量环比',\r\n t2.fb_order_id_set_ser_lm as '售后&服务负反馈单量环比',\r\n t2.fb_order_id_set_other_lm as '其他负反馈单量环比',\r\n t2.red,\r\n t2.yellow,\r\n t2.line_order,\r\n top_1.qa as top1 -- 三级问题top1\r\n,\r\n top_2.qa as top2 -- 三级问题top2\r\n,\r\n top_3.qa as top3 -- 三级问题top3\r\n,\r\n top_4.qa as top4 -- 三级问题top4\r\n,\r\n top_5.qa as top5 -- 三级问题top5\r\n,\r\n top_1.top_fz as top1_fz,\r\n top_1.top_fm as top1_fm,\r\n top_2.top_fz as top2_fz,\r\n top_2.top_fm as top2_fm,\r\n top_3.top_fz as top3_fz,\r\n top_3.top_fm as top3_fm,\r\n top_4.top_fz as top4_fz,\r\n top_4.top_fm as top4_fm,\r\n top_5.top_fz as top5_fz,\r\n top_5.top_fm as top5_fm\r\n from\r\n fm t1\r\n left join fz t2 on t1.upc_nbr_name = t2.upc_nbr_name\r\n left join top_1 on t1.upc_nbr_name = top_1.upc_nbr_name\r\n left join top_2 on t1.upc_nbr_name = top_2.upc_nbr_name\r\n left join top_3 on t1.upc_nbr_name = top_3.upc_nbr_name\r\n left join top_4 on t1.upc_nbr_name = top_4.upc_nbr_name\r\n left join top_5 on t1.upc_nbr_name = top_5.upc_nbr_name\r\n where\r\n t1.item_order_cnt >= if('30' = 'ALL', 0, '30')\r\n ) as `table_real`\r\n where\r\n (\r\n `upc_nbr_name` is not null\r\n and `upc_nbr_name` <> ''\r\n )\r\n ) x\r\n ) as `t0`\r\norder by\r\n case\r\n `__grouping_id`\r\n when 31.0 then 0\r\n else 1\r\n end asc,\r\n `m_1` desc\r\nlimit\r\n 100001",
  "table_meta": {
    "ads.ads_ops_af_fb_voc_overview_traffic_hyper_di": "CREATE TABLE `ads_ops_af_fb_voc_overview_traffic_hyper_di` (\n `ts` date NULL COMMENT \"分区日期\",\n `store_nbr` varchar(200) NULL COMMENT \"门店号\",\n `channel_id` varchar(200) NULL COMMENT \"渠道ID\",\n `division` varchar(200) NULL COMMENT \"商品分区\",\n `pur_dept_nbr_name` varchar(200) NULL COMMENT \"采购部门编号+中文名\",\n `category_nbr_name` varchar(200) NULL COMMENT \"大类编号+中文名\",\n `fineline_nbr_name` varchar(200) NULL COMMENT \"细类编号+中文名\",\n `upc_nbr_name` varchar(200) NULL COMMENT \"upc条码+商品中文名称\",\n `order_id_set` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合\",\n `order_id_set_lt1w` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合近一周\",\n `order_id_set_lt2w` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合近一周环比\",\n `order_id_set_mtd` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合月至今\",\n `order_id_set_lm` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合月至今环比\",\n `etl_load_time` varchar(200) MAX NULL COMMENT \"数据加载时间\"\n) ENGINE=OLAP \nAGGREGATE KEY(`ts`, `store_nbr`, `channel_id`, `division`, `pur_dept_nbr_name`, `category_nbr_name`, `fineline_nbr_name`, `upc_nbr_name`)\nCOMMENT \"ADS_大卖场顾客负反馈Overview客流表\"\nPARTITION BY RANGE(`ts`)\n(PARTITION p20230729 VALUES [(\"2023-07-29\"), (\"2023-07-30\")),\nPARTITION p20230730 VALUES [(\"2023-07-30\"), (\"2023-07-31\")),\nPARTITION p20230731 VALUES [(\"2023-07-31\"), (\"2023-08-01\")),\nPARTITION p20230801 VALUES [(\"2023-08-01\"), (\"2023-08-02\")),\nPARTITION p20230802 VALUES [(\"2023-08-02\"), (\"2023-08-03\")),\nPARTITION p20230803 VALUES [(\"2023-08-03\"), (\"2023-08-04\")),\nPARTITION p20240506 VALUES [(\"2024-05-06\"), (\"2024-05-07\")),\nPARTITION p20240507 VALUES [(\"2024-05-07\"), (\"2024-05-08\")),\nPARTITION p20240508 VALUES [(\"2024-05-08\"), (\"2024-05-09\")),\nPARTITION p20240509 VALUES [(\"2024-05-09\"), (\"2024-05-10\")),\nPARTITION p20240510 VALUES [(\"2024-05-10\"), (\"2024-05-11\")),\nPARTITION p20240511 VALUES [(\"2024-05-11\"), (\"2024-05-12\")),\nPARTITION p20250715 VALUES [(\"2025-07-15\"), (\"2025-07-16\")),\nPARTITION p20250716 VALUES [(\"2025-07-16\"), (\"2025-07-17\")),\nPARTITION p20250717 VALUES [(\"2025-07-17\"), (\"2025-07-18\")),\nPARTITION p20250718 VALUES [(\"2025-07-18\"), (\"2025-07-19\")),\nPARTITION p20250719 VALUES [(\"2025-07-19\"), (\"2025-07-20\")),\nPARTITION p20250720 VALUES [(\"2025-07-20\"), (\"2025-07-21\")),\nPARTITION p20250721 VALUES [(\"2025-07-21\"), (\"2025-07-22\")),\nPARTITION p20250722 VALUES [(\"2025-07-22\"), (\"2025-07-23\")),\nPARTITION p20250723 VALUES [(\"2025-07-23\"), (\"2025-07-24\")),\nPARTITION p20250724 VALUES [(\"2025-07-24\"), (\"2025-07-25\")),\nPARTITION p20250725 VALUES [(\"2025-07-25\"), (\"2025-07-26\")),\nPARTITION p20250726 VALUES [(\"2025-07-26\"), (\"2025-07-27\")),\nPARTITION p20250727 VALUES [(\"2025-07-27\"), (\"2025-07-28\")),\nPARTITION p20250728 VALUES [(\"2025-07-28\"), (\"2025-07-29\")),\nPARTITION p20250729 VALUES [(\"2025-07-29\"), (\"2025-07-30\")),\nPARTITION p20250730 VALUES [(\"2025-07-30\"), (\"2025-07-31\")),\nPARTITION p20250731 VALUES [(\"2025-07-31\"), (\"2025-08-01\")))\nDISTRIBUTED BY HASH(`ts`, `store_nbr`, `channel_id`, `upc_nbr_name`) BUCKETS 10 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"dynamic_partition.buckets\" = \"10\",\n\"dynamic_partition.enable\" = \"true\",\n\"dynamic_partition.end\" = \"1\",\n\"dynamic_partition.history_partition_num\" = \"0\",\n\"dynamic_partition.prefix\" = \"p\",\n\"dynamic_partition.replication_num\" = \"3\",\n\"dynamic_partition.start\" = \"-732\",\n\"dynamic_partition.time_unit\" = \"DAY\",\n\"dynamic_partition.time_zone\" = \"Asia/Shanghai\",\n\"fast_schema_evolution\" = \"false\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "dim.dim_af_fb_voc_store_info_hyper_df": "CREATE TABLE `dim_af_fb_voc_store_info_hyper_df` (\n `ts` date NULL COMMENT \"分区日期\",\n `store_nbr` varchar(200) NULL COMMENT \"门店编码\",\n `store_name` varchar(200) NULL COMMENT \"门店名称\",\n `region_en` varchar(200) NULL COMMENT \"大区域英文名称\",\n `district_en` varchar(200) NULL COMMENT \"小区域英文名称\",\n `city_cn` varchar(200) NULL COMMENT \"城市中文名称\",\n `store_status_code` varchar(200) NULL COMMENT \"门店状态编码\",\n `storage_type_code` varchar(200) NULL COMMENT \"仓店类型编码(1:门店,2:云仓,8:云店)\",\n `hyper_format_name` varchar(200) NULL COMMENT \"Hyper业态名称\",\n `mother_store_nbr` varchar(200) NULL COMMENT \"母店编号\",\n `store_type_code` varchar(200) NULL COMMENT \"门店分类编码(1:实体,2:虚拟)\",\n `etl_load_time` varchar(200) NULL COMMENT \"数据加载时间\"\n) ENGINE=OLAP \nUNIQUE KEY(`ts`, `store_nbr`)\nCOMMENT \"DIM_HyperVOC门店信息维表\"\nDISTRIBUTED BY HASH(`store_nbr`) BUCKETS 1 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"fast_schema_evolution\" = \"false\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "dim.dim_common_channel_f": "CREATE TABLE `dim_common_channel_f` (\n `channel_id` varchar(255) NULL COMMENT \"渠道编号 \",\n `channel_name_en` varchar(255) NULL COMMENT \"渠道名称-英文 \",\n `channel_name_cn` varchar(255) NULL COMMENT \"渠道名称-中文 \",\n `data_source_id` varchar(255) NULL COMMENT \"数据源编码 \",\n `tc_channel_id` varchar(255) NULL COMMENT \"过机渠道号 \",\n `store_type` varchar(255) NULL COMMENT \"业态 \",\n `main_channel_code` varchar(255) NULL COMMENT \"主渠道号 \",\n `main_channel_name` varchar(255) NULL COMMENT \"主渠道名称 \",\n `channel_type` varchar(255) NULL COMMENT \"渠道类型: online-线上 offline-线下 \",\n `valid_flag` varchar(255) NULL COMMENT \"有效标志 0-无效 1-有效 \",\n `channel_prefix` varchar(255) NULL COMMENT \"订单前缀 \",\n `channel_code` varchar(255) NULL COMMENT \"渠道简称 \",\n `channel_id_desc` varchar(255) NULL COMMENT \"渠道编号描述 \",\n `remark` varchar(255) NULL COMMENT \"备注 \",\n `load_ts` varchar(255) NULL COMMENT \"数据加载时间 \",\n `op_cmpny_cd` varchar(255) NULL COMMENT \"维护团队（例如：财务，营运，中台，等）\",\n `load_userid` varchar(255) NULL COMMENT \"数据加载人工号 \",\n `upd_userid` varchar(255) NULL COMMENT \"数据修改人工号 \",\n `upd_ts` varchar(255) NULL COMMENT \"数据修改时间 \",\n `etl_load_time` varchar(255) NULL COMMENT \"etl时间 \",\n `logistics_vendor` varchar(255) NULL COMMENT \"物流商 \",\n `is_throw` varchar(255) NULL COMMENT \"是否需要抛单 \",\n `launch_date` varchar(255) NULL COMMENT \"上线时间 \",\n `channel_type_l1_bi` varchar(255) NULL COMMENT \"BI口径渠道分类一级渠道(建议不再使用，使用channel_type代替）\",\n `channel_type_l2_bi` varchar(255) NULL COMMENT \"BI口径渠道分类二级渠道(建议不再使用，使用channel_class1代替）\",\n `channel_type_l3_bi` varchar(255) NULL COMMENT \"BI口径渠道分类三级渠道(建议不再使用，使用channel_class2代替）\",\n `is_o2o` varchar(255) NULL COMMENT \"是否O2O渠道\",\n `include_b2b` varchar(255) NULL COMMENT \"仅标识是否包含B2B，B2B需要根据订单上的是否大单标签区分\",\n `channel_class1` varchar(255) NULL COMMENT \"一级渠道\",\n `channel_class2` varchar(255) NULL COMMENT \"二级渠道\",\n `channel_business` varchar(255) NULL COMMENT \"已作废，不维护\",\n `platform` varchar(255) NULL COMMENT \"平台\",\n `channel_class1_cn` varchar(255) NULL COMMENT \"一级渠道中文名\",\n `channel_class2_cn` varchar(255) NULL COMMENT \"二级渠道中文名\",\n `fmt` varchar(255) NULL COMMENT \"1：fmt(门店过机）；2：non-fmt；0：不统计\",\n `channel_class1_user` varchar(200) NULL COMMENT \"用户域渠道分类\",\n `channel_class2_pnl` varchar(200) NULL COMMENT \"pnl二级渠道分类\",\n `desc` varchar(65533) NULL COMMENT \"描述\",\n `channel_class1_pnl` varchar(200) NULL COMMENT \"pnl一级渠道分类\",\n `is_public_domain` varchar(200) NULL COMMENT \"是否公共域\",\n `channel_class_O2Opnl` varchar(200) NULL COMMENT \"是否公共域\",\n `fulfill_type` varchar(65533) NULL COMMENT \"履约类型\",\n `channel_level1` varchar(200) NULL COMMENT \"第一层级渠道名称\",\n `channel_level2` varchar(200) NULL COMMENT \"第二层级渠道名称\",\n `channel_level3` varchar(200) NULL COMMENT \"第三层级渠道名称\",\n `channel_level4` varchar(200) NULL COMMENT \"第四层级渠道名称\",\n `channel_level5` varchar(200) NULL COMMENT \"第五层级渠道名称\"\n) ENGINE=OLAP \nDUPLICATE KEY(`channel_id`)\nCOMMENT \"OLAP\"\nDISTRIBUTED BY HASH(`channel_id`) BUCKETS 2 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"fast_schema_evolution\" = \"false\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "dim.dim_af_fb_voc_upc_info_hyper_df": "CREATE TABLE `dim_af_fb_voc_upc_info_hyper_df` (\n `ts` date NULL COMMENT \"分区日期\",\n `upc_nbr` varchar(50) NULL COMMENT \"商品条码\",\n `upc_nbr_13` varchar(50) NULL COMMENT \"13位商品条码\",\n `upc_desc` varchar(200) NULL COMMENT \"upc条码说明\",\n `fruit_greens_code` varchar(50) NULL COMMENT \"水果蔬菜标记: 1水果，2蔬菜\",\n `fruit_greens_name` varchar(50) NULL COMMENT \"水果蔬菜名称\",\n `division` varchar(200) NULL COMMENT \"商品分区\",\n `division2` varchar(200) NULL COMMENT \"商品分区2\",\n `pur_dept_nbr` varchar(50) NULL COMMENT \"采购部门编号\",\n `pur_dept_cn_name` varchar(200) NULL COMMENT \"采购部门中文名\",\n `fineline_nbr` varchar(50) NULL COMMENT \"细类编号\",\n `fineline_cn_name` varchar(200) NULL COMMENT \"细类中文名\",\n `category_nbr` varchar(50) NULL COMMENT \"大类编号\",\n `category_cn_name` varchar(200) NULL COMMENT \"大类中文名\",\n `item_cn_name` varchar(200) NULL COMMENT \"商品中文名\",\n `brand_name` varchar(500) NULL COMMENT \"品牌名称\",\n `adjust_brand_owner_company_name` varchar(500) NULL COMMENT \"调整后品牌归属公司名称\",\n `etl_load_time` varchar(50) NULL COMMENT \"数据加载时间\"\n) ENGINE=OLAP \nDUPLICATE KEY(`ts`, `upc_nbr`)\nCOMMENT \"DIM_HyperVOC商品UPC粒度信息维表\"\nDISTRIBUTED BY HASH(`ts`, `upc_nbr`) BUCKETS 1 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"fast_schema_evolution\" = \"false\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "ads.ads_ops_af_fb_voc_overview_hyper_di": "CREATE TABLE `ads_ops_af_fb_voc_overview_hyper_di` (\n `ts` date NULL COMMENT \"分区日期\",\n `store_nbr` varchar(200) NULL COMMENT \"门店号\",\n `channel_id` varchar(200) NULL COMMENT \"渠道ID\",\n `division` varchar(200) NULL COMMENT \"商品分区\",\n `pur_dept_nbr_name` varchar(200) NULL COMMENT \"采购部门编号+中文名\",\n `category_nbr_name` varchar(200) NULL COMMENT \"大类编号+中文名\",\n `fineline_nbr_name` varchar(200) NULL COMMENT \"细类编号+中文名\",\n `upc_nbr_name` varchar(200) NULL COMMENT \"upc条码+商品中文名称\",\n `problem_class` varchar(200) NULL COMMENT \"归属业务分类\",\n `pred_first_level_label` varchar(200) NULL COMMENT \"一级问题\",\n `pred_second_level_label` varchar(200) NULL COMMENT \"二级问题\",\n `pred_third_level_label` varchar(200) NULL COMMENT \"三级问题[PK]\",\n `fb_order_id_set` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合\",\n `fb_order_id_set_lt1w` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合近一周\",\n `fb_order_id_set_lt2w` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合近一周环比\",\n `fb_order_id_set_mtd` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合月至今\",\n `fb_order_id_set_lm` bitmap BITMAP_UNION NULL COMMENT \"反馈订单ID集合月至今环比\",\n `etl_load_time` varchar(200) MAX NULL COMMENT \"数据加载时间\"\n) ENGINE=OLAP \nAGGREGATE KEY(`ts`, `store_nbr`, `channel_id`, `division`, `pur_dept_nbr_name`, `category_nbr_name`, `fineline_nbr_name`, `upc_nbr_name`, `problem_class`, `pred_first_level_label`, `pred_second_level_label`, `pred_third_level_label`)\nCOMMENT \"ADS_大卖场顾客负反馈Overview汇总表\"\nPARTITION BY RANGE(`ts`)\n(PARTITION p20230101 VALUES [(\"2023-01-01\"), (\"2023-01-02\")),\nPARTITION p20230102 VALUES [(\"2023-01-02\"), (\"2023-01-03\")),\nPARTITION p20230103 VALUES [(\"2023-01-03\"), (\"2023-01-04\")),\nPARTITION p20230104 VALUES [(\"2023-01-04\"), (\"2023-01-05\")),\nPARTITION p20251217 VALUES [(\"2025-12-17\"), (\"2025-12-18\")),\nPARTITION p20251218 VALUES [(\"2025-12-18\"), (\"2025-12-19\")),\nPARTITION p20251219 VALUES [(\"2025-12-19\"), (\"2025-12-20\")),\nPARTITION p20251220 VALUES [(\"2025-12-20\"), (\"2025-12-21\")),\nPARTITION p20251221 VALUES [(\"2025-12-21\"), (\"2025-12-22\")),\nPARTITION p20251222 VALUES [(\"2025-12-22\"), (\"2025-12-23\")),\nPARTITION p20251223 VALUES [(\"2025-12-23\"), (\"2025-12-24\")),\nPARTITION p20251224 VALUES [(\"2025-12-24\"), (\"2025-12-25\")),\nPARTITION p20251225 VALUES [(\"2025-12-25\"), (\"2025-12-26\")),\nPARTITION p20251226 VALUES [(\"2025-12-26\"), (\"2025-12-27\")),\nPARTITION p20251227 VALUES [(\"2025-12-27\"), (\"2025-12-28\")),\nPARTITION p20251228 VALUES [(\"2025-12-28\"), (\"2025-12-29\")),\nPARTITION p20251229 VALUES [(\"2025-12-29\"), (\"2025-12-30\")),\nPARTITION p20251230 VALUES [(\"2025-12-30\"), (\"2025-12-31\")))\nDISTRIBUTED BY HASH(`ts`) BUCKETS 1 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"dynamic_partition.buckets\" = \"1\",\n\"dynamic_partition.enable\" = \"true\",\n\"dynamic_partition.end\" = \"1\",\n\"dynamic_partition.history_partition_num\" = \"0\",\n\"dynamic_partition.prefix\" = \"p\",\n\"dynamic_partition.replication_num\" = \"3\",\n\"dynamic_partition.start\" = \"-2147483648\",\n\"dynamic_partition.time_unit\" = \"DAY\",\n\"dynamic_partition.time_zone\" = \"Asia/Shanghai\",\n\"fast_schema_evolution\" = \"false\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "dim.dim_af_fb_ost_baseline_hyper_df": "CREATE TABLE `dim_af_fb_ost_baseline_hyper_df` (\n `ts` date NULL COMMENT \"日期分区\",\n `id` varchar(200) NULL COMMENT \"id\",\n `row_id` varchar(200) NULL COMMENT \"row_id\",\n `cate_type` varchar(200) NULL COMMENT \"维度类型\",\n `division` varchar(200) NULL COMMENT \"商品分区\",\n `pur_dept_nbr` varchar(200) NULL COMMENT \"商品部门编号\",\n `category_nbr` varchar(200) NULL COMMENT \"商品品类编号\",\n `fineline_nbr` varchar(200) NULL COMMENT \"商品fineline编号\",\n `pur_dept_cn_name` varchar(200) NULL COMMENT \"商品部门\",\n `category_cn_name` varchar(200) NULL COMMENT \"商品品类中文名\",\n `red_line_value` decimal(4, 4) NULL COMMENT \"红灯线阈值\",\n `yellow_line_value` decimal(4, 4) NULL COMMENT \"黄灯线阈值\",\n `fb_order_id_qty_lt1w` int(11) NULL COMMENT \"负反馈周订单量\",\n `creator` varchar(200) NULL COMMENT \"创建人\",\n `editor` varchar(200) NULL COMMENT \"修改人\",\n `c_uid` varchar(200) NULL COMMENT \"创建人ID\",\n `e_uid` varchar(200) NULL COMMENT \"修改人ID\",\n `create_time` varchar(200) NULL COMMENT \"创建时间\",\n `update_time` varchar(200) NULL COMMENT \"修改时间\",\n `is_del` varchar(200) NULL COMMENT \"是否删除\",\n `etl_load_time` varchar(200) NULL COMMENT \"数据加载时间\"\n) ENGINE=OLAP \nDUPLICATE KEY(`ts`)\nCOMMENT \"DIM_HyperOST红黄绿灯阈值配置表\"\nDISTRIBUTED BY HASH(`ts`) BUCKETS 1 \nPROPERTIES (\n\"compression\" = \"LZ4\",\n\"fast_schema_evolution\" = \"true\",\n\"replicated_storage\" = \"true\",\n\"replication_num\" = \"3\"\n);",
    "ads.mv_ads_ops_af_fb_voc_overview_traffic_store_hyper_di": "CREATE MATERIALIZED VIEW `mv_ads_ops_af_fb_voc_overview_traffic_store_hyper_di` (`ts`, `store_nbr`, `region_en`, `district_en`, `city_cn`, `order_id_qty_lt1w`, `order_id_qty_lt2w`, `order_id_qty_mtd`, `order_id_qty_lm`)\nPARTITION BY (`ts`)\nDISTRIBUTED BY HASH(`ts`, `store_nbr`)\nREFRESH ASYNC START(\"2023-01-01 06:00:00\") EVERY(INTERVAL 1 DAY)\nPROPERTIES (\n\"replicated_storage\" = \"true\",\n\"partition_refresh_number\" = \"7\",\n\"session.enable_spill\" = \"true\",\n\"replication_num\" = \"3\",\n\"storage_medium\" = \"HDD\"\n)\nAS SELECT `ads`.`t1a`.`ts`, `ads`.`t1a`.`store_nbr`, `dim`.`t1b`.`region_en`, `dim`.`t1b`.`district_en`, `dim`.`t1b`.`city_cn`, bitmap_union_count(`ads`.`t1a`.`order_id_set_lt1w`) AS `order_id_qty_lt1w`, bitmap_union_count(`ads`.`t1a`.`order_id_set_lt2w`) AS `order_id_qty_lt2w`, bitmap_union_count(`ads`.`t1a`.`order_id_set_mtd`) AS `order_id_qty_mtd`, bitmap_union_count(`ads`.`t1a`.`order_id_set_lm`) AS `order_id_qty_lm`\nFROM `ads`.`ads_ops_af_fb_voc_overview_traffic_hyper_di` AS `t1a` INNER JOIN `dim`.`dim_af_fb_voc_store_info_hyper_df` AS `t1b` ON (`ads`.`t1a`.`store_nbr` = `dim`.`t1b`.`store_nbr`) AND (`dim`.`t1b`.`store_status_code` IN ('1', '2')) INNER JOIN `dim`.`dim_common_channel_f` AS `t1c` ON (`ads`.`t1a`.`channel_id` = `dim`.`t1c`.`channel_id`) AND (`dim`.`t1c`.`store_type` = 'hyper')\nGROUP BY `ads`.`t1a`.`ts`, `ads`.`t1a`.`store_nbr`, `dim`.`t1b`.`region_en`, `dim`.`t1b`.`district_en`, `dim`.`t1b`.`city_cn`;"
  },
  "table_row_count": { },
  "column_statistics": { },
  "session_variables": "{\"partial_update_mode\":\"auto\",\"cbo_cte_reuse\":true,\"character_set_connection\":\"utf8\",\"cbo_use_correlated_join_estimate\":true,\"enable_insert_strict\":true,\"enable_connector_adaptive_io_tasks\":true,\"tx_isolation\":\"REPEATABLE-READ\",\"enable_hive_metadata_cache_with_insert\":false,\"automv_prune_rollup_unable_aggregate_with_conjuncts\":true,\"hive_temp_staging_dir\":\"/tmp/starrocks\",\"cbo_cte_reuse_rate_v2\":1.15,\"spill_rand_ratio\":0.1,\"enable_datacache_io_adaptor\":false,\"character_set_results\":\"utf8\",\"materialized_view_union_rewrite_mode\":0,\"enable_count_star_optimization\":true,\"enable_iceberg_column_statistics\":false,\"thrift_plan_protocol\":\"binary\",\"enable_plan_serialize_concurrently\":true,\"materialized_view_max_relation_mapping_size\":10,\"enable_rewrite_partition_column_minmax\":true,\"global_runtime_filter_build_min_size\":131072,\"enable_iceberg_identity_column_optimize\":true,\"enable_view_based_mv_rewrite\":false,\"query_excluding_mv_names\":\"\",\"enable_rewrite_simple_agg_to_meta_scan\":false,\"enable_ukfk_opt\":false,\"enable_adaptive_sink_dop\":true,\"enable_ukfk_join_reorder\":false,\"consistent_hash_virtual_number\":32,\"warehouse\":\"default_warehouse\",\"enable_profile\":false,\"load_mem_limit\":34359738368,\"spill_storage_volume\":\"\",\"cbo_eq_base_type\":\"varchar\",\"enable_materialized_view_for_insert\":false,\"large_decimal_underlying_type\":\"panic\",\"sql_safe_updates\":0,\"runtime_filter_early_return_selectivity\":0.05,\"enable_local_shuffle_agg\":true,\"disable_function_fold_constants\":false,\"enable_query_queue\":true,\"enable_cbo_view_based_mv_rewrite\":false,\"automv_sampling_buckets\":512,\"select_ratio_threshold\":0.15,\"automv_decay_accelerated_queries\":false,\"enable_connector_sink_global_shuffle\":true,\"query_delivery_timeout\":300,\"collation_database\":\"utf8_general_ci\",\"spill_mem_table_size\":104857600,\"enable_gin_filter\":true,\"follower_query_forward_mode\":\"\",\"orc_use_column_names\":false,\"spill_enable_compaction\":true,\"cbo_use_lock_db\":false,\"new_planner_agg_stage\":0,\"enable_strict_order_by\":true,\"hash_join_interpolate_passthrough\":false,\"cbo_enable_intersect_add_distinct\":true,\"use_compute_nodes\":-1,\"enable_metadata_profile\":false,\"collation_connection\":\"utf8_general_ci\",\"enable_rewrite_bitmap_union_to_bitamp_agg\":false,\"enable_force_rule_based_mv_rewrite\":false,\"enable_array_distinct_after_agg_opt\":true,\"resource_group\":\"\",\"group_execution_max_groups\":128,\"scan_hive_partition_num_limit\":0,\"always_collect_low_card_dict\":false,\"enable_materialized_view_plan_cache\":true,\"spill_operator_max_bytes\":1048576000,\"enable_materialized_view_agg_pushdown_rewrite\":false,\"cbo_max_reorder_node_use_dp\":10,\"cbo_prepare_metadata_thread_pool_size\":16,\"enable_result_sink_accumulate\":true,\"enable_hive_column_stats\":false,\"enable_async_profile\":false,\"enable_groupby_use_output_alias\":false,\"global_runtime_filter_wait_timeout\":20,\"forward_to_leader\":false,\"enable_prune_column_after_index_filter\":true,\"count_distinct_column_buckets\":1024,\"cross_join_cost_penalty\":1000000,\"query_cache_agg_cardinality_limit\":5000000,\"connector_sink_spill_mem_limit_threshold\":0.5,\"cboPushDownAggregateMode_v1\":-1,\"window_partition_mode\":1,\"enable_tablet_internal_parallel_v2\":true,\"interpolate_passthrough\":true,\"analyze_mv_v2\":\"sample\",\"enable_incremental_mv\":false,\"cbo_push_down_topn_limit\":0,\"automv_enable_semi_anti_join\":true,\"SQL_AUTO_IS_NULL\":false,\"event_scheduler\":\"OFF\",\"parallel_merge_late_materialization_mode\":\"auto\",\"max_pipeline_dop\":64,\"broadcast_right_table_scale_factor\":10,\"materialized_view_rewrite_mode\":\"DEFAULT\",\"enable_read_iceberg_puffin_ndv\":true,\"enable_write_hive_external_table\":true,\"enable_simplify_case_when\":true,\"enable_aggregation_pipeline_share_limit\":true,\"runtime_join_filter_push_down_limit\":1024000,\"trace_log_mode\":\"command\",\"enable_scan_datacache\":true,\"enable_scan_predicate_expr_reuse\":false,\"big_query_log_cpu_second_threshold\":480,\"div_precision_increment\":4,\"runtime_adaptive_dop_max_block_rows_per_driver_seq\":16384,\"log_rejected_record_num\":0,\"phased_scheduler_max_concurrency\":2,\"populate_datacache_mode\":\"auto\",\"enable_short_circuit\":false,\"cbo_push_down_distinct_below_window\":true,\"sql_mode_v2\":32,\"prefer_cte_rewrite\":false,\"optimizer_materialized_view_timelimit\":1000,\"hdfs_backend_selector_scan_range_shuffle\":false,\"automv_card_rowcount_ratio_lwm_v2\":0,\"pipeline_profile_level\":1,\"parallel_fragment_exec_instance_num\":2,\"max_scan_key_num\":-1,\"net_read_timeout\":60,\"streaming_preaggregation_mode\":\"auto\",\"hive_partition_stats_sample_size\":3000,\"enable_mv_planner\":false,\"enable_collect_table_level_scan_stats\":true,\"enable_fine_grained_range_predicate\":false,\"enable_populate_datacache\":true,\"enable_connector_sink_writer_scaling\":true,\"query_debug_options\":\"\",\"profile_timeout\":2,\"cbo_push_down_aggregate\":\"global\",\"spill_encode_level\":7,\"enable_query_dump\":false,\"max_spill_read_buffer_bytes_per_driver\":16777216,\"global_runtime_filter_build_max_size\":67108864,\"cbo_push_down_groupingset_reshuffle\":true,\"enable_rewrite_sum_by_associative_rule\":true,\"query_cache_hot_partition_num\":3,\"enable_prune_complex_types\":true,\"enable_delta_lake_column_statistics\":false,\"metadata_collect_query_timeout\":60,\"query_cache_type\":0,\"max_parallel_scan_instance_num\":-1,\"enable_dynamic_prune_scan_range\":true,\"query_cache_entry_max_rows\":409600,\"enable_paimon_column_statistics\":false,\"connector_io_tasks_per_scan_operator\":4,\"disable_spill_to_local_disk\":false,\"enable_materialized_view_union_rewrite\":true,\"sql_quote_show_create\":true,\"enable_constant_execute_in_fe\":true,\"scan_or_to_union_threshold\":50000000,\"enable_materialized_view_rewrite_partition_compensate\":true,\"enable_exchange_pass_through\":true,\"runtime_profile_report_interval\":10,\"automv_use_bitmap_count_distinct\":true,\"query_cache_entry_max_bytes\":4194304,\"enable_partition_column_value_only_optimization\":true,\"scan_olap_partition_num_limit\":0,\"connector_max_split_size\":67108864,\"array_low_cardinality_optimize\":true,\"interleaving_group_size\":10,\"automv_sampling_ratio_low_bound\":0.01,\"enable_exchange_perf\":false,\"enable_prepare_stmt\":true,\"workgroup_id\":0,\"enable_pipeline_level_multi_partitioned_rf\":false,\"enable_rewrite_groupingsets_to_union_all\":false,\"spill_enable_direct_io\":false,\"cbo_push_down_groupingset\":true,\"custom_query_id\":\"\",\"transmission_compression_type\":\"NO_COMPRESSION\",\"interactive_timeout\":3600,\"use_page_cache\":true,\"automv_push_down_agg_below_semi_anti_join\":false,\"big_query_log_scan_bytes_threshold\":10737418240,\"collation_server\":\"utf8_general_ci\",\"cbo_decimal_cast_string_strict\":true,\"enable_hyperscan_vec\":true,\"count_distinct_implementation\":\"default\",\"enable_datacache_async_populate_mode\":false,\"cbo_enable_predicate_subfield_path\":true,\"tablet_internal_parallel_mode\":\"auto\",\"enable_pipeline\":true,\"spill_mode\":\"auto\",\"allow_hive_without_partition_filter\":true,\"cbo_prune_json_subfield_depth\":20,\"enable_lambda_pushdown\":true,\"enable_query_debug_trace\":false,\"like_predicate_consolidate_min\":2,\"cbo_materialized_view_rewrite_related_mvs_limit\":64,\"enable_lake_tablet_internal_parallel\":false,\"enable_show_all_variables\":true,\"hdfs_backend_selector_force_rebalance\":false,\"full_sort_max_buffered_bytes\":16777216,\"catalog\":\"default_catalog\",\"wait_timeout\":28800,\"automv_partial_rollup_min_agg_pieces\":3,\"max_buckets_per_be_to_use_balancer_assignment\":6,\"enable_query_tablet_affinity\":false,\"transmission_encode_level\":7,\"query_including_mv_names\":\"\",\"transaction_isolation\":\"REPEATABLE-READ\",\"automv_use_array_agg_count_distinct\":false,\"enable_global_runtime_filter\":true,\"enable_load_profile\":false,\"enable_rewrite_simple_agg_to_hdfs_scan\":false,\"enable_plan_validation\":true,\"load_transmission_compression_type\":\"NO_COMPRESSION\",\"global_runtime_filter_rpc_http_min_size\":67108864,\"cbo_materialized_view_rewrite_rule_output_limit\":3,\"cbo_enable_low_cardinality_optimize\":false,\"scan_use_query_mem_ratio\":0.3,\"datacache_evict_probability\":100,\"enable_analyze_phase_prune_columns\":false,\"connector_huge_file_size\":536870912,\"new_planner_optimize_timeout\":60000,\"enable_outer_join_reorder\":true,\"force_schedule_local\":false,\"hudi_mor_force_jni_reader\":false,\"enable_agg_spill_preaggregation\":true,\"cbo_enable_greedy_join_reorder\":true,\"range_pruner_max_predicate\":100,\"enable_rbo_table_prune\":false,\"spillable_operator_mask\":-1,\"enable_wait_dependent_event\":false,\"rpc_http_min_size\":2147482624,\"low_cardinality_optimize_v2\":true,\"enable_file_metacache\":false,\"cbo_debug_alive_backend_number\":0,\"global_runtime_filter_probe_min_size\":102400,\"topn_filter_back_pressure_mode\":0,\"scan_or_to_union_limit\":1,\"automv_default_partition_by_time_granule\":\"day\",\"enable_cbo_table_prune\":false,\"enable_parallel_merge\":true,\"cbo_materialized_view_rewrite_candidate_limit\":12,\"skew_join_use_mcv_count\":5,\"skip_page_cache\":false,\"cbo_derive_join_is_null_predicate\":true,\"nested_mv_rewrite_max_level\":3,\"enable_materialized_view_text_match_rewrite\":true,\"big_query_profile_threshold\":\"0s\",\"net_write_timeout\":60,\"cbo_prune_shuffle_column_rate\":0.1,\"spill_revocable_max_bytes\":0,\"hash_join_push_down_right_table\":true,\"connector_sink_target_max_file_size\":1073741824,\"max_ukfk_join_reorder_scale_ratio\":100,\"pipeline_sink_dop\":0,\"automv_relative_error_bound\":0.05,\"broadcast_row_limit\":15000000,\"enable_prune_iceberg_manifest\":true,\"exec_mem_limit\":42949672960,\"enable_sort_aggregate\":false,\"query_cache_force_populate\":false,\"computation_fragment_scheduling_policy\":\"COMPUTE_NODES_ONLY\",\"runtime_filter_on_exchange_node\":false,\"disable_join_reorder\":false,\"enable_evaluate_schema_scan_rule\":true,\"global_runtime_filter_rpc_timeout\":400,\"connector_scan_use_query_mem_ratio\":0.3,\"net_buffer_length\":16384,\"cbo_prune_subfield\":true,\"full_sort_max_buffered_rows\":1024000,\"automv_use_cardinality_estimation\":true,\"query_timeout\":1800,\"connector_io_tasks_slow_io_latency_ms\":50,\"cbo_max_reorder_node\":50,\"automv_sampling_timeout\":300000,\"enable_distinct_column_bucketization\":false,\"enable_big_query_log\":true,\"enable_spill_buffer_read\":true,\"group_execution_min_scan_rows\":5000000,\"runtime_filter_scan_wait_time\":20,\"enable_count_distinct_rewrite_by_hll_bitmap\":true,\"enable_sync_materialized_view_rewrite\":true,\"prefer_compute_node\":false,\"enable_strict_type\":false,\"automv_enable_complex_derived_dimensions\":true,\"enable_table_prune_on_update\":false,\"group_concat_max_len\":65535,\"enable_stats_to_optimize_skew_join\":false,\"parse_tokens_limit\":3500000,\"chunk_size\":4096,\"global_runtime_filter_probe_min_selectivity\":0.5,\"query_mem_limit\":42949672960,\"enable_filter_unused_columns_in_scan_stage\":false,\"enable_materialized_view_single_table_view_delta_rewrite\":false,\"cbo_prune_json_subfield\":false,\"enable_spill_to_remote_storage\":false,\"enable_materialized_view_transparent_union_rewrite\":true,\"enable_prune_complex_types_in_unnest\":true,\"automv_max_calculate_steps\":2147483647,\"auto_increment_increment\":1,\"sql_dialect\":\"StarRocks\",\"automv_use_hll_count_distinct\":false,\"enable_per_bucket_optimize\":true,\"automv_enable_complex_derived_metrics\":false,\"enable_eliminate_agg\":true,\"enable_group_execution\":true,\"big_query_log_scan_rows_threshold\":1000000000,\"character_set_client\":\"utf8\",\"autocommit\":true,\"enable_column_expr_predicate\":true,\"enable_partition_bucket_optimize\":false,\"skip_local_disk_cache\":false,\"max_ukfk_join_reorder_fk_rows\":100000000,\"enable_subfield_no_copy\":true,\"jit_level\":1,\"enable_runtime_adaptive_dop\":false,\"cbo_cte_max_limit\":10,\"connector_sink_compression_codec\":\"uncompressed\",\"automv_min_sampling_rows\":1073741824,\"storage_engine\":\"olap\",\"enable_rewrite_unnest_bitmap_to_array\":true,\"spill_operator_min_bytes\":10485760,\"cbo_enable_dp_join_reorder\":true,\"tx_visible_wait_timeout\":300,\"materialized_view_join_same_table_permutation_limit\":5,\"enable_materialized_view_view_delta_rewrite\":true,\"cbo_max_reorder_node_use_exhaustive\":4,\"enable_sql_digest\":false,\"spill_mem_table_num\":2,\"enable_spill\":false,\"enable_materialized_view_rewrite_greedy_mode\":false,\"pipeline_dop\":4,\"single_node_exec_plan\":false,\"full_sort_late_materialization_v2\":false,\"automv_max_order_by_columns\":3,\"join_implementation_mode_v2\":\"auto\",\"enable_connector_split_io_tasks\":true,\"sql_select_limit\":9223372036854775807,\"enable_materialized_view_rewrite\":true,\"materialized_view_subuqery_text_match_max_count\":4,\"statistic_collect_parallel\":1,\"hdfs_backend_selector_hash_algorithm\":\"consistent\",\"enable_expr_prune_partition\":true,\"plan_mode\":\"auto\",\"enable_topn_runtime_filter\":true,\"disable_colocate_join\":false,\"max_pushdown_conditions_per_column\":-1,\"back_pressure_back_rounds\":3,\"default_table_compression\":\"lz4_frame\",\"automv_enable_view_inline\":true,\"runtime_adaptive_dop_max_output_amplification_factor\":0,\"skew_join_rand_range\":1000,\"choose_execute_instances_mode\":\"LOCALITY\",\"back_pressure_throttle_time_upper_bound\":300,\"skew_join_data_skew_threshold\":0.2,\"innodb_read_only\":true,\"spill_mem_limit_threshold\":0.5,\"cbo_reorder_threshold_use_exhaustive\":6,\"disable_generated_column_rewrite\":false,\"automv_card_rowcount_ratio_hwm_v2\":0.5,\"enable_predicate_reorder\":false,\"enable_connector_sink_spill\":true,\"enable_query_cache\":false,\"enable_phased_scheduler\":false,\"group_execution_group_scale\":64,\"transaction_read_only\":false,\"max_allowed_packet\":1048576,\"enable_partition_level_cardinality_estimation\":true,\"enable_materialized_view_multi_stages_rewrite\":true,\"enable_parallel_prepare_metadata\":false,\"enable_cloud_native_persistent_index_by_default\":false,\"time_zone\":\"Asia/Shanghai\",\"enable_multicolumn_global_runtime_filter\":false,\"character_set_server\":\"utf8\",\"cbo_use_nth_exec_plan\":0,\"io_tasks_per_scan_operator\":16,\"parallel_exchange_instance_num\":-1,\"enable_shared_scan\":false,\"join_late_materialization\":false,\"audit_execute_stmt\":false,\"cbo_derive_range_join_predicate\":false,\"allow_default_partition\":false,\"cbo_use_histogram_evaluate_list_partition\":false,\"paimon_force_jni_reader\":false,\"enable_pipeline_level_shuffle\":true}",
  "be_number": 20,
  "be_core_stat": {
    "numOfHardwareCoresPerBe": "{\"311686291\":64,\"311686290\":64,\"311686289\":64,\"7643094\":64,\"311686288\":64,\"311686292\":64,\"66938448\":64,\"11395868\":64,\"66938447\":64,\"66938446\":64,\"11395865\":64,\"11395864\":64,\"11395866\":64,\"311686282\":64,\"11395863\":64,\"311686281\":64,\"11395862\":64,\"311686287\":64,\"311686285\":64,\"311686284\":64}",
    "cachedAvgNumOfHardwareCores": -1
  },
  "version": "3.3.16-ee",
  "commit_version": "ce75919"
}