// Copyright 2021-present StarRocks, Inc. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package com.starrocks.sql.ast;

import com.google.common.collect.Maps;
import com.starrocks.sql.parser.NodePosition;

import java.util.Map;

// Alter view statement
public class AlterViewStmt extends DdlStmt {
    private TableRef tableRef;
    private final boolean security;
    private final AlterDialectType alterDialect;
    private final Map<String, String> properties;
    private final AlterViewClause alterClause;

    public enum AlterDialectType {
        NONE,
        ADD,
        MODIFY
    }

    public AlterViewStmt(TableRef tableRef, boolean security, AlterDialectType alterDialect, Map<String, String> properties,
                         AlterViewClause alterClause, NodePosition pos) {
        super(pos);
        this.tableRef = tableRef;
        this.security = security;
        this.alterDialect = alterDialect;
        this.properties = properties;
        this.alterClause = alterClause;
    }

    public static AlterViewStmt fromReplaceStmt(CreateViewStmt stmt) {
        AlterViewClause alterViewClause = new AlterViewClause(
                stmt.getColWithComments(), stmt.getQueryStatement(), NodePosition.ZERO);
        alterViewClause.setInlineViewDef(stmt.getInlineViewDef());
        alterViewClause.setOriginalViewDefineSql(stmt.getOriginalViewDefineSql());
        alterViewClause.setColumns(stmt.getColumns());
        alterViewClause.setComment(stmt.getComment());
        return new AlterViewStmt(stmt.getTableRef(), stmt.isSecurity(), AlterDialectType.NONE, Maps.newHashMap(),
                alterViewClause, NodePosition.ZERO);
    }

    public TableRef getTableRef() {
        return tableRef;
    }

    public void setTableRef(TableRef tableRef) {
        this.tableRef = tableRef;
    }

    public String getCatalog() {
        return tableRef == null ? null : tableRef.getCatalogName();
    }

    public String getDbName() {
        return tableRef == null ? null : tableRef.getDbName();
    }

    public String getTable() {
        return tableRef == null ? null : tableRef.getTableName();
    }

    public boolean isSecurity() {
        return security;
    }

    public boolean isAlterDialect() {
        return alterDialect == AlterDialectType.ADD || alterDialect == AlterDialectType.MODIFY;
    }

    public AlterDialectType getAlterDialectType() {
        return alterDialect;
    }

    public Map<String, String> getProperties() {
        return properties;
    }

    public AlterViewClause getAlterClause() {
        return alterClause;
    }

    public String getOriginalViewDefineSql() {
        return alterClause == null ? null : alterClause.getOriginalViewDefineSql();
    }

    public void setOriginalViewDefineSql(String originalViewDefineSql) {
        if (alterClause != null) {
            alterClause.setOriginalViewDefineSql(originalViewDefineSql);
        }
    }

    @Override
    public <R, C> R accept(AstVisitor<R, C> visitor, C context) {
        return ((AstVisitorExtendInterface<R, C>) visitor).visitAlterViewStatement(this, context);
    }
}
