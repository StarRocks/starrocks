name: Translation Status Check
on:
  pull_request:
    paths: ['docs/en/**', 'docs/zh/**', 'docs/ja/**']
jobs:





  check-team-membership:
    name: Check Team Membership
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    outputs:
      is-team-member: ${{ steps.check.outputs.is-member }}
    steps:
      - name: Check if author is team member
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MEMBERSHIP_TOKEN || github.token }}
          script: |
            // If MEMBERSHIP_TOKEN is not available (e.g., from a fork), treat as non-member
            const token = '${{ secrets.MEMBERSHIP_TOKEN }}';
            if (!token || token === '') {
              console.log(`Running from fork - treating ${context.payload.pull_request.user.login} as non-member`);
              core.setOutput('is-member', 'false');
              return;
            }

            try {
              const { data: membership } = await github.rest.teams.getMembershipForUserInOrg({
                org: 'starrocks',
                team_slug: 'docs-maintainer',
                username: context.payload.pull_request.user.login
              });
              console.log(`User ${context.payload.pull_request.user.login} is a member of @starrocks/docs-maintainer`);
              core.setOutput('is-member', 'true');
            } catch (error) {
              if (error.status === 404) {
                console.log(`User ${context.payload.pull_request.user.login} is NOT a member of @starrocks/docs-maintainer`);
                core.setOutput('is-member', 'false');
              } else {
                throw error;
              }
            }

  report:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('is_fork', pr.head.repo.fork);
            core.setOutput('head_ref', pr.head.ref);

      - name: Check Team Membership
        if: ${{ github.event.pull_request.head.repo.full_name == 'StarRocks/starrocks' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MEMBERSHIP_TOKEN || github.token }}
          script: |
            const user = context.payload.pull_request.user.login;
            const org = 'StarRocks';
            const team = 'docs-maintainer';

            try {
              console.log(`Checking membership for ${user} in ${org}/${team}...`);
              
              const response = await github.rest.teams.getMembershipForUserInOrg({
                org: org,
                team_slug: team,
                username: user,
              });

              if (response.data.state === 'active') {
                console.log(`‚úÖ User ${user} is an active member of ${team}.`);
              } else {
                core.setFailed(`‚ùå User ${user} is in ${team} but their membership is ${response.data.state}.`);
              }

            } catch (error) {
              if (error.status === 404) {
                core.setFailed(`‚ùå User ${user} not found in team ${org}/${team}. Please ensure your membership is public or the token has org-read access.`);
              } else if (error.status === 403) {
                core.setFailed(`‚ùå Permission Denied (403). The MEMBERSHIP_TOKEN does not have 'members: read' permission or Org settings restrict access.`);
              } else {
                core.setFailed(`‚ùå Unexpected error (Status ${error.status}): ${error.message}`);
              }
            }


      - uses: actions/checkout@v4
      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            docs/en/**/*.md*
            docs/zh/**/*.md*
            docs/ja/**/*.md*
      - name: Post/Update Status Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "### üåé Translation Required?"
          body: |
            ### üåé Translation Required?
            The following files were modified. Check the languages you want to generate:
            - [ ] **Japanese (ja)**
            - [ ] **Chinese (zh)**
            - [ ] **English (en)**

            **Files detected:**
            ${{ steps.changed-files.outputs.all_changed_files }}

            ---
            *Doc Maintainers: Check boxes and reply with `/translate` to start.*
          edit-mode: replace

