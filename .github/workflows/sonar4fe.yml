name: FE Build
on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - 'conf/**.java'
      
#  pull_request:
#    types: [opened, synchronize, reopened]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: 'adopt'
          
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
          
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-
          
      - name: Setup thrift
        uses: dodopizza/setup-thrift@v1
        with:
          version: 0.13.0

#      - name: Install thrift
#        run: |
#          sudo apt-get install libboost-dev libboost-test-dev libboost-program-options-dev libevent-dev automake libtool flex bison pkg-config g++ libssl-dev libslf4j-java
#          wget http://archive.apache.org/dist/thrift/0.13.0/thrift-0.13.0.tar.gz
#          tar -xvzf thrift-0.13.0.tar.gz 
#          cd thrift-0.13.0
#          sudo ./configure
#          sudo make -j 2
#          sudo make install
#          thrift -version
#      - name: Analyze with SonarCloud
#        uses: sonarsource/sonarcloud-github-action@master
#        with:
#         projectBaseDir: my-custom-directory
#         args: >
#           -Dsonar.projectKey=dulong41_starrocks
#           -Dsonar.sources=fe/
#      -Dsonar.organization=my-organization    
 #     -Dsonar.python.coverage.reportPaths=coverage.xml 
#      -Dsonar.test.exclusions=tests/**
#      -Dsonar.tests=tests/
#      -Dsonar.verbose=true
#      - name: SonarCloud Scan
#        uses: sonarsource/sonarcloud-github-action@master
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        with:
#          args:  >
#            -Dsonar.projectKey=dulong41_starrocks
#            -Dsonar.organization=dulong41
#            -Dsonar.sources=bin
          
#      - name: Get specific changed files
#        id: changed-files-specific
#        uses: tj-actions/changed-files@v23.1
#        with:
#          files: |
#            conf/**

#      - name: List all changed files
#        run: |
#          for file in ${{ steps.changed-files.outputs.files_changed }}; do
#            echo "$file was changed"
#          done
          
      - name: Build and analyze
#        if: steps.changed-files-specific.outputs.files_changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
          SONAR_TOKEN: 23d4ba0aa0f8c547f3db2c329c96546e2e280468 # ${{ secrets.SONAR_TOKEN }}
        run: |
          #docker run --privileged -v "/home/runner"/.m2:/root/.m2 -v ${{ github.workspace }}:/root/starrocks -v /etc/timezone:/etc/timezone:ro -v /etc/localtime:/etc/localtime:ro --name temp -d starrocks/dev-env:${GITHUB_REF_NAME} /bin/bash -c "while true;do echo hello;sleep 1;done"
          #sleep 10 && echo "initialize docker container-----"
          #docker exec --privileged temp /bin/bash -c "cd /root/starrocks; ./build.sh --clean --fe;"
          #echo "script run over-----"
          cd fe
          mvn -B clean -DskipTests verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar  -Dsonar.projectKey=dulong41_starrocks -Dsonar.pullrequest.key=${{ github.event.number }} -Dsonar.pullrequest.base=${{ github.base_ref }} -Dsonar.pullrequest.branch=${{ github.head_ref }} 
          #-Dsonar.host.url=https://sonarcloud.io -Dsonar.organization=dulong41 -Dsonar.pullrequest.provider=GitHub -Dsonar.pullrequest.github.repository=dulong41/starrocks
