name: CI COMMENT TOOLS

on:
  issue_comment:
    types: [ created ]

jobs:

  close:
    name: CLOSE PR
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.pull_request.html_url, 'pull') &&
      (contains(github.event.comment.body, '@Mergify close') ||
      contains(github.event.comment.body, '@Mergifyio close'))

    env:
      PR_NUMBER: ${{ github.event.issue.number }}
      GITHUB_TOKEN: ${{ secrets.PAT }}

    steps:
      - name: CLOSE
        run: |
          gh pr close ${PR_NUMBER} -R ${{ github.repository }} -c "PR was manually closed."

  automerge:
    name: AutoMerge PR
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.pull_request.html_url, 'pull') &&
      contains(github.event.comment.body, '@Mergify automerge')

    env:
      PR_NUMBER: ${{ github.event.issue.number }}

    steps:
      - name: BASE REF
        id: get_base_ref
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          base_ref=$(gh pr view ${PR_NUMBER} -R ${{ github.repository }} --json baseRefName | jq -r '.baseRefName')
          echo "base_ref=${base_ref}" >> $GITHUB_OUTPUT

      - name: AutoMerge
        if: startsWith(steps.get_base_ref.outputs.base_ref, 'mergify/bp')
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          gh pr merge ${PR_NUMBER} -R ${{ github.repository }} -s --auto

  rerun:
    name: Rerun
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.pull_request.html_url, 'pull') &&
      contains(github.event.comment.body, 'Re-run the workflow')
    env:
      PR_NUMBER: ${{ github.event.issue.number }}
      GITHUB_TOKEN: ${{ secrets.PAT }}
      ROBOT_SERVER: ${{ secrets.ROBOT_URL }}

    steps:
      - name: CLOSE
        run: |
          ret=$(curl -sX POST -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\", \"pr_id\":\"${PR_NUMBER}\"}" ${ROBOT_SERVER})
          ret_code=$(echo "${ret}" | jq -r '.result')
          if [[ '${ret_code}' == "false" ]]; then
            echo "Re-run failed!"
            exit 1
          fi

  docgen-trigger:
    name: Trigger Documentation Generation
    runs-on: ubuntu-latest
    if: >
      contains(github.event.issue.pull_request.html_url, 'pull') &&
      contains(github.event.comment.body, 'docgen')
    
    env:
      PR_NUMBER: ${{ github.event.issue.number }}
      GITHUB_TOKEN: ${{ secrets.PAT }}
      REPO: ${{ github.repository }}

    steps:
      - name: Check if label already exists
        id: check_label
        run: |
          labels=$(gh pr view ${PR_NUMBER} -R ${REPO} --json labels -q '.labels[].name')
          if echo "${labels}" | grep -q "^docgen$"; then
            echo "label_exists=true" >> $GITHUB_OUTPUT
            echo "Label 'docgen' already exists on this PR"
          else
            echo "label_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Add docgen label
        if: steps.check_label.outputs.label_exists != 'true'
        run: |
          gh pr edit ${PR_NUMBER} -R ${REPO} --add-label "docgen"
          echo "Added 'docgen' label to PR #${PR_NUMBER}"

      - name: Get PR info
        id: pr_info
        run: |
          PR_TITLE=$(gh pr view ${PR_NUMBER} -R ${REPO} --json title -q '.title')
          PR_AUTHOR=$(gh pr view ${PR_NUMBER} -R ${REPO} --json author -q '.author.login')
          echo "title=${PR_TITLE}" >> $GITHUB_OUTPUT
          echo "author=${PR_AUTHOR}" >> $GITHUB_OUTPUT

      - name: Comment trigger status
        run: |
          comment="## üöÄ Documentation Generation Triggered

          **PR Information:**
          - Title: ${{ steps.pr_info.outputs.title }}
          - Author: @${{ steps.pr_info.outputs.author }}
          - PR Number: #${PR_NUMBER}

          The documentation generation process has been triggered. 
          
          **Track Progress:**
          - Check the [CI Pipeline Actions](${{ github.server_url }}/${REPO}/actions/workflows/ci-pipeline.yml)
          - Look for the **Generate Documentation** job
          
          ---
          üí° **Tip:** The \`docgen\` label will be automatically removed after the process completes."
          
          gh pr comment ${PR_NUMBER} -R ${REPO} -b "${comment}"

      - name: Handle label already exists
        if: steps.check_label.outputs.label_exists == 'true'
        run: |
          comment="## ‚ÑπÔ∏è Documentation Generation Already in Progress

          The \`docgen\` label is already present on this PR, which means:
          - Documentation generation is currently running, or
          - A previous generation is still in progress
          
          **To check status:**
          - View the [CI Pipeline](${{ github.server_url }}/${REPO}/actions/workflows/ci-pipeline.yml)
          - Look for the **Generate Documentation** job
          
          **To restart documentation generation:**
          1. Remove the \`docgen\` label manually
          2. Comment \`docgen\` again to trigger a new generation
          
          ---
          *If you believe this is an error, please contact the maintainers.*"
          
          gh pr comment ${PR_NUMBER} -R ${REPO} -b "${comment}"
