name: Translation Runner
on:
  issue_comment:
    types: [created]
jobs:
  execute:
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Required to push the translations
      pull-requests: write # Required to read/post comments

    steps:
      - name: Check Team Membership
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_READ_TOKEN }}
          script: |
            const user = context.payload.comment.user.login;
            const org = 'StarRocks';
            const team = 'docs-maintainer';

            try {
              console.log(`Checking membership for ${user} in ${org}/${team}...`);
              
              const response = await github.rest.teams.getMembershipForUserInOrg({
                org: org,
                team_slug: team,
                username: user,
              });

              if (response.data.state === 'active') {
                console.log(`âœ… User ${user} is an active member of ${team}.`);
              } else {
                core.setFailed(`âŒ User ${user} is in ${team} but their membership is ${response.data.state}.`);
              }

            } catch (error) {
              if (error.status === 404) {
                core.setFailed(`âŒ User ${user} not found in team ${org}/${team}. Please ensure your membership is public or the token has org-read access.`);
              } else if (error.status === 403) {
                core.setFailed(`âŒ Permission Denied (403). The GITHUB_TOKEN does not have 'members: read' permission or Org settings restrict access.`);
              } else {
                core.setFailed(`âŒ Unexpected error (Status ${error.status}): ${error.message}`);
              }
            }

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Get Checkbox State
        id: get_checks
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
            });
            const report = comments.find(c => c.body.includes('### ðŸŒŽ Translation Required?'));
            return report ? report.body : '';

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Run Translations
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BODY: ${{ steps.get_checks.outputs.result }}
          FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          pip install -U google-genai==0.3.0 pyyaml==6.0.2
          # Use double quotes around "$FILES" to prevent word-splitting
          if [[ "$BODY" == *" [x] **Japanese (ja)**"* ]]; then python docs/translation/translate.py -l ja --files "$FILES"; fi
          if [[ "$BODY" == *" [x] **Chinese (zh)**"* ]]; then python docs/translation/translate.py -l zh --files "$FILES"; fi
          if [[ "$BODY" == *" [x] **English (en)**"* ]]; then python docs/translation/translate.py -l en --files "$FILES"; fi

      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('is_fork', pr.head.repo.fork);
            core.setOutput('head_ref', pr.head.ref);

      - name: Commit and Push
        # Only runs if this is a branch of our repo
        if: steps.pr_info.outputs.is_fork == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/
            git commit -m "docs: automated translation via Gemini [skip ci]"
            git push origin HEAD:refs/heads/${{ steps.pr_info.outputs.head_ref }}
          fi

      - name: Add maintainer instruction comment
        # Only runs if this is a fork of our repo
        if: steps.pr_info.outputs.is_fork == 'true'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: "Doc Maintainers: Please generate the translations locally and add them to this PR"

