---
displayed_sidebar: docs
sidebar_position: 40
---

# 集計テーブル

テーブル作成時に、集計キーを定義し、値カラムに対して集計関数を指定できます。複数のデータ行が同じ集計キーを持つ場合、値カラムの値が集計されます。さらに、ソートキーを別に定義することもできます。クエリのフィルター条件にソートキーが含まれている場合、StarRocks はデータを迅速にフィルタリングし、クエリ効率を向上させます。

データ分析および集計のシナリオでは、集計テーブルは処理する必要のあるデータ量を削減し、クエリ効率を向上させます。

## シナリオ

集計テーブルは、データ統計および分析のシナリオに適しています。以下はいくつかの例です。

- ウェブサイトやアプリのプロバイダーが、特定のウェブサイトやアプリに対するユーザーのトラフィック量や滞在時間、訪問回数を分析するのを支援します。

- 広告代理店が、顧客に提供する広告の総クリック数、総表示数、および消費統計を分析するのを支援します。

- e コマース企業が、年間取引データを分析し、四半期または月ごとの地域別ベストセラーを特定するのを支援します。

前述のシナリオにおけるデータクエリと取り込みには、以下の特徴があります。

- ほとんどのクエリは、SUM、MAX、MIN などの集計クエリです。
- 生の詳細データを取得する必要はありません。
- 履歴データは頻繁に更新されません。新しいデータのみが追加されます。

## 原理

データ取り込みからデータクエリまでの過程で、集計テーブル内のデータは以下のように複数回集計されます。

1. データ取り込みフェーズでは、データがバッチで集計テーブルにロードされるときに、各バッチのデータがバージョンを形成します。1 つのバージョン内で、同じ集計キーを持つデータが集計されます。

2. バックグラウンドの Compaction フェーズでは、データ取り込みで生成された複数のデータバージョンのファイルが定期的に大きなファイルに圧縮されるとき、StarRocks は大きなファイル内で同じ集計キーを持つデータを集計します。

3. データクエリフェーズでは、StarRocks はクエリ結果を返す前に、すべてのデータバージョン間で同じ集計キーを持つデータを集計します。

集計操作は、処理する必要のあるデータ量を削減し、クエリを高速化するのに役立ちます。

集計テーブルを使用するテーブルがあり、次の 4 つの生データをテーブルにロードしたいとします。

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 1    |
| 2020.05.01 | CHN     | 2    |
| 2020.05.01 | USA     | 3    |
| 2020.05.01 | USA     | 4    |

StarRocks はデータ取り込み時に、これらの 4 つの生データを次の 2 つのデータに集計します。

| Date       | Country | PV   |
| ---------- | ------- | ---- |
| 2020.05.01 | CHN     | 3    |
| 2020.05.01 | USA     | 7    |

## テーブルの作成

異なる都市からのユーザーが異なるウェブページを訪問した回数を分析したいとします。この例では、`example_db.aggregate_tbl` という名前のテーブルを作成し、`site_id`、`date`、`city_code` を集計キーとして定義し、`pv` を値カラムとして定義し、`pv` カラムに対して SUM 関数を指定します。

テーブルを作成するためのステートメントは次のとおりです。

```SQL
CREATE TABLE aggregate_tbl (
    site_id LARGEINT NOT NULL COMMENT "id of site",
    date DATE NOT NULL COMMENT "time of event",
    city_code VARCHAR(20) COMMENT "city_code of user",
    pv BIGINT SUM DEFAULT "0" COMMENT "total page views"
)
AGGREGATE KEY(site_id, date, city_code)
DISTRIBUTED BY HASH(site_id);
```

> **注意**
>
> - テーブルを作成する際には、`DISTRIBUTED BY HASH` 句を使用してバケット化カラムを指定する必要があります。詳細については、[バケット化](../data_distribution/Data_distribution.md#bucketing) を参照してください。
> - バージョン 2.5.7 以降、StarRocks はテーブルを作成する際やパーティションを追加する際に、バケット数 (BUCKETS) を自動的に設定できます。バケット数を手動で設定する必要はありません。詳細については、[バケット数の設定](../data_distribution/Data_distribution.md#set-the-number-of-buckets) を参照してください。

## 使用上の注意

- **集計キー**:
  - CREATE TABLE ステートメントでは、集計キーは他のカラムの前に定義する必要があります。
  - 集計キーは `AGGREGATE KEY` を使用して明示的に定義できます。`AGGREGATE KEY` には値カラムを除くすべてのカラムを含める必要があります。そうでない場合、テーブルの作成に失敗します。

    集計キーが `AGGREGATE KEY` を使用して明示的に定義されていない場合、デフォルトで値カラムを除くすべてのカラムが集計キーと見なされます。
  - 集計キーには一意性制約があります。

- **値カラム**: カラム名の後に集計関数を指定して、カラムを値カラムとして定義します。このカラムは一般的に集計が必要なデータを保持します。

- **集計関数**: 値カラムに使用される集計関数。集計テーブルでサポートされている集計関数については、[CREATE TABLE](../../sql-reference/sql-statements/table_bucket_part_index/CREATE_TABLE.md) を参照してください。

- **ソートキー**

  - バージョン 3.3.0 以降、集計テーブルでソートキーは集計キーから分離されました。集計テーブルは `ORDER BY` を使用してソートキーを指定し、`AGGREGATE KEY` を使用して集計キーを指定することをサポートしています。ソートキーと集計キーのカラムは同じである必要がありますが、カラムの順序は同じである必要はありません。

  - クエリが実行されると、ソートキーのカラムは複数のデータバージョンの集計前にフィルタリングされ、値カラムは複数のデータバージョンの集計後にフィルタリングされます。したがって、フィルター条件として頻繁に使用されるカラムを特定し、これらのカラムをソートキーとして定義することをお勧めします。これにより、複数のデータバージョンの集計前にデータフィルタリングを開始でき、クエリパフォーマンスを向上させることができます。

- テーブルを作成する際には、テーブルのキーカラムに対してのみビットマップインデックスまたはブルームフィルターインデックスを作成できます。

## 次のステップ

テーブルが作成された後、さまざまなデータ取り込み方法を使用して StarRocks にデータをロードできます。StarRocks がサポートするデータ取り込み方法については、[ロードオプション](../../loading/Loading_intro.md) を参照してください。

> 注: 集計テーブルを使用するテーブルにデータをロードする際には、テーブルのすべてのカラムを更新する必要があります。たとえば、前述の `example_db.aggregate_tbl` テーブルを更新する場合、`site_id`、`date`、`city_code`、および `pv` のすべてのカラムを更新する必要があります。