---
displayed_sidebar: docs
---

# ADMIN REPAIR

## 説明

このステートメントは、指定されたテーブルまたはパーティションを修復しようとするために使用されます。

存算一体テーブル（shared-nothing tables）の場合、レプリカの修復を優先的にスケジュールしようとします。

存算分離テーブル（shared-data tables）の場合、メタデータやデータファイルが失われた際に、過去の利用可能なバージョンへのロールバックを試みます。（注意：一部のタブレットの最新データが失われる可能性があります。）

:::tip

この操作には、SYSTEM レベルの OPERATE 権限が必要です。[GRANT](../../account-management/GRANT.md) の指示に従って、この権限を付与することができます。

:::

## 構文

```sql
ADMIN REPAIR TABLE table_name [PARTITION (p1,...)] [PROPERTIES ("key" = "value", ...)]
```

注意:

1. このステートメントは、指定されたテーブルまたはパーティションのシャーディングレプリカを優先的に修復しようとすることを意味しますが、修復が成功する保証はありません。ユーザーは ADMIN SHOW REPLICA STATUS コマンドを通じて修復状況を確認できます。
2. デフォルトのタイムアウトは 14400 秒（4 時間）です。タイムアウトは、指定されたテーブルまたはパーティションのシャーディングレプリカを優先的に修復しないことを意味します。タイムアウトが発生した場合、意図した設定のために再度コマンドを使用する必要があります。
3. `PROPERTIES` を介した修復動作の設定をサポートします。現在、存算分離テーブル（shared-data tables）のみサポートされています。

**PROPERTIES**

`enforce_consistent_version`: パーティション内のすべてのタブレットを一致したバージョンにロールバックすることを強制するかどうか。デフォルトは `true` です。`true` に設定すると、システムはパーティション内の履歴バージョンの中から、すべてのタブレットに対して有効な統一バージョンを探し出し、ロールバックを実行します。これにより、パーティションデータのバージョンの整合性が保証されます。`false` に設定すると、パーティション内の各タブレットは、それぞれが見つけられる最新の有効なバージョンにロールバックすることが許可されます。異なるタブレット間でバージョンが一致しない可能性がありますが、データを最大限に保持することができます。
`allow_empty_tablet_recovery`: 空のタブレットを作成することによる回復を許可するかどうか。デフォルトは `false` です。`enforce_consistent_version` が `false` の場合にのみ有効です。一部のタブレットのすべてのバージョンのメタデータが欠落しているが、少なくとも1つのタブレットに有効なメタデータが存在する場合、このパラメータが `true` であれば、システムは欠落しているバージョンを埋めるために空のタブレットを作成しようとします。すべてのタブレットのすべてのバージョンのメタデータが失われた場合、回復は不可能です。

## 例

1. 指定されたテーブルを修復しようとする

    ```sql
    ADMIN REPAIR TABLE tbl1;
    ```

2. 指定されたパーティションを修復しようとする

    ```sql
    ADMIN REPAIR TABLE tbl1 PARTITION (p1, p2);
    ```

3. バージョンの不整合を許容し、回復のために空のタブレットを作成することを許可して、存算分離テーブル（shared-data table）を修復しようとする

    ```sql
    ADMIN REPAIR TABLE cloud_tbl PROPERTIES (
        "enforce_consistent_version" = "false",
        "allow_empty_tablet_recovery" = "true"
    );
    ```